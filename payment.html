<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shrinxa – Pay Now</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{ background:#f6f7fb; color:#111827; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }
    .card{ border:0; border-radius:18px; box-shadow:0 10px 30px rgba(17,24,39,.08); }
    .muted{ color:#6b7280; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; }
    .btn{ border-radius:12px; }
    .pill{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border:1px solid rgba(17,24,39,.12); border-radius:999px; font-size:.78rem; background:#fff; color:#334155; }
  </style>
</head>

<body>
  <main class="container py-4" style="max-width: 980px;">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <div>
        <h2 class="m-0" style="font-weight:800;">Pay Now</h2>
        <div class="muted">Secure checkout (Cards + Interac)</div>
      </div>
      <a class="btn btn-outline-secondary" href="./cart.html">Back to cart</a>
    </div>

    <div class="card p-3 mb-3">
      <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between">
        <div class="d-flex flex-column">
          <div class="muted">Invoice</div>
          <div class="mono fw-semibold" id="invNo">—</div>
        </div>
        <div class="d-flex flex-column text-end">
          <div class="muted">Status</div>
          <div class="fw-semibold" id="status">Loading…</div>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="d-flex flex-wrap gap-3 align-items-start justify-content-between">
        <div style="min-width: 280px;">
          <div class="fw-bold mb-1">Customer</div>
          <div id="custEmail" class="mono">—</div>
          <div id="custName" class="muted">—</div>
        </div>

        <div style="min-width: 320px;">
          <div class="fw-bold mb-1">Payment summary</div>
          <div class="d-flex justify-content-between"><span class="muted">Invoice total</span><span class="mono" id="invTotal">—</span></div>
          <div class="d-flex justify-content-between"><span class="muted">Processing fee (customer pays)</span><span class="mono" id="feeTotal">—</span></div>
          <hr class="my-2">
          <div class="d-flex justify-content-between fw-bold"><span>Total to pay</span><span class="mono" id="grandTotal">—</span></div>

          <div class="mt-2 muted" style="font-size:.9rem;">
            The processing fee is shown as a separate line item during checkout.
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex flex-wrap gap-2">
        <button id="payBtn" class="btn btn-primary" type="button" disabled>Pay Now</button>
       <a
  id="viewInvBtn"
  class="btn btn-outline-secondary"
  href="./invoice.html"
  target="_blank"
  rel="noopener noreferrer"
  style="pointer-events:none; opacity:.55;"
>
  View invoice
</a>
      </div>

      <div class="mt-3">
        <div id="err" class="alert alert-danger d-none"></div>
        <div id="ok" class="alert alert-success d-none"></div>
      </div>

      <div class="mt-2 muted" style="font-size:.9rem;">
        Note: Inventory is handled by your existing backend rules. This page does not modify stock.
      </div>
    </div>
  </main>

  <script type="module">
    import { supabase } from "./supabaseClient.js";

    // ====== CONFIG (do not guess fees in code elsewhere) ======
    // These are "customer-pays-fee" inputs.
    // Keep them here so you can adjust later without touching other logic.
    const FEE_RATE = 0.029;     // 2.9%
    const FEE_FIXED = 0.30;     // +$0.30
    const CURRENCY = "CAD";

    // The Edge Function we will create in the NEXT step.
    // It must create a Stripe Checkout Session for this invoice.
	const STRIPE_CHECKOUT_FUNCTION = "stripe-create-checkout";

    // ====== helpers ======
    const qs = new URLSearchParams(location.search);
    const invoiceNo = (qs.get("invoice_no") || "").trim();

    const invNoEl = document.getElementById("invNo");
    const statusEl = document.getElementById("status");
    const custEmailEl = document.getElementById("custEmail");
    const custNameEl = document.getElementById("custName");
    const invTotalEl = document.getElementById("invTotal");
    const feeTotalEl = document.getElementById("feeTotal");
    const grandTotalEl = document.getElementById("grandTotal");
    const payBtn = document.getElementById("payBtn");
    const viewInvBtn = document.getElementById("viewInvBtn");
    const errEl = document.getElementById("err");
    const okEl = document.getElementById("ok");

    function money(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return "—";
      return `${x.toFixed(2)} ${CURRENCY}`;
    }
    function showErr(msg){
      errEl.textContent = msg;
      errEl.classList.remove("d-none");
      okEl.classList.add("d-none");
    }
    function showOk(msg){
      okEl.textContent = msg;
      okEl.classList.remove("d-none");
      errEl.classList.add("d-none");
    }

    async function loadInvoice() {
      if (!invoiceNo) {
        statusEl.textContent = "Missing invoice_no";
        showErr("Missing invoice number. Please go back to cart and try again.");
        return null;
      }

      invNoEl.textContent = invoiceNo;

      // Find invoice by invoice_number OR number (your admin uses both sometimes)
      const { data, error } = await supabase
        .from("invoices")
       .select("id, invoice_number, bill_to_email, bill_to_name, status, payment_status, total, currency")
	.eq("invoice_number", invoiceNo)
        .limit(1);

      if (error) {
        statusEl.textContent = "Error";
        showErr(error.message || "Failed to load invoice.");
        return null;
      }

      const inv = (data && data[0]) ? data[0] : null;
      if (!inv) {
        statusEl.textContent = "Not found";
        showErr("Invoice not found.");
        return null;
      }

      const st = String(inv.payment_status || inv.status || "").toLowerCase();
      statusEl.textContent = st || "unpaid";

      custEmailEl.textContent = inv.bill_to_email || "—";
      custNameEl.textContent = inv.bill_to_name || "—";

     const baseTotal = Number(inv.total ?? 0) || 0;


      // Customer-pays Stripe fee approximation (cards pricing model).
      // Stripe Checkout will show the fee line item we add in the session (next step).
      const fee = Math.max(0, (baseTotal * FEE_RATE) + FEE_FIXED);
      const grand = baseTotal + fee;

      invTotalEl.textContent = money(baseTotal);
      feeTotalEl.textContent = money(fee);
      grandTotalEl.textContent = money(grand);

      // Wire "View invoice"
      viewInvBtn.href = `./invoice.html?id=${encodeURIComponent(inv.id)}`;
      viewInvBtn.style.pointerEvents = "auto";
      viewInvBtn.style.opacity = "1";

      // If already paid, disable Pay Now
      if (st === "paid") {
        payBtn.disabled = true;
        showOk("This invoice is already paid. You can view the paid invoice.");
      } else {
        payBtn.disabled = false;
      }

      return { inv, baseTotal, fee, grand };
    }

    payBtn.addEventListener("click", async () => {
      errEl.classList.add("d-none");
      okEl.classList.add("d-none");

      payBtn.disabled = true;
      payBtn.textContent = "Starting checkout…";

      try {
        const loaded = await loadInvoice();
        if (!loaded) throw new Error("Invoice not available.");

        const { inv, baseTotal, fee } = loaded;

        // Call Edge Function that creates Stripe Checkout Session (next step).
        const { data, error } = await supabase.functions.invoke(STRIPE_CHECKOUT_FUNCTION, {
          body: {
            invoice_id: inv.id,
            invoice_no: invoiceNo,
            currency: CURRENCY,
            // Send amounts so backend knows exactly what customer saw.
            // Backend must re-validate totals from DB (never trust frontend blindly).
            base_total: Number(baseTotal.toFixed(2)),
            processing_fee: Number(fee.toFixed(2)),
            success_url: `${location.origin}/invoice.html?id=${encodeURIComponent(inv.id)}&paid=1`,
            cancel_url: `${location.origin}/payment.html?invoice_no=${encodeURIComponent(invoiceNo)}`
          }
        });

        if (error) throw new Error(error.message || "Checkout creation failed.");
        if (!data?.url) throw new Error("Checkout URL missing from server response.");

        // Redirect to Stripe Checkout
        location.href = data.url;
      } catch (e) {
        showErr(e?.message || String(e));
        payBtn.disabled = false;
        payBtn.textContent = "Pay Now";
      }
    });

    // init
    await loadInvoice();
  </script>
<script src="/assets/analytics.js" defer></script>

</body>
</html>
