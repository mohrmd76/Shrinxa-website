<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shrinxa – Payment Successful</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="background:#f6f7fb;">
  <main class="container py-5" style="max-width:820px;">
    <div class="card p-4" style="border-radius:18px;">
      <h3 class="mb-2" style="font-weight:800;">Payment received ✅</h3>

      <p id="statusLine1" class="mb-1">We are preparing your paid invoice now.</p>
      <p id="statusLine2" class="text-muted mb-0">If you are not redirected automatically, check your email in a moment.</p>

      <div id="details" class="mt-3 small text-muted" style="display:none;"></div>
    </div>
  </main>

  <script>
    (async () => {
      const params = new URLSearchParams(window.location.search);
      const sid = params.get("sid");

      const line1 = document.getElementById("statusLine1");
      const line2 = document.getElementById("statusLine2");
      const details = document.getElementById("details");

      if (!sid) {
        line1.textContent = "Missing session id (sid).";
        line2.textContent = "Please contact support.";
        return;
      }

      const STATUS_FN = "https://fgrjojxwevllnjdixiyd.supabase.co/functions/v1/paynow-status";

      let tries = 0;
      const maxTries = 40;     // ~100 seconds
      const delayMs = 2500;

      const tick = async () => {
        tries++;

        try {
          const res = await fetch(STATUS_FN, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ stripe_session_id: sid }),
          });

          const text = await res.text();
          let data = null;
          try { data = JSON.parse(text); } catch { data = { raw: text }; }

          if (res.ok && data && data.invoice_id) {
            // Redirect to your public invoice page
            window.location.href = `/invoice.html?id=${data.invoice_id}`;
            return;
          }

          // Still processing
          if (tries < maxTries) {
            setTimeout(tick, delayMs);
            return;
          }

          // Timed out
          line1.textContent = "Payment received ✅";
          line2.textContent = "Your invoice is still processing. Please check your email shortly.";
          details.style.display = "block";
          details.textContent = "If you don't receive an email within a few minutes, contact support.";

        } catch (e) {
          if (tries < maxTries) {
            setTimeout(tick, delayMs);
            return;
          }
          line1.textContent = "Payment received ✅";
          line2.textContent = "Your invoice is still processing. Please check your email shortly.";
          details.style.display = "block";
          details.textContent = `Error: ${String(e)}`;
        }
      };

      tick();
    })();
  </script>
</body>
</html>
