<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shrinxa Admin – Delivery Rules</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .table-wrap{
      max-height: calc(100vh - 320px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
    }

    table{
      border-collapse:separate !important;
      border-spacing:0;
      width:100%;
      min-width: 780px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc !important;
      border-bottom:1px solid rgba(17,24,39,.08) !important;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }

    tbody tr:hover{ background:#fafafa; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .82rem; }
    .muted{ color:var(--muted); font-size:.875rem; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      font-size:.78rem;
      background:#fff;
      color:#334155;
    }

    .btn{ border-radius:12px; }

    h2{ margin:0; font-weight:800; letter-spacing:.2px; }
  </style>
</head>
<body>

<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html" class="active">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html">Income</a>
      <a href="./clients.html">Clients</a>
      <a href="./cash.html">Cash</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small opacity-75"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<main class="container-fluid px-4 py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <div class="page-title h3 m-0">Delivery Rules</div>
      <div class="muted">Control default delivery threshold/fee and customer-specific overrides.</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="pill"><span class="mono">public.delivery_rules</span></span>
      <span class="pill">Active rules only</span>
    </div>
  </div>

  <!-- Status messages -->
  <div id="statusArea" class="mb-3"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card p-3">
        <div class="statusbar mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="fw-bold">Default Rule</div>
            <span class="pill">customer_id = <span class="mono">NULL</span></span>
          </div>
          <div class="hint">Used by checkout when no customer override exists.</div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="defMin" class="form-label">Charge fee under ($)</label>
            <input id="defMin" type="number" class="form-control" min="0" step="1" />
          </div>

          <div class="col-12 col-md-6">
            <label for="defFee" class="form-label">Delivery fee ($)</label>
            <input id="defFee" type="number" class="form-control" min="0" step="1" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn btn-primary" id="saveDefault">Save</button>
          <button type="button" class="btn btn-outline-secondary" id="loadDefault">Reload</button>
        </div>

        <div class="mt-3 small muted">
          Tip: Checkout reads the <b>newest active</b> default rule.
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3">
        <div class="statusbar mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="fw-bold">Customer Override</div>
            <span class="pill">customer_id = <span class="mono">profiles.id</span></span>
          </div>
          <div class="hint">Overrides default for the selected customer.</div>
        </div>

        <div class="mb-3">
          <label for="cust" class="form-label">Customer</label>
          <select id="cust" class="form-select"></select>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="custMin" class="form-label">Charge fee under ($)</label>
            <input id="custMin" type="number" class="form-control" min="0" step="1" />
          </div>

          <div class="col-12 col-md-6">
            <label for="custFee" class="form-label">Delivery fee ($)</label>
            <input id="custFee" type="number" class="form-control" min="0" step="1" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn btn-primary" id="saveCust">Save</button>
          <button type="button" class="btn btn-outline-danger" id="delCust">Delete</button>
        </div>

        <div class="mt-3 small muted">
          Deleting removes all override rows for this customer.
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
          <div>
            <div class="fw-bold">Overrides List</div>
            <div class="muted small">Latest 200 customer overrides.</div>
          </div>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshList">Refresh</button>
        </div>

        <div class="table-wrap">
          <table class="table table-sm table-hover align-middle m-0">
            <thead>
              <tr>
                <th style="width:40%;">Customer</th>
                <th style="width:20%;">Under ($)</th>
                <th style="width:20%;">Fee ($)</th>
                <th style="width:20%;">Customer ID</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>

        <div class="mt-2 small muted">
          Note: Customer ID is shown for debugging only.
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">

import { supabase } from "../supabaseClient.js";
import "./admin-auth.js";

// Expose Supabase client for /assets/admin-analytics.js
window.supabaseClient = supabase;

function auditDeliveryRule(action, { entity_id, before, after, meta } = {}) {
  if (typeof window === "undefined") return;
  if (typeof window.ShrinxaAdminTrack !== "function") return;

  const NULL_UUID = "00000000-0000-0000-0000-000000000000";
  const uuidRe =
    /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;

  const rawEntityId =
    entity_id === undefined || entity_id === null ? "" : String(entity_id);
  const entityIdUuid = uuidRe.test(rawEntityId) ? rawEntityId : NULL_UUID;

  const metaOut = meta && typeof meta === "object" ? { ...meta } : {};
  if (entityIdUuid === NULL_UUID && rawEntityId) metaOut.raw_entity_id = rawEntityId;

  window.ShrinxaAdminTrack(
    "delivery_rules",
    metaOut,
    {
      entity: "delivery_rules",
      entity_id: entityIdUuid,
      action: String(action || ""),
      before: before ?? null,
      after: after ?? null,
    }
  );
}



const adminEmailEl = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "../login.html";
});

  const $ = (id) => document.getElementById(id);

  function money(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function setBusy(btn, busy){
    if(!btn) return;
    btn.disabled = !!busy;
    btn.dataset._oldText = btn.dataset._oldText || btn.innerText;
    btn.innerText = busy ? "Saving..." : btn.dataset._oldText;
  }

  function showStatus(type, msg){
    const area = $("statusArea");
    if(!area) return;
    area.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <div>${msg}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
  }

async function ensureAuth(){
  const { data:{ user }, error } = await supabase.auth.getUser();
  if(error){ console.error(error); }
  if (adminEmailEl) adminEmailEl.textContent = user?.email || "";
  return !!user;
}

  const customerMap = new Map(); // id -> label

  async function loadCustomers(){
    if(!(await ensureAuth())) return;
    const { data, error } = await supabase
      .from("profiles")
      .select("id,email,full_name")
      .order("email");

    if(error){ console.error(error); showStatus("danger", "Failed to load customers."); return; }

    customerMap.clear();
    data.forEach(c => customerMap.set(c.id, `${(c.full_name || "").trim()} — ${(c.email || "").trim()}`.replace(/^\s*—\s*$/, c.id)));

   $("cust").innerHTML =
  '<option value="">Select</option>' +
  data.map(c => {
    const name = (c.full_name || "").trim();
    const email = (c.email || "").trim();
    const label = (name && email) ? `${name} — ${email}` : (name || email || c.id);
    return `<option value="${c.id}">${label}</option>`;
  }).join("");
  }

  async function loadDefault(){
    if(!(await ensureAuth())) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("*")
      .is("customer_id", null)
      .eq("is_active", true)
      .order("updated_at", { ascending: false })
      .order("id", { ascending: false })
      .limit(1)
      .maybeSingle();

    if(error){
      console.error("loadDefault error:", error);
      showStatus("danger", "Failed to load default rule (check console).");
      return;
    }

    if(data){
      $("defMin").value = data.min_subtotal ?? "";
      $("defFee").value = data.fee ?? "";
    } else {
      $("defMin").value = "";
      $("defFee").value = "";
    }
  }

async function saveDefault(){
  const btn = $("saveDefault");
  setBusy(btn, true);

  let beforeRow = null;
  let afterRow = null;

  try{
    if(!(await ensureAuth())) return;

    const min_subtotal = money($("defMin").value);
    const fee = money($("defFee").value);

    // BEFORE snapshot (current active default)
    const { data: beforeData } = await supabase
      .from("delivery_rules")
      .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
      .is("customer_id", null)
      .eq("is_active", true)
      .order("updated_at", { ascending: false })
      .order("id", { ascending: false })
      .limit(1);

    beforeRow = beforeData && beforeData[0] ? beforeData[0] : null;

    let savedId = null;

    if(beforeRow?.id){
      const { data, error } = await supabase
        .from("delivery_rules")
        .update({
          min_subtotal,
          fee,
          is_active: true,
          updated_at: new Date().toISOString(),
        })
        .eq("id", beforeRow.id)
        .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
        .single();

      if(error) throw error;

      afterRow = data;
      savedId = data.id;
    } else {
      const { data, error } = await supabase
        .from("delivery_rules")
        .insert({
          customer_id: null,
          min_subtotal,
          fee,
          is_active: true,
        })
        .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
        .single();

      if(error) throw error;

      afterRow = data;
      savedId = data.id;
    }

    // Deactivate other defaults
    if(savedId){
      await supabase
        .from("delivery_rules")
        .update({ is_active: false })
        .is("customer_id", null)
        .neq("id", savedId);
    }

    auditDeliveryRule("default_save", {
      entity_id: afterRow?.id || "default",
      before: beforeRow,
      after: afterRow,
      meta: { page: "delivery_rules", section: "default_rule" },
    });

    showStatus(
      "success",
      `Saved default rule: free delivery over <b>$${min_subtotal}</b>, fee <b>$${fee}</b>.`
    );

    await loadDefault();
    await loadList();

  } catch (e){
    console.error(e);
    showStatus("danger", "Save failed (check console).");
  } finally {
    setBusy(btn, false);
  }
}
  




  async function loadCustomerOverride(){
    const cid = $("cust").value;
    $("custMin").value = "";
    $("custFee").value = "";
    if(!cid) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("*")
      .eq("customer_id", cid)
      .order("updated_at", { ascending: false })
      .order("id", { ascending: false })
      .limit(1)
      .maybeSingle();

    if(error){ console.error(error); return; }
    if(data){
      $("custMin").value = data.min_subtotal ?? "";
      $("custFee").value = data.fee ?? "";
    }
  }

  async function saveCust(){
    const btn = $("saveCust");
    setBusy(btn, true);

    let beforeRow = null;
    let afterRow = null;

    try{
      if(!(await ensureAuth())) return;

      const cid = $("cust").value;
      if(!cid){ showStatus("warning", "Select a customer first."); return; }

      const min_subtotal = money($("custMin").value);
      const fee = money($("custFee").value);

      // BEFORE snapshot (newest override for this customer, if exists)
      const { data: beforeData, error: bErr } = await supabase
        .from("delivery_rules")
        .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
        .eq("customer_id", cid)
        .order("updated_at", { ascending: false })
        .order("id", { ascending: false })
        .limit(1);

      if(bErr){
        console.error(bErr);
        showStatus("danger", "Save failed (before lookup error).");
        return;
      }

      beforeRow = beforeData && beforeData[0] ? beforeData[0] : null;

      if(beforeRow?.id){
        const { data, error } = await supabase
          .from("delivery_rules")
          .update({
            min_subtotal,
            fee,
            is_active: true,
            updated_at: new Date().toISOString(),
          })
          .eq("id", beforeRow.id)
          .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
          .single();

        if(error) throw error;

        afterRow = data;
      } else {
        const { data, error } = await supabase
          .from("delivery_rules")
          .insert({
            customer_id: cid,
            min_subtotal,
            fee,
            is_active: true,
          })
          .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
          .single();

        if(error) throw error;

        afterRow = data;
      }

      auditDeliveryRule("override_save", {
        entity_id: afterRow?.id || cid,
        before: beforeRow,
        after: afterRow || { customer_id: cid, min_subtotal, fee, is_active: true },
        meta: {
          page: "delivery_rules",
          section: "customer_override",
          customer_id: cid,
          customer_label: customerMap.get(cid) || cid,
        },
      });

      showStatus("success", `Saved override for <b>${customerMap.get(cid) || cid}</b>.`);
      await loadList();
    } catch (e){
      console.error(e);
      showStatus("danger", "Save failed (check console).");
    } finally {
      setBusy(btn, false);
    }
  }
  
  async function delCust(){
    const btn = $("delCust");
    setBusy(btn, true);

    let beforeRows = null;

    try{
      if(!(await ensureAuth())) return;

      const cid = $("cust").value;
      if(!cid){ showStatus("warning", "Select a customer first."); return; }

      // BEFORE snapshot (all overrides for this customer)
      const { data: beforeData, error: bErr } = await supabase
        .from("delivery_rules")
        .select("id, customer_id, min_subtotal, fee, is_active, updated_at")
        .eq("customer_id", cid)
        .order("updated_at", { ascending: false });

      if(bErr){
        console.error(bErr);
        showStatus("danger", "Delete failed (before lookup error).");
        return;
      }

      beforeRows = beforeData || [];

      const { error } = await supabase
        .from("delivery_rules")
        .delete()
        .eq("customer_id", cid);

      if(error){ console.error(error); showStatus("danger", "Delete failed (check console)."); return; }

      auditDeliveryRule("override_delete", {
        entity_id: cid,
        before: { rows: beforeRows },
        after: null,
        meta: {
          page: "delivery_rules",
          section: "customer_override",
          customer_id: cid,
          customer_label: customerMap.get(cid) || cid,
        },
      });

      showStatus("success", `Deleted override for <b>${customerMap.get(cid) || cid}</b>.`);
      $("cust").value = "";
      $("custMin").value = "";
      $("custFee").value = "";
      await loadList();
    } finally {
      setBusy(btn, false);
    }
  }



 

  async function loadList(){
    if(!(await ensureAuth())) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("customer_id,min_subtotal,fee,updated_at")
      .not("customer_id","is",null)
      .order("updated_at", { ascending: false })
      .limit(200);

    if(error){ console.error(error); showStatus("danger", "Failed to load overrides list."); return; }

    $("list").innerHTML = (data || []).map(r => {
      const label = customerMap.get(r.customer_id) || r.customer_id;
      return `<tr>
        <td>${label}</td>
        <td>$${r.min_subtotal}</td>
        <td>$${r.fee}</td>
        <td class="mono">${r.customer_id}</td>
      </tr>`;
    }).join("");
  }

  $("saveDefault").addEventListener("click", (e)=>{ e.preventDefault(); saveDefault(); });
  $("loadDefault").addEventListener("click", async (e)=> {
    e.preventDefault();

    // BEFORE: current inputs (what admin currently has on screen)
    const before = {
      min_subtotal: $("defMin").value === "" ? null : Number($("defMin").value),
      fee: $("defFee").value === "" ? null : Number($("defFee").value),
    };

    await loadDefault();

    // AFTER: inputs after reload
    const after = {
      min_subtotal: $("defMin").value === "" ? null : Number($("defMin").value),
      fee: $("defFee").value === "" ? null : Number($("defFee").value),
    };

    auditDeliveryRule("default_reload", {
      entity_id: "default",
      before,
      after,
      meta: { page: "delivery_rules", section: "default_rule" },
    });
  });

  $("saveCust").addEventListener("click", (e)=>{ e.preventDefault(); saveCust(); });
  $("delCust").addEventListener("click", (e)=>{ e.preventDefault(); delCust(); });
  $("refreshList").addEventListener("click", async (e)=> {
    e.preventDefault();

    const before = {
      row_count: document.querySelectorAll("#list tr").length,
    };

    await loadList();

    const after = {
      row_count: document.querySelectorAll("#list tr").length,
    };

    auditDeliveryRule("overrides_refresh", {
      entity_id: "overrides_list",
      before,
      after,
      meta: { page: "delivery_rules", section: "overrides_list" },
    });
  });

  $("cust").addEventListener("change", async () => {
    const cid = $("cust").value || "";

    const before = {
      selected_customer_id: null,
      custMin: $("custMin").value === "" ? null : Number($("custMin").value),
      custFee: $("custFee").value === "" ? null : Number($("custFee").value),
    };

    await loadCustomerOverride();

    const after = {
      selected_customer_id: cid || null,
      customer_label: cid ? (customerMap.get(cid) || cid) : null,
      custMin: $("custMin").value === "" ? null : Number($("custMin").value),
      custFee: $("custFee").value === "" ? null : Number($("custFee").value),
    };

    auditDeliveryRule("customer_select", {
      entity_id: cid || "none",
      before,
      after,
      meta: { page: "delivery_rules", section: "customer_override" },
    });
  });



  (async function init(){
    if(!(await ensureAuth())) return;
    await loadCustomers();
    await loadDefault();
    await loadList();
  })();
</script>
<script src="/assets/admin-analytics.js" defer></script>

</body>
</html>
