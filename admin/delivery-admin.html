<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Rules - Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111; }
    header { background:#111; color:#fff; padding:14px 18px; }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header a { color:#fff; text-decoration:none; }
    main { max-width: 1100px; margin: 18px auto; padding: 0 14px 30px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:12px; padding:14px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    h2 { margin:0 0 10px 0; font-size: 18px; }
    label { display:block; font-size: 13px; color:#444; margin-bottom:6px; }
    input, select { width:100%; padding:10px 10px; border:1px solid #d8d8e6; border-radius:10px; background:#fff; font-size:14px; }
    .row { display:flex; gap:10px; align-items:end; }
    .row > div { flex:1; }
    .btn { border:0; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#111; color:#fff; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-ghost { background:#eee; color:#111; }
    .muted { color:#666; font-size: 13px; }
    .msg { margin-top:10px; font-size: 14px; }
    .msg.ok { color:#0a7a2f; }
    .msg.err { color:#b00020; }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom:1px solid #eee; font-size: 14px; }
    th { color:#333; font-size: 13px; text-transform: uppercase; letter-spacing:.03em; }
    .badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size: 12px; background:#f0f0f7; }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <strong>Shrinxa Admin</strong> <span class="badge" style="margin-left:10px;">Delivery Rules</span>
      </div>
            <div class="row" style="gap:14px;">
        <a href="./dashboard.html">Dashboard</a>
        <a href="./orders.html">Orders</a>
        <a href="./customers.html">Customers</a>
        <a href="./products-admin.html">Products</a>
        <a href="./platinum.html">Platinum</a>
        <a href="./delivery-admin.html" style="text-decoration:underline;">Delivery Rules</a>
      </div>
    </div>
  </header>

  <main>
    <div id="pageMsg" class="msg" style="margin-bottom:12px;"></div>
    <div class="grid">
      <!-- Default Rule -->
      <div class="card">
        <h2>Default Delivery Rule</h2>
        <p class="muted" style="margin-top:0;">
          Applies to everyone unless a customer override exists.
        </p>

        <div class="row">
          <div>
            <label>Charge fee when subtotal is under ($)</label>
            <input id="defaultMinSubtotal" type="number" step="0.01" min="0" />
          </div>
          <div>
            <label>Delivery fee ($)</label>
            <input id="defaultFee" type="number" step="0.01" min="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="btnSaveDefault">Save Default</button>
          <button class="btn btn-ghost" id="btnReloadDefault">Reload</button>
        </div>

        <div id="defaultMsg" class="msg"></div>
      </div>

      <!-- Customer Override -->
      <div class="card">
        <h2>Customer Override</h2>
        <p class="muted" style="margin-top:0;">
          Set a special rule for a specific customer (overrides default).
        </p>

        <label>Select customer</label>
        <select id="customerSelect"></select>

        <div style="height:10px;"></div>

        <div class="row">
          <div>
            <label>Charge fee when subtotal is under ($)</label>
            <input id="custMinSubtotal" type="number" step="0.01" min="0" />
          </div>
          <div>
            <label>Delivery fee ($)</label>
            <input id="custFee" type="number" step="0.01" min="0" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn btn-primary" id="btnSaveCustomer">Save Override</button>
          <button class="btn btn-danger" id="btnDeleteCustomer">Delete Override</button>
        </div>

        <div id="custMsg" class="msg"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Current Overrides</h2>
      <p class="muted" style="margin-top:0;">Quick view of all customer-specific rules.</p>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Customer</th>
              <th>Charge Under</th>
              <th>Fee</th>
              <th>Status</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody id="overrideTbody">
            <tr><td colspan="5" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Your existing auth.js should initialize window.supabaseClient -->
  <script src="../auth.js"></script>

  <script>
    // Bridge: support different auth.js globals
    window.supabaseClient = window.supabaseClient || window.supabase || window.sb || window.client || null;
  </script>

  <script>
    function showMsg(el, text, ok=true) {
      el.className = "msg " + (ok ? "ok" : "err");
      el.textContent = text || "";
    }

    function money(n) {
      const v = Number(n || 0);
      return isFinite(v) ? v : 0;
    }

    async function requireSupabase() {
      // wait for auth.js to initialize (some builds attach globals late)
      for (let i = 0; i < 40; i++) {
        window.supabaseClient = window.supabaseClient || window.supabase || window.sb || window.client || null;
        if (window.supabaseClient) break;
        await new Promise(r => setTimeout(r, 100));
      }
      if (!window.supabaseClient) {
        throw new Error("Supabase client not found. Check ../auth.js path, and ensure it sets window.supabaseClient (or window.supabase).");
      }
      return window.supabaseClient;
    }

    async function loadDefaultRule() {
      const supabase = await requireSupabase();
      const msg = document.getElementById("defaultMsg");
      showMsg(msg, "");

      const { data, error } = await supabase
        .from("delivery_rules")
        .select("*")
        .is("customer_id", null)
        .limit(1)
        .maybeSingle();

      if (error) {
        showMsg(msg, error.message, false);
        return;
      }

      document.getElementById("defaultMinSubtotal").value = data?.min_subtotal ?? 300;
      document.getElementById("defaultFee").value = data?.fee ?? 30;
      showMsg(msg, "Default rule loaded.", true);
    }

    async function saveDefaultRule() {
      const supabase = await requireSupabase();
      const msg = document.getElementById("defaultMsg");
      showMsg(msg, "");

      const min_subtotal = money(document.getElementById("defaultMinSubtotal").value);
      const fee = money(document.getElementById("defaultFee").value);

      const { error } = await supabase
        .from("delivery_rules")
        .upsert({
          customer_id: null,
          min_subtotal,
          fee,
          is_active: true
        }, { onConflict: "customer_id" });

      if (error) {
        showMsg(msg, error.message, false);
        return;
      }

      showMsg(msg, "Default rule saved.", true);
      await loadOverridesTable();
    }

    async function loadCustomers() {
      const supabase = await requireSupabase();
      const select = document.getElementById("customerSelect");

      // Adjust these fields if your profiles table differs
      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, full_name")
        .order("email", { ascending: true });

      if (error) {
        select.innerHTML = `<option value="">Error loading customers</option>`;
        return;
      }

      const rows = (data || []).filter(x => x.id);
      if (!rows.length) {
        select.innerHTML = `<option value="">No customers found</option>`;
        return;
      }

      select.innerHTML = `<option value="">-- choose customer --</option>` + rows.map(c => {
        const name = (c.full_name || "").trim();
        const label = name ? `${name} — ${c.email}` : c.email;
        return `<option value="${c.id}">${label}</option>`;
      }).join("");
    }

    async function loadCustomerOverride(customerId) {
      const supabase = await requireSupabase();
      const msg = document.getElementById("custMsg");
      showMsg(msg, "");

      if (!customerId) {
        document.getElementById("custMinSubtotal").value = "";
        document.getElementById("custFee").value = "";
        showMsg(msg, "Select a customer.", true);
        return;
      }

      const { data, error } = await supabase
        .from("delivery_rules")
        .select("*")
        .eq("customer_id", customerId)
        .limit(1)
        .maybeSingle();

      if (error) {
        showMsg(msg, error.message, false);
        return;
      }

      if (!data) {
        document.getElementById("custMinSubtotal").value = "";
        document.getElementById("custFee").value = "";
        showMsg(msg, "No override for this customer (default will apply).", true);
        return;
      }

      document.getElementById("custMinSubtotal").value = data.min_subtotal ?? "";
      document.getElementById("custFee").value = data.fee ?? "";
      showMsg(msg, "Override loaded.", true);
    }

    async function saveCustomerOverride() {
      const supabase = await requireSupabase();
      const msg = document.getElementById("custMsg");
      showMsg(msg, "");

      const customerId = document.getElementById("customerSelect").value;
      if (!customerId) return showMsg(msg, "Choose a customer first.", false);

      const min_subtotal = money(document.getElementById("custMinSubtotal").value);
      const fee = money(document.getElementById("custFee").value);

      const { error } = await supabase
        .from("delivery_rules")
        .upsert({
          customer_id: customerId,
          min_subtotal,
          fee,
          is_active: true
        }, { onConflict: "customer_id" });

      if (error) {
        showMsg(msg, error.message, false);
        return;
      }

      showMsg(msg, "Customer override saved.", true);
      await loadOverridesTable();
    }

    async function deleteCustomerOverride() {
      const supabase = await requireSupabase();
      const msg = document.getElementById("custMsg");
      showMsg(msg, "");

      const customerId = document.getElementById("customerSelect").value;
      if (!customerId) return showMsg(msg, "Choose a customer first.", false);

      const { error } = await supabase
        .from("delivery_rules")
        .delete()
        .eq("customer_id", customerId);

      if (error) {
        showMsg(msg, error.message, false);
        return;
      }

      document.getElementById("custMinSubtotal").value = "";
      document.getElementById("custFee").value = "";
      showMsg(msg, "Override deleted (default will apply).", true);
      await loadOverridesTable();
    }

    async function loadOverridesTable() {
      const supabase = await requireSupabase();
      const tbody = document.getElementById("overrideTbody");

      const { data, error } = await supabase
        .from("delivery_rules")
        .select("customer_id, min_subtotal, fee, is_active, updated_at")
        .not("customer_id", "is", null)
        .order("updated_at", { ascending: false });

      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">Error: ${error.message}</td></tr>`;
        return;
      }

      if (!data || !data.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No overrides yet.</td></tr>`;
        return;
      }

      // fetch customer names/emails for display
      const ids = data.map(r => r.customer_id).filter(Boolean);
      const { data: customers } = await supabase
        .from("profiles")
        .select("id, email, full_name")
        .in("id", ids);

      const map = new Map((customers || []).map(c => [c.id, c]));

      tbody.innerHTML = data.map(r => {
        const c = map.get(r.customer_id) || {};
        const name = (c.full_name || "").trim();
        const label = name ? `${name} — ${c.email || ""}` : (c.email || r.customer_id);

        return `
          <tr>
            <td>${label}</td>
            <td>$${Number(r.min_subtotal).toFixed(2)}</td>
            <td>$${Number(r.fee).toFixed(2)}</td>
            <td>${r.is_active ? "Active" : "Off"}</td>
            <td>${r.updated_at ? new Date(r.updated_at).toLocaleString() : ""}</td>
          </tr>
        `;
      }).join("");
    }

    async function init() {
      // wait a bit for auth.js to set window.supabaseClient
      for (let i=0;i<20;i++){
        if (window.supabaseClient) break;
        await new Promise(r => setTimeout(r, 100));
      }

      try {
        await requireSupabase();
      } catch (e) {
        const pm = document.getElementById('pageMsg');
        showMsg(pm, e.message + '  (Fix: in auth.js, after creating the client, add: window.supabaseClient = supabaseClient;)', false);
        return;
      }

      await loadDefaultRule();
      await loadCustomers();
      await loadOverridesTable();

      document.getElementById("btnSaveDefault").addEventListener("click", saveDefaultRule);
      document.getElementById("btnReloadDefault").addEventListener("click", loadDefaultRule);

      document.getElementById("customerSelect").addEventListener("change", (e) => {
        loadCustomerOverride(e.target.value);
      });

      document.getElementById("btnSaveCustomer").addEventListener("click", saveCustomerOverride);
      document.getElementById("btnDeleteCustomer").addEventListener("click", deleteCustomerOverride);
    }

    init();
  </script>
</body>
</html>
