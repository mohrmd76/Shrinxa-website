<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delivery Rules - Admin</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background:#f6f7fb; color:#111; }
    header { background:#111; color:#fff; padding:14px 18px; }
    header .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header a { color:#fff; text-decoration:none; }
    main { max-width: 1100px; margin: 18px auto; padding: 0 14px 30px; }
    .card { background:#fff; border:1px solid #e6e6ef; border-radius:12px; padding:14px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
    label { display:block; font-size:13px; margin-bottom:6px; }
    input, select { width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .btn { padding:10px 14px; border:0; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn-primary { background:#111; color:#fff; }
    .btn-danger { background:#c0392b; color:#fff; }
    .btn-ghost { background:#eee; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { padding:8px; border-bottom:1px solid #eee; font-size:14px; }
  </style>
</head>
<body>

<header>
  <div class="row">
    <div><strong>Shrinxa Admin</strong></div>
    <div class="row">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html" style="text-decoration:underline;">Delivery Rules</a>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <div class="card">
      <h3>Default Rule</h3>
      <label>Charge fee under ($)</label>
      <input id="defMin" type="number">
      <label>Delivery fee ($)</label>
      <input id="defFee" type="number">
      <div class="row">
        <button class="btn btn-primary" id="saveDefault">Save</button>
        <button class="btn btn-ghost" id="loadDefault">Reload</button>
      </div>
    </div>

    <div class="card">
      <h3>Customer Override</h3>
      <label>Customer</label>
      <select id="cust"></select>
      <label>Charge fee under ($)</label>
      <input id="custMin" type="number">
      <label>Delivery fee ($)</label>
      <input id="custFee" type="number">
      <div class="row">
        <button class="btn btn-primary" id="saveCust">Save</button>
        <button class="btn btn-danger" id="delCust">Delete</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Overrides</h3>
    <table>
      <thead>
        <tr><th>Customer</th><th>Under</th><th>Fee</th></tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>
</main>

<script type="module">
  import { supabase } from "../supabaseClient.js";
  import "./admin-auth.js";

  const $ = id => document.getElementById(id);
  const money = v => isFinite(Number(v)) ? Number(v) : 0;

  async function ensureAuth(){
    const { data:{ user } } = await supabase.auth.getUser();
    if(!user) return false;
    return true;
  }

  async function loadCustomers(){
    if(!(await ensureAuth())) return;
    const { data, error } = await supabase
      .from("profiles")
      .select("id,email,full_name")
      .order("email");
    if(error){ console.error(error); return; }
    $("cust").innerHTML = '<option value="">Select</option>' +
      data.map(c=>`<option value="${c.id}">${c.full_name || c.email}</option>`).join("");
  }

  async function loadDefault(){
    if(!(await ensureAuth())) return;
    const { data } = await supabase
      .from("delivery_rules")
      .select("*")
      .is("customer_id",null)
      .single();
    if(data){
      $("defMin").value = data.min_subtotal;
      $("defFee").value = data.fee;
    }
  }

  async function saveDefault(){
    await supabase.from("delivery_rules").upsert({
      customer_id:null,
      min_subtotal: money($("defMin").value),
      fee: money($("defFee").value),
      is_active:true
    });
    loadList();
  }

  async function saveCust(){
    await supabase.from("delivery_rules").upsert({
      customer_id:$("cust").value,
      min_subtotal: money($("custMin").value),
      fee: money($("custFee").value),
      is_active:true
    });
    loadList();
  }

  async function delCust(){
    await supabase.from("delivery_rules")
      .delete()
      .eq("customer_id",$("cust").value);
    loadList();
  }

  async function loadList(){
    if(!(await ensureAuth())) return;
    const { data } = await supabase
      .from("delivery_rules")
      .select("customer_id,min_subtotal,fee")
      .not("customer_id","is",null);
    $("list").innerHTML = data.map(r =>
      `<tr><td>${r.customer_id}</td><td>${r.min_subtotal}</td><td>${r.fee}</td></tr>`
    ).join("");
  }

  $("saveDefault").onclick = saveDefault;
  $("loadDefault").onclick = loadDefault;
  $("saveCust").onclick = saveCust;
  $("delCust").onclick = delCust;

  loadDefault();
  loadCustomers();
  loadList();
</script>

</body>
</html>
