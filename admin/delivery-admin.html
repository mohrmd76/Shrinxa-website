<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Shrinxa Admin – Delivery Rules</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .table-wrap{
      max-height: calc(100vh - 320px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
    }

    table{
      border-collapse:separate !important;
      border-spacing:0;
      width:100%;
      min-width: 780px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc !important;
      border-bottom:1px solid rgba(17,24,39,.08) !important;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }

    tbody tr:hover{ background:#fafafa; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .82rem; }
    .muted{ color:var(--muted); font-size:.875rem; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      font-size:.78rem;
      background:#fff;
      color:#334155;
    }

    .btn{ border-radius:12px; }

    h2{ margin:0; font-weight:800; letter-spacing:.2px; }
  </style>
</head>
<body>

<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html" class="active">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html">Income</a>
      <a href="./clients.html">Clients</a>
      <a href="./cash.html">Cash</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small opacity-75"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<main class="container-fluid px-4 py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <div class="page-title h3 m-0">Delivery Rules</div>
      <div class="muted">Control default delivery threshold/fee and customer-specific overrides.</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="pill"><span class="mono">public.delivery_rules</span></span>
      <span class="pill">Active rules only</span>
    </div>
  </div>

  <!-- Status messages -->
  <div id="statusArea" class="mb-3"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card p-3">
        <div class="statusbar mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="fw-bold">Default Rule</div>
            <span class="pill">customer_id = <span class="mono">NULL</span></span>
          </div>
          <div class="hint">Used by checkout when no customer override exists.</div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="defMin" class="form-label">Charge fee under ($)</label>
            <input id="defMin" type="number" class="form-control" min="0" step="1" />
          </div>

          <div class="col-12 col-md-6">
            <label for="defFee" class="form-label">Delivery fee ($)</label>
            <input id="defFee" type="number" class="form-control" min="0" step="1" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn btn-primary" id="saveDefault">Save</button>
          <button type="button" class="btn btn-outline-secondary" id="loadDefault">Reload</button>
        </div>

        <div class="mt-3 small muted">
          Tip: Checkout reads the <b>newest active</b> default rule.
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-6">
      <div class="card p-3">
        <div class="statusbar mb-3">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="fw-bold">Customer Override</div>
            <span class="pill">customer_id = <span class="mono">profiles.id</span></span>
          </div>
          <div class="hint">Overrides default for the selected customer.</div>
        </div>

        <div class="mb-3">
          <label for="cust" class="form-label">Customer</label>
          <select id="cust" class="form-select"></select>
        </div>

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="custMin" class="form-label">Charge fee under ($)</label>
            <input id="custMin" type="number" class="form-control" min="0" step="1" />
          </div>

          <div class="col-12 col-md-6">
            <label for="custFee" class="form-label">Delivery fee ($)</label>
            <input id="custFee" type="number" class="form-control" min="0" step="1" />
          </div>
        </div>

        <div class="d-flex gap-2 mt-3">
          <button type="button" class="btn btn-primary" id="saveCust">Save</button>
          <button type="button" class="btn btn-outline-danger" id="delCust">Delete</button>
        </div>

        <div class="mt-3 small muted">
          Deleting removes all override rows for this customer.
        </div>
      </div>
    </div>

    <div class="col-12">
      <div class="card p-3">
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
          <div>
            <div class="fw-bold">Overrides List</div>
            <div class="muted small">Latest 200 customer overrides.</div>
          </div>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshList">Refresh</button>
        </div>

        <div class="table-wrap">
          <table class="table table-sm table-hover align-middle m-0">
            <thead>
              <tr>
                <th style="width:40%;">Customer</th>
                <th style="width:20%;">Under ($)</th>
                <th style="width:20%;">Fee ($)</th>
                <th style="width:20%;">Customer ID</th>
              </tr>
            </thead>
            <tbody id="list"></tbody>
          </table>
        </div>

        <div class="mt-2 small muted">
          Note: Customer ID is shown for debugging only.
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { supabase } from "../supabaseClient.js";
  import "./admin-auth.js";
const adminEmailEl = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "../login.html";
});

  const $ = (id) => document.getElementById(id);

  function money(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function setBusy(btn, busy){
    if(!btn) return;
    btn.disabled = !!busy;
    btn.dataset._oldText = btn.dataset._oldText || btn.innerText;
    btn.innerText = busy ? "Saving..." : btn.dataset._oldText;
  }

  function showStatus(type, msg){
    const area = $("statusArea");
    if(!area) return;
    area.innerHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <div>${msg}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
  }

async function ensureAuth(){
  const { data:{ user }, error } = await supabase.auth.getUser();
  if(error){ console.error(error); }
  if (adminEmailEl) adminEmailEl.textContent = user?.email || "";
  return !!user;
}

  const customerMap = new Map(); // id -> label

  async function loadCustomers(){
    if(!(await ensureAuth())) return;
    const { data, error } = await supabase
      .from("profiles")
      .select("id,email,full_name")
      .order("email");

    if(error){ console.error(error); showStatus("danger", "Failed to load customers."); return; }

    customerMap.clear();
    data.forEach(c => customerMap.set(c.id, `${(c.full_name || "").trim()} — ${(c.email || "").trim()}`.replace(/^\s*—\s*$/, c.id)));

   $("cust").innerHTML =
  '<option value="">Select</option>' +
  data.map(c => {
    const name = (c.full_name || "").trim();
    const email = (c.email || "").trim();
    const label = (name && email) ? `${name} — ${email}` : (name || email || c.id);
    return `<option value="${c.id}">${label}</option>`;
  }).join("");
  }

  async function loadDefault(){
    if(!(await ensureAuth())) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("*")
      .is("customer_id", null)
      .eq("is_active", true)
      .order("updated_at", { ascending: false })
      .order("id", { ascending: false })
      .limit(1)
      .maybeSingle();

    if(error){
      console.error("loadDefault error:", error);
      showStatus("danger", "Failed to load default rule (check console).");
      return;
    }

    if(data){
      $("defMin").value = data.min_subtotal ?? "";
      $("defFee").value = data.fee ?? "";
    } else {
      $("defMin").value = "";
      $("defFee").value = "";
    }
  }

  async function saveDefault(){
    const btn = $("saveDefault");
    setBusy(btn, true);

    try{
      if(!(await ensureAuth())) return;

      const min_subtotal = money($("defMin").value);
      const fee = money($("defFee").value);

      // Always save to the newest ACTIVE default rule if it exists, otherwise create a new one.
      const { data: newest, error: newestErr } = await supabase
        .from("delivery_rules")
        .select("id")
        .is("customer_id", null)
        .eq("is_active", true)
        .order("updated_at", { ascending: false })
        .order("id", { ascending: false })
        .limit(1)
        .maybeSingle();

      if(newestErr){
        console.error("newest default lookup error:", newestErr);
        showStatus("danger", "Save failed (lookup error).");
        return;
      }

      let savedId = null;

      if(newest?.id){
        const { data: updated, error } = await supabase
          .from("delivery_rules")
          .update({ min_subtotal, fee, is_active: true, updated_at: new Date().toISOString() })
          .eq("id", newest.id)
          .select("id")
          .single();
        if(error){
          console.error("saveDefault error:", error);
          showStatus("danger", "Save failed (check console).");
          return;
        }
        savedId = updated?.id || newest.id;
      } else {
        const { data: inserted, error } = await supabase
          .from("delivery_rules")
          .insert({ customer_id: null, min_subtotal, fee, is_active: true })
          .select("id")
          .single();
        if(error){
          console.error("saveDefault error:", error);
          showStatus("danger", "Save failed (check console).");
          return;
        }
        savedId = inserted?.id || null;
      }

      // Deactivate other default rules (so main site doesn't read an old one)
      if(savedId){
        const { error: deactErr } = await supabase
          .from("delivery_rules")
          .update({ is_active: false })
          .is("customer_id", null)
          .neq("id", savedId);

        if(deactErr){
          console.warn("deactivate other defaults warning:", deactErr);
          // not fatal
        }
      }

      showStatus("success", `Saved default rule: free delivery over <b>$${min_subtotal}</b>, fee <b>$${fee}</b>.`);
      await loadDefault();
      await loadList();
    } finally {
      setBusy(btn, false);
    }
  }

  async function loadCustomerOverride(){
    const cid = $("cust").value;
    $("custMin").value = "";
    $("custFee").value = "";
    if(!cid) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("*")
      .eq("customer_id", cid)
      .order("updated_at", { ascending: false })
      .order("id", { ascending: false })
      .limit(1)
      .maybeSingle();

    if(error){ console.error(error); return; }
    if(data){
      $("custMin").value = data.min_subtotal ?? "";
      $("custFee").value = data.fee ?? "";
    }
  }

  async function saveCust(){
    const btn = $("saveCust");
    setBusy(btn, true);

    try{
      if(!(await ensureAuth())) return;

      const cid = $("cust").value;
      if(!cid){ showStatus("warning", "Select a customer first."); return; }

      const min_subtotal = money($("custMin").value);
      const fee = money($("custFee").value);

      const { data: newest, error: newestErr } = await supabase
        .from("delivery_rules")
        .select("id")
        .eq("customer_id", cid)
        .order("updated_at", { ascending: false })
        .order("id", { ascending: false })
        .limit(1)
        .maybeSingle();

      if(newestErr){ console.error(newestErr); showStatus("danger", "Save failed (lookup error)."); return; }

      let err = null;
      if(newest?.id){
        const { error } = await supabase
          .from("delivery_rules")
          .update({ min_subtotal, fee, is_active: true, updated_at: new Date().toISOString() })
          .eq("id", newest.id);
        err = error;
      } else {
        const { error } = await supabase
          .from("delivery_rules")
          .insert({ customer_id: cid, min_subtotal, fee, is_active: true });
        err = error;
      }

      if(err){ console.error(err); showStatus("danger", "Save failed (check console)."); return; }

      showStatus("success", `Saved override for <b>${customerMap.get(cid) || cid}</b>.`);
      await loadList();
    } finally {
      setBusy(btn, false);
    }
  }

  async function delCust(){
    const btn = $("delCust");
    setBusy(btn, true);

    try{
      if(!(await ensureAuth())) return;

      const cid = $("cust").value;
      if(!cid){ showStatus("warning", "Select a customer first."); return; }

      const { error } = await supabase
        .from("delivery_rules")
        .delete()
        .eq("customer_id", cid);

      if(error){ console.error(error); showStatus("danger", "Delete failed (check console)."); return; }

      showStatus("success", `Deleted override for <b>${customerMap.get(cid) || cid}</b>.`);
      $("cust").value = "";
      $("custMin").value = "";
      $("custFee").value = "";
      await loadList();
    } finally {
      setBusy(btn, false);
    }
  }

  async function loadList(){
    if(!(await ensureAuth())) return;

    const { data, error } = await supabase
      .from("delivery_rules")
      .select("customer_id,min_subtotal,fee,updated_at")
      .not("customer_id","is",null)
      .order("updated_at", { ascending: false })
      .limit(200);

    if(error){ console.error(error); showStatus("danger", "Failed to load overrides list."); return; }

    $("list").innerHTML = (data || []).map(r => {
      const label = customerMap.get(r.customer_id) || r.customer_id;
      return `<tr>
        <td>${label}</td>
        <td>$${r.min_subtotal}</td>
        <td>$${r.fee}</td>
        <td class="mono">${r.customer_id}</td>
      </tr>`;
    }).join("");
  }

  $("saveDefault").addEventListener("click", (e)=>{ e.preventDefault(); saveDefault(); });
  $("loadDefault").addEventListener("click", (e)=>{ e.preventDefault(); loadDefault(); });
  $("saveCust").addEventListener("click", (e)=>{ e.preventDefault(); saveCust(); });
  $("delCust").addEventListener("click", (e)=>{ e.preventDefault(); delCust(); });
  $("refreshList").addEventListener("click", (e)=>{ e.preventDefault(); loadList(); });
  $("cust").addEventListener("change", loadCustomerOverride);

  (async function init(){
    if(!(await ensureAuth())) return;
    await loadCustomers();
    await loadDefault();
    await loadList();
  })();
</script>
<script src="/assets/admin-analytics.js" defer></script>

</body>
</html>
