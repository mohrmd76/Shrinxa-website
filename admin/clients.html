<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin ‚Äì Clients</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../admin.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Primary Palette */
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-light: rgba(99, 102, 241, 0.1);
      
      /* Semantic Colors */
      --success: #10b981;
      --success-light: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b;
      --warning-light: rgba(245, 158, 11, 0.1);
      --danger: #ef4444;
      --danger-light: rgba(239, 68, 68, 0.1);
      --info: #0ea5e9;
      --info-light: rgba(14, 165, 233, 0.1);
      
      /* Light Theme */
      --bg-body: #f8fafc;
      --bg-panel: #ffffff;
      --bg-panel-header: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --bg-input: #ffffff;
      --bg-card: #ffffff;
      --bg-card-hover: #f8fafc;
      --bg-badge: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --border-color: #e2e8f0;
      --border-light: #f1f5f9;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.04);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.15);
    }

    /* Dark Theme */
    [data-theme="dark"] {
      --bg-body: #0f172a;
      --bg-panel: #1e293b;
      --bg-panel-header: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      --bg-input: #0f172a;
      --bg-card: #1e293b;
      --bg-card-hover: #334155;
      --bg-badge: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --border-color: #334155;
      --border-light: #1e293b;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
      --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.2);
      --primary-light: rgba(99, 102, 241, 0.2);
      --success-light: rgba(16, 185, 129, 0.2);
      --warning-light: rgba(245, 158, 11, 0.2);
      --danger-light: rgba(239, 68, 68, 0.2);
      --info-light: rgba(14, 165, 233, 0.2);
    }

    * { box-sizing: border-box; }

    body { 
      background: var(--bg-body);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text-primary);
      transition: background 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    header { background:#111; }
    header a { color:#fff; text-decoration:none; opacity:.9; }
    header a:hover { opacity:1; text-decoration:underline; }
    .nav-links { gap:14px; flex-wrap:wrap; }
    .hidden { display: none !important; }

    /* --- PAGE LAYOUT --- */
    .page-wrap { 
      padding: 24px 28px 40px; 
      max-width: 1600px;
      margin: 0 auto;
    }

    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title-wrap {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .page-icon {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: var(--shadow-glow);
    }

    .page-title { 
      font-size: 28px; 
      font-weight: 800; 
      margin: 0;
      color: var(--text-primary);
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .page-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* --- THEME TOGGLE --- */
    .theme-toggle {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-panel);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s ease;
      color: var(--text-primary);
    }

    .theme-toggle:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-glow);
      transform: scale(1.05);
    }

    /* --- STAT CARDS --- */
    .stats-row {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      flex: 1;
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow);
      transition: all 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .stat-icon.customers { background: var(--info-light); }
    .stat-icon.products { background: var(--success-light); }
    .stat-icon.orders { background: var(--primary-light); }
    .stat-icon.delivery { background: var(--warning-light); }

    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* --- PANELS --- */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .panel:hover {
      box-shadow: var(--shadow-lg);
    }

    .panel-hd {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-panel-header);
      font-weight: 700;
      font-size: 15px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-hd-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .panel-hd-icon.customer { background: var(--info-light); }
    .panel-hd-icon.products { background: var(--success-light); }
    .panel-hd-icon.order { background: var(--primary-light); }

    .panel-bd { padding: 20px; }

    .muted { color: var(--text-muted); }
    .mini { font-size: 12px; }

    /* --- FORM CONTROLS --- */
    .input-compact { 
      height: 42px; 
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .input-compact:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }

    .form-select {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .form-control {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-color);
    }

    .form-control:focus, .form-select:focus {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* --- GRID LAYOUT --- */
    .order-grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      align-items: start;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 8px;
    }

    .products-grid::-webkit-scrollbar {
      width: 6px;
    }

    .products-grid::-webkit-scrollbar-track {
      background: var(--bg-badge);
      border-radius: 3px;
    }

    .products-grid::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    /* --- PRODUCT CARDS --- */
    .prod-card {
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 16px;
      background: var(--bg-card);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      min-height: 100px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .prod-card:hover {
      border-color: var(--primary);
      background: var(--bg-card-hover);
      box-shadow: var(--shadow-glow);
      transform: translateY(-2px);
    }

    .prod-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .prod-price {
      font-size: 16px;
      font-weight: 700;
      color: var(--primary);
    }

    /* --- BADGES --- */
    .badge-stock {
      font-size: 11px;
      padding: 5px 10px;
      border-radius: 999px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .badge-stock::before {
      content: "";
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .badge-stock.in-stock {
      background: var(--success-light);
      color: var(--success);
    }
    .badge-stock.in-stock::before { background: var(--success); }

    .badge-low {
      background: var(--warning-light);
      color: var(--warning);
    }
    .badge-low::before { background: var(--warning); }

    .badge-out {
      background: var(--danger-light);
      color: var(--danger);
    }
    .badge-out::before { background: var(--danger); }

    /* --- TIER BADGES --- */
    .tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .tier-badge.standard { background: var(--bg-badge); color: var(--text-secondary); }
    .tier-badge.gold { background: rgba(245, 158, 11, 0.15); color: #d97706; }
    .tier-badge.platinum { background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15)); color: var(--primary); }

    /* --- BUTTONS --- */
    .btn-add-prod {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 2px solid var(--primary);
      background: transparent;
      color: var(--primary);
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .btn-add-prod:hover:not(:disabled) {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .btn-add-prod:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .qty-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-panel);
      font-weight: 700;
      font-size: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      color: var(--text-primary);
    }

    .qty-btn:hover:not(:disabled) {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .qty-btn:disabled {
      opacity: .4;
      cursor: not-allowed;
    }

    .qty-box {
      width: 56px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      background: var(--bg-input);
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-primary);
    }

    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-success {
      background: var(--success);
      border-color: var(--success);
      border-radius: 10px;
      font-weight: 600;
    }

    /* --- CLIENT INFO CARD --- */
    .client-info-card {
      background: var(--info-light);
      border: 1px solid rgba(14, 165, 233, 0.2);
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
    }

    .client-info-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
    }

    .client-info-label {
      font-weight: 600;
      color: var(--text-secondary);
      min-width: 80px;
    }

    .client-info-value {
      color: var(--text-primary);
    }

    /* --- DELIVERY RULE DISPLAY --- */
    .delivery-rule-card {
      background: var(--warning-light);
      border: 1px solid rgba(245, 158, 11, 0.2);
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
    }

    .delivery-rule-title {
      font-weight: 700;
      font-size: 13px;
      color: #d97706;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .delivery-rule-detail {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 0;
    }

    .delivery-rule-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    /* --- ORDER TABLE --- */
    .order-table {
      margin-bottom: 0;
      color: var(--text-primary);
    }

    .order-table th {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      padding: 12px 8px;
      border-bottom: 2px solid var(--border-color);
      background: transparent;
    }

    .order-table td {
      vertical-align: middle;
      padding: 14px 8px;
      border-bottom: 1px solid var(--border-light);
      background: transparent;
      color: var(--text-primary);
    }

    .order-table tbody tr:hover {
      background: var(--bg-card-hover);
    }

    /* --- TOTALS SECTION --- */
    .totals-section {
      background: var(--bg-panel-header);
      border-radius: 14px;
      padding: 16px;
      margin-top: 16px;
      border: 1px solid var(--border-color);
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .totals-row:not(:last-child) {
      border-bottom: 1px dashed var(--border-color);
    }

    .totals-row.total {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
      border-bottom: none;
      padding-top: 14px;
      margin-top: 6px;
      border-top: 2px solid var(--border-color);
    }

    /* --- CREATE INVOICE BUTTON --- */
    .btn-create-invoice {
      height: 54px;
      font-weight: 700;
      font-size: 16px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--success), #059669);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.2s ease;
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.4);
    }

    .btn-create-invoice:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
    }

    .btn-create-invoice:disabled {
      background: var(--bg-badge);
      color: var(--text-muted);
      box-shadow: none;
      cursor: not-allowed;
    }

    /* --- STATUS MESSAGES --- */
    .status-msg {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      margin-top: 12px;
    }

    .status-msg.info {
      background: var(--info-light);
      color: var(--info);
    }

    .status-msg.success {
      background: var(--success-light);
      color: var(--success);
    }

    .status-msg.error {
      background: var(--danger-light);
      color: var(--danger);
    }

    .status-msg.warning {
      background: var(--warning-light);
      color: var(--warning);
    }

    /* --- SEARCH & FILTER --- */
    .search-filter-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1;
      min-width: 200px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 0 16px 0 44px;
      font-size: 14px;
      background: var(--bg-input) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E") 14px center / 20px no-repeat;
      transition: all 0.2s ease;
      color: var(--text-primary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .filter-select {
      height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 0 36px 0 14px;
      font-size: 14px;
      background: var(--bg-input);
      color: var(--text-primary);
      min-width: 180px;
    }

    /* --- MODAL STYLING --- */
    .modal-content {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 16px;
    }

    .modal-header {
      background: var(--bg-panel-header);
      border-bottom: 1px solid var(--border-color);
      border-radius: 16px 16px 0 0;
    }

    .modal-title {
      color: var(--text-primary);
      font-weight: 700;
    }

    .modal-body {
      color: var(--text-primary);
    }

    .modal-footer {
      background: var(--bg-panel-header);
      border-top: 1px solid var(--border-color);
    }

    .form-label {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 13px;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 1100px) {
      .order-grid { grid-template-columns: 1fr; }
      .products-grid { grid-template-columns: 1fr; max-height: 300px; }
      .stats-row { flex-wrap: wrap; }
      .stat-card { min-width: 200px; }
    }

    @media (max-width: 768px) {
      .page-wrap { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>

<body>
  <!-- Admin Auth Gate (same pattern as inventory.html) -->
  <div id="loading">Checking access...</div>
  <div id="denied" class="hidden">Access denied</div>

  <div id="admin" class="hidden">
    <header class="py-3">
      <div class="container-fluid px-4 d-flex align-items-center gap-3">
        <div class="text-white fw-bold">Shrinxa Admin</div>

        <!-- IMPORTANT: Clients link is LAST -->
        <div class="d-flex nav-links">
          <a href="./dashboard.html">Dashboard</a>
          <a href="./orders.html">Orders</a>
          <a href="./customers.html">Customers</a>
          <a href="./products-admin.html">Products</a>
          <a href="./platinum.html">Platinum</a>
          <a href="./delivery-admin.html">Delivery Rules</a>
          <a href="./inventory.html">Inventory</a>
          <a href="./income.html">Income</a>
          <a href="./clients.html" style="text-decoration:underline; opacity:1;">Clients</a>
        </div>

        <div class="ms-auto d-flex align-items-center gap-2">
          <span id="adminEmail" class="text-white small"></span>
          <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
        </div>
      </div>
    </header>

    <div class="page-wrap">
      <!-- Page Header -->
      <div class="page-header">
        <div class="page-title-wrap">
          <div class="page-icon">üë•</div>
          <div>
            <h1 class="page-title">Clients</h1>
            <p class="page-subtitle">Create orders and invoices for customers</p>
          </div>
        </div>
        <div class="page-actions">
          <button id="themeToggle" class="theme-toggle" title="Toggle Dark Mode">üåô</button>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-icon customers">üë•</div>
          <div>
            <div class="stat-value" id="statCustomers">0</div>
            <div class="stat-label">Customers</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon products">üì¶</div>
          <div>
            <div class="stat-value" id="statProducts">0</div>
            <div class="stat-label">Products</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orders">üõí</div>
          <div>
            <div class="stat-value" id="statCartItems">0</div>
            <div class="stat-label">Cart Items</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon delivery">üöö</div>
          <div>
            <div class="stat-value" id="statDeliveryFee">$0</div>
            <div class="stat-label">Delivery Fee</div>
          </div>
        </div>
      </div>

      <div class="order-grid">
        <!-- LEFT COLUMN -->
        <div class="d-grid gap-4">
          <!-- Customer Panel -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-hd-icon customer">üë§</div>
              Customer Selection
            </div>
            <div class="panel-bd">
              <div class="d-flex gap-3 align-items-center flex-wrap">
                <select id="clientSelect" class="form-select input-compact" style="min-width: 360px; flex: 1;">
                  <option value="">Select a customer‚Ä¶</option>
                </select>
                <button id="refreshClientsBtn" class="btn btn-primary" style="height: 42px;">
                  üîÑ Refresh
                </button>
                <button id="openCreateClientBtn" class="btn btn-success" style="height: 42px;">
                  ‚ûï New Customer
                </button>
              </div>

              <div id="clientInfo" class="client-info-card" style="display: none;">
                <div class="client-info-row">
                  <span class="client-info-label">ID:</span>
                  <span class="client-info-value" id="clientIdText" style="font-family: monospace; font-size: 11px;">‚Äî</span>
                </div>
                <div class="client-info-row">
                  <span class="client-info-label">Email:</span>
                  <span class="client-info-value" id="clientEmailText">‚Äî</span>
                </div>
                <div class="client-info-row">
                  <span class="client-info-label">Phone:</span>
                  <span class="client-info-value" id="clientPhoneText">‚Äî</span>
                </div>
                <div class="client-info-row">
                  <span class="client-info-label">Address:</span>
                  <span class="client-info-value" id="clientAddressText">‚Äî</span>
                </div>
                <div class="client-info-row">
                  <span class="client-info-label">Tier:</span>
                  <span id="clientTierText" class="tier-badge standard">Standard</span>
                </div>
                <div class="client-info-row">
                  <span class="client-info-label">Wholesale:</span>
                  <span class="client-info-value" id="clientWholesaleText">50+ boxes</span>
                </div>
              </div>

              <!-- Delivery Rule Display -->
              <div id="deliveryRuleCard" class="delivery-rule-card" style="display: none;">
                <div class="delivery-rule-title">üöö Delivery Rule</div>
                <div class="delivery-rule-detail">
                  <span>Orders under</span>
                  <span class="delivery-rule-value" id="ruleThresholdText">$300</span>
                  <span>‚Üí Delivery fee:</span>
                  <span class="delivery-rule-value" id="ruleFeeText">$30</span>
                </div>
                <div class="delivery-rule-detail">
                  <span>Orders</span>
                  <span class="delivery-rule-value" id="ruleFreeText">$300+</span>
                  <span>‚Üí Free delivery</span>
                </div>
              </div>

              <div id="clientStatus" class="status-msg info">
                <span>‚ÑπÔ∏è</span> <span class="status-text">Ready to select a customer.</span>
              </div>
            </div>
          </div>

          <!-- Products Panel -->
          <div class="panel">
            <div class="panel-hd">
              <div class="panel-hd-icon products">üì¶</div>
              Select Products
            </div>
            <div class="panel-bd">
              <div class="search-filter-row">
                <input id="productSearch" class="search-input" placeholder="Search products‚Ä¶">
                <select id="productCategory" class="filter-select">
                  <option value="all">All Categories</option>
                </select>
              </div>

              <div class="mt-3 products-grid" id="productsGrid">
                <!-- Loaded from DB -->
              </div>

              <div id="productsStatus" class="status-msg info mt-3">
                <span>‚è≥</span> <span class="status-text">Loading products‚Ä¶</span>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="panel" style="position: sticky; top: 20px;">
          <div class="panel-hd">
            <div class="panel-hd-icon order">üõí</div>
            Order Builder
          </div>
          <div class="panel-bd">
            <table class="table order-table">
              <thead>
                <tr>
                  <th style="width: 40%;">Product</th>
                  <th style="width: 28%;">Quantity</th>
                  <th style="width: 16%;">Price</th>
                  <th style="width: 16%;">Total</th>
                </tr>
              </thead>
              <tbody id="orderLines">
                <tr><td colspan="4" class="muted text-center py-4">No items selected yet</td></tr>
              </tbody>
            </table>

            <div class="totals-section">
              <div class="totals-row">
                <div>üì¶ Subtotal</div>
                <div id="subTotalText">$0.00</div>
              </div>
              <div class="totals-row">
                <div>üöö Delivery</div>
                <div id="deliveryText">$0.00</div>
              </div>
              <div class="totals-row">
                <div>üßæ Tax (13% HST)</div>
                <div id="taxText">$0.00</div>
              </div>
              <div class="totals-row total">
                <div>üí∞ Total</div>
                <div id="totalText">$0.00</div>
              </div>
            </div>

            <button id="createInvoiceBtn" class="btn btn-create-invoice w-100 mt-4" disabled>
              üìÑ Create Invoice (Unpaid)
            </button>

            <div id="orderStatus" class="status-msg info">
              <span>üëÜ</span> <span class="status-text">Select a customer to begin.</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODALS -->
  <div class="modal fade" id="createClientModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚ûï Create New Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Email <span class="text-danger">*</span></label>
              <input id="newEmail" class="form-control input-compact" placeholder="customer@email.com" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Full Name <span class="text-danger">*</span></label>
              <input id="newFullName" class="form-control input-compact" placeholder="Full name" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Phone <span class="text-danger">*</span></label>
              <input id="newPhone" class="form-control input-compact" placeholder="Phone number" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Address <span class="text-danger">*</span></label>
              <input id="newAddress" class="form-control input-compact" placeholder="Street address" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Company</label>
              <input id="newCompany" class="form-control input-compact" placeholder="Company name" />
            </div>
            <div class="col-md-4">
              <label class="form-label">City</label>
              <input id="newCity" class="form-control input-compact" placeholder="City" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Province</label>
              <input id="newProvince" class="form-control input-compact" placeholder="Province" />
            </div>
          </div>
          <div id="createClientStatus" class="status-msg info mt-3">
            <span>‚ÑπÔ∏è</span> <span class="status-text">Fill required fields then create.</span>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 10px;">Cancel</button>
          <button type="button" class="btn btn-success" id="createClientConfirmBtn" style="border-radius: 10px;">
            ‚úÖ Create Customer
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    import "./admin-auth.js";
    import { supabase } from "../supabaseClient.js";

    // ---------------------------
    // Helpers
    // ---------------------------
    const $ = (id) => document.getElementById(id);

    function money(n) {
      const v = Number(n || 0);
      return new Intl.NumberFormat("en-CA", { style: "currency", currency: "CAD" }).format(v);
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function pickField(obj, keys, fallback = null) {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] !== null && obj[k] !== undefined) return obj[k];
      }
      return fallback;
    }

    function normTier(t) {
      const v = String(t ?? "standard").toLowerCase();
      if (v.includes("platinum")) return "platinum";
      if (v.includes("gold")) return "gold";
      return "standard";
    }

    function setStatus(el, type, text) {
      el.className = `status-msg ${type}`;
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      el.innerHTML = `<span>${icon}</span> <span class="status-text">${text}</span>`;
    }

    // ---------------------------
    // State
    // ---------------------------
    let CLIENTS = [];
    let PRODUCTS = [];
    let SELECTED_CLIENT = null;

    // product_id -> { price, wholesale_price } (for platinum overrides)
    const PLATINUM_OVERRIDES = new Map();

    // cart: productPublicId -> { product, qty }
    const CART = new Map();

    // Delivery Rules
    let DEFAULT_DELIVERY_RULE = { min_subtotal: 300, fee: 30 };
    let CUSTOMER_DELIVERY_RULE = null;

    // ---------------------------
    // Elements
    // ---------------------------
    const clientSelect = $("clientSelect");
    const refreshClientsBtn = $("refreshClientsBtn");
    const clientStatus = $("clientStatus");
    const clientInfo = $("clientInfo");

    const clientIdText = $("clientIdText");
    const clientEmailText = $("clientEmailText");
    const clientPhoneText = $("clientPhoneText");
    const clientAddressText = $("clientAddressText");
    const clientTierText = $("clientTierText");
    const clientWholesaleText = $("clientWholesaleText");

    const deliveryRuleCard = $("deliveryRuleCard");
    const ruleThresholdText = $("ruleThresholdText");
    const ruleFeeText = $("ruleFeeText");
    const ruleFreeText = $("ruleFreeText");

    const productsGrid = $("productsGrid");
    const productsStatus = $("productsStatus");
    const productSearch = $("productSearch");
    const productCategory = $("productCategory");

    const orderLines = $("orderLines");
    const subTotalText = $("subTotalText");
    const deliveryText = $("deliveryText");
    const taxText = $("taxText");
    const totalText = $("totalText");
    const createInvoiceBtn = $("createInvoiceBtn");
    const orderStatus = $("orderStatus");

    const statCustomers = $("statCustomers");
    const statProducts = $("statProducts");
    const statCartItems = $("statCartItems");
    const statDeliveryFee = $("statDeliveryFee");

    // modal
    const openCreateClientBtn = $("openCreateClientBtn");
    const createClientConfirmBtn = $("createClientConfirmBtn");
    const createClientStatus = $("createClientStatus");
    const modalEl = document.getElementById("createClientModal");
    const createClientModal = modalEl ? new bootstrap.Modal(modalEl) : null;

    // theme toggle
    const themeToggle = $("themeToggle");

    // ---------------------------
    // Theme Toggle
    // ---------------------------
    const THEME_KEY = "shrinxa-theme";

    function setTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      if (themeToggle) {
        themeToggle.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      setTheme(current === "dark" ? "light" : "dark");
    }

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved) {
        setTheme(saved);
      } else {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        setTheme(prefersDark ? "dark" : "light");
      }
    }

    themeToggle?.addEventListener("click", toggleTheme);

    // ---------------------------
    // Admin gating: wait until #admin is visible
    // ---------------------------
    async function waitForAdminReady() {
      for (let i = 0; i < 50; i++) {
        const adminWrap = $("admin");
        if (adminWrap && !adminWrap.classList.contains("hidden")) return true;
        await new Promise(r => setTimeout(r, 100));
      }
      return false;
    }

    // ---------------------------
    // Load Default Delivery Rule
    // ---------------------------
    async function loadDefaultDeliveryRule() {
      try {
        const { data, error } = await supabase
          .from("delivery_rules")
          .select("min_subtotal, fee")
          .is("customer_id", null)
          .eq("is_active", true)
          .order("created_at", { ascending: false })
          .limit(1);

        if (!error && data && data.length > 0) {
          DEFAULT_DELIVERY_RULE = {
            min_subtotal: Number(data[0].min_subtotal) || 300,
            fee: Number(data[0].fee) || 30
          };
        }
      } catch (e) {
        console.error("Error loading default delivery rule:", e);
      }
    }

    // ---------------------------
    // Load Customer Delivery Rule
    // ---------------------------
    async function loadCustomerDeliveryRule(customerId) {
      CUSTOMER_DELIVERY_RULE = null;
      
      if (!customerId) return;

      try {
        const { data, error } = await supabase
          .from("delivery_rules")
          .select("min_subtotal, fee")
          .eq("customer_id", customerId)
          .eq("is_active", true)
          .limit(1);

        if (!error && data && data.length > 0) {
          CUSTOMER_DELIVERY_RULE = {
            min_subtotal: Number(data[0].min_subtotal),
            fee: Number(data[0].fee)
          };
        }
      } catch (e) {
        console.error("Error loading customer delivery rule:", e);
      }
    }

    // ---------------------------
    // Get Active Delivery Rule
    // ---------------------------
    function getActiveDeliveryRule() {
      return CUSTOMER_DELIVERY_RULE || DEFAULT_DELIVERY_RULE;
    }

    // ---------------------------
    // Update Delivery Rule Display
    // ---------------------------
    function updateDeliveryRuleDisplay() {
      const rule = getActiveDeliveryRule();
      
      ruleThresholdText.textContent = money(rule.min_subtotal);
      ruleFeeText.textContent = money(rule.fee);
      ruleFreeText.textContent = money(rule.min_subtotal) + "+";
      
      deliveryRuleCard.style.display = SELECTED_CLIENT ? "block" : "none";
    }

    // ---------------------------
    // Calculate Delivery Fee
    // ---------------------------
    function calculateDeliveryFee(subtotal) {
      const rule = getActiveDeliveryRule();
      return subtotal < rule.min_subtotal ? rule.fee : 0;
    }

    // ---------------------------
    // Load Clients
    // ---------------------------
    async function loadClients() {
      if (!clientSelect) return;

      setStatus(clientStatus, 'info', 'Loading customers‚Ä¶');
      clientSelect.innerHTML = `<option value="">Select a customer‚Ä¶</option>`;

      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, full_name, phone, address, city, province, company_name, tier, wholesale_qty_threshold, is_admin")
        .eq("is_admin", false)
        .order("full_name", { ascending: true });

      if (error) {
        setStatus(clientStatus, 'error', 'ERROR: ' + error.message);
        CLIENTS = [];
        return;
      }

      CLIENTS = Array.isArray(data) ? data : [];

      for (const c of CLIENTS) {
        const name = c.full_name || "‚Äî";
        const email = c.email || "‚Äî";
        const phone = c.phone || "";
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = `${name} ‚Äî ${email}${phone ? " ‚Äî " + phone : ""}`;
        clientSelect.appendChild(opt);
      }

      statCustomers.textContent = CLIENTS.length;
      setStatus(clientStatus, 'success', `Loaded ${CLIENTS.length} customers.`);
    }

    function renderClientInfo(client) {
      if (!client) {
        clientInfo.style.display = "none";
        deliveryRuleCard.style.display = "none";
        return;
      }

      clientInfo.style.display = "block";
      clientIdText.textContent = client.id || "‚Äî";
      clientEmailText.textContent = client.email || "‚Äî";
      clientPhoneText.textContent = client.phone || "‚Äî";

      const addrParts = [
        client.address || "",
        client.city || "",
        client.province || ""
      ].filter(Boolean);
      clientAddressText.textContent = addrParts.length ? addrParts.join(", ") : (client.address || "‚Äî");

      const tier = normTier(client.tier || "standard");
      clientTierText.textContent = tier.charAt(0).toUpperCase() + tier.slice(1);
      clientTierText.className = `tier-badge ${tier}`;

      const wholesaleQty = Number(client.wholesale_qty_threshold) || 50;
      clientWholesaleText.textContent = `${wholesaleQty}+ boxes`;

      updateDeliveryRuleDisplay();
    }

    // ---------------------------
    // Load Products
    // ---------------------------
    function normalizeCategoryLabel(cat) {
      const c = String(cat || "").trim();
      if (!c) return "Uncategorized";
      if (/^stretch wrap$/i.test(c)) return "Stretch Wrap";
      if (/^pre-?stretch wrap$/i.test(c)) return "Pre-Stretch Wrap";
      if (/^tape rolls$/i.test(c)) return "Tape Rolls";
      return c;
    }

    async function loadProducts() {
      setStatus(productsStatus, 'info', 'Loading products‚Ä¶');
      productsGrid.innerHTML = "";

      const { data, error } = await supabase
        .from("products")
        .select("*")
        .order("sort_order", { ascending: true });

      if (error) {
        setStatus(productsStatus, 'error', 'ERROR: ' + error.message);
        PRODUCTS = [];
        return;
      }

      const rows = Array.isArray(data) ? data : [];
      PRODUCTS = rows.filter(r => {
        const v = (r?.is_active ?? r?.active);
        if (v === null || v === undefined) return true;
        return v === true;
      });

      // categories dropdown
      const cats = new Set();
      for (const p of PRODUCTS) cats.add(normalizeCategoryLabel(p.category || p.type || p.product_type));
      const sortedCats = Array.from(cats).sort((a,b)=>a.localeCompare(b));
      productCategory.innerHTML = `<option value="all">All Categories</option>` + sortedCats.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");

      statProducts.textContent = PRODUCTS.length;
      setStatus(productsStatus, 'success', `Loaded ${PRODUCTS.length} products.`);
      renderProductsGrid();
    }

    function productToViewModel(r) {
      const publicId = String(pickField(r, ["public_id", "publicId", "slug", "id"], "") || "");
      const name = String(pickField(r, ["name", "product_name", "title"], "") || "");
      const category = normalizeCategoryLabel(pickField(r, ["category", "type", "product_type"], ""));
      const stock = Number(pickField(r, ["stock_on_hand", "stock", "qty_on_hand", "quantity_on_hand"], 0)) || 0;

      const retailStd = Number(pickField(r, ["retail_price", "std_retail", "price_retail"], 0)) || 0;
      const wholesaleStd = Number(pickField(r, ["wholesale_price", "std_wholesale", "price_wholesale"], 0)) || 0;

      const retailGold = Number(pickField(r, ["gold_retail_price", "retail_gold", "gold_retail"], retailStd)) || retailStd;
      const wholesaleGold = Number(pickField(r, ["gold_wholesale_price", "wholesale_gold", "gold_wholesale"], wholesaleStd)) || wholesaleStd;

      return { publicId, name, category, stock, retailStd, wholesaleStd, retailGold, wholesaleGold, raw: r };
    }

    function getWholesaleThresholdForClient() {
      const n = Number(SELECTED_CLIENT?.wholesale_qty_threshold);
      return Number.isFinite(n) && n > 0 ? n : 50;
    }

    function tierForPricing() {
      const t = normTier(SELECTED_CLIENT?.tier || "standard");
      return (t === "gold" || t === "platinum") ? "gold" : "standard";
    }

    function getTieredPricesForProduct(vm) {
      const t = normTier(SELECTED_CLIENT?.tier || "standard");
      const base = tierForPricing();

      const retail = base === "gold" ? vm.retailGold : vm.retailStd;
      const wholesale = base === "gold" ? vm.wholesaleGold : vm.wholesaleStd;

      if (t === "platinum") {
        const ov = PLATINUM_OVERRIDES.get(vm.publicId);
        if (ov) {
          return {
            retail: (ov.price ?? retail),
            wholesale: (ov.wholesale_price ?? wholesale),
          };
        }
      }

      return { retail, wholesale };
    }

    function priceForQty(vm, qty) {
      const threshold = getWholesaleThresholdForClient();
      const prices = getTieredPricesForProduct(vm);
      return (qty >= threshold) ? prices.wholesale : prices.retail;
    }

    function renderProductsGrid() {
      const q = (productSearch.value || "").trim().toLowerCase();
      const cat = (productCategory.value || "all");

      const filtered = PRODUCTS
        .map(productToViewModel)
        .filter(vm => {
          if (!vm.publicId || !vm.name) return false;
          if (cat !== "all" && vm.category !== cat) return false;
          if (q && !vm.name.toLowerCase().includes(q)) return false;
          return true;
        });

      productsGrid.innerHTML = filtered.map(vm => {
        const out = vm.stock <= 0;
        const low = vm.stock > 0 && vm.stock <= 5;
        const badgeClass = out ? "badge-out" : (low ? "badge-low" : "in-stock");
        const badgeText = out ? "Out of stock" : (low ? `Low: ${vm.stock}` : `Stock: ${vm.stock}`);

        const p = priceForQty(vm, 1);

        return `
          <div class="prod-card" data-pid="${escapeHtml(vm.publicId)}">
            <div>
              <div class="prod-name">${escapeHtml(vm.name)}</div>
              <div class="prod-price">${money(p)}<span class="muted" style="font-size: 12px; font-weight: 400;"> / box</span></div>
              <div class="mt-2"><span class="badge-stock ${badgeClass}">${escapeHtml(badgeText)}</span></div>
            </div>
            <button class="btn-add-prod" ${out ? "disabled" : ""}>+</button>
          </div>
        `;
      }).join("");

      // wire add buttons
      productsGrid.querySelectorAll(".btn-add-prod").forEach(btn => {
        btn.addEventListener("click", () => {
          const card = btn.closest(".prod-card");
          const pid = card?.getAttribute("data-pid") || "";
          const vm = productToViewModel(PRODUCTS.find(r => String(pickField(r, ["public_id", "publicId", "slug", "id"], "")) === pid));
          if (!vm?.publicId) return;

          addToCart(vm, 1);
        });
      });
    }

    // ---------------------------
    // Cart / Order Builder
    // ---------------------------
    function addToCart(vm, addQty) {
      if (!SELECTED_CLIENT) {
        setStatus(orderStatus, 'warning', 'Select a customer first.');
        return;
      }

      const existing = CART.get(vm.publicId);
      const curQty = existing ? existing.qty : 0;
      const nextQty = curQty + addQty;

      if (nextQty > vm.stock) {
        setStatus(orderStatus, 'error', `Cannot exceed stock. Available: ${vm.stock}`);
        return;
      }

      CART.set(vm.publicId, { product: vm, qty: nextQty });
      renderOrder();
    }

    function setCartQty(pid, qty) {
      const entry = CART.get(pid);
      if (!entry) return;

      const q = Math.max(1, parseInt(String(qty || "1"), 10) || 1);
      if (q > entry.product.stock) {
        setStatus(orderStatus, 'error', `Cannot exceed stock. Available: ${entry.product.stock}`);
        return;
      }
      entry.qty = q;
      CART.set(pid, entry);
      renderOrder();
    }

    function removeFromCart(pid) {
      CART.delete(pid);
      renderOrder();
    }

    function computeTotals() {
      let sub = 0;
      for (const { product, qty } of CART.values()) {
        const unit = priceForQty(product, qty);
        sub += unit * qty;
      }
      const del = calculateDeliveryFee(sub);
      const tax = (sub + del) * 0.13;
      const total = sub + del + tax;
      return { sub, del, tax, total };
    }

    function renderOrder() {
      const items = Array.from(CART.values());

      // Update stats
      statCartItems.textContent = items.reduce((sum, i) => sum + i.qty, 0);

      if (!items.length) {
        orderLines.innerHTML = `<tr><td colspan="4" class="muted text-center py-4">No items selected yet</td></tr>`;
      } else {
        orderLines.innerHTML = items.map(({ product, qty }) => {
          const unit = priceForQty(product, qty);
          const lineTotal = unit * qty;

          return `
            <tr data-pid="${escapeHtml(product.publicId)}">
              <td>
                <div class="fw-bold" style="font-size: 13px;">${escapeHtml(product.name)}</div>
                <div class="muted mini">Stock: ${product.stock}</div>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <button class="qty-btn btn-dec" type="button">‚àí</button>
                  <input class="qty-box qty-input" value="${qty}" />
                  <button class="qty-btn btn-inc" type="button">+</button>
                </div>
                <button class="btn btn-sm btn-outline-danger btn-remove mt-1" type="button" style="font-size: 11px; border-radius: 6px;">Remove</button>
              </td>
              <td class="fw-semibold">${money(unit)}</td>
              <td class="fw-bold" style="color: var(--primary);">${money(lineTotal)}</td>
            </tr>
          `;
        }).join("");

        // wire qty controls
        orderLines.querySelectorAll("tr[data-pid]").forEach(tr => {
          const pid = tr.getAttribute("data-pid");
          const entry = CART.get(pid);
          if (!entry) return;

          tr.querySelector(".btn-dec")?.addEventListener("click", () => {
            const next = Math.max(1, entry.qty - 1);
            setCartQty(pid, next);
          });

          tr.querySelector(".btn-inc")?.addEventListener("click", () => {
            const next = entry.qty + 1;
            setCartQty(pid, next);
          });

          tr.querySelector(".btn-remove")?.addEventListener("click", () => removeFromCart(pid));

          tr.querySelector(".qty-input")?.addEventListener("change", (e) => {
            setCartQty(pid, e.target.value);
          });
        });
      }

      const { sub, del, tax, total } = computeTotals();
      subTotalText.textContent = money(sub);
      
      if (del > 0) {
        deliveryText.textContent = money(del);
        deliveryText.style.color = "inherit";
        deliveryText.style.fontWeight = "400";
      } else {
        deliveryText.textContent = "FREE";
        deliveryText.style.color = "var(--success)";
        deliveryText.style.fontWeight = "700";
      }
      
      taxText.textContent = money(tax);
      totalText.textContent = money(total);

      // Update delivery stat
      statDeliveryFee.textContent = del > 0 ? money(del) : "FREE";

      // enable invoice only if customer selected and cart not empty
      const enable = !!SELECTED_CLIENT && CART.size > 0;
      createInvoiceBtn.disabled = !enable;

      if (enable) {
        setStatus(orderStatus, 'success', 'Ready to create invoice.');
      } else if (!SELECTED_CLIENT) {
        setStatus(orderStatus, 'info', 'Select a customer to begin.');
      } else {
        setStatus(orderStatus, 'info', 'Add products to the order.');
      }

      renderProductsGrid();
    }

    // ---------------------------
    // Platinum overrides (optional)
    // ---------------------------
    async function loadPlatinumOverrides(customerId) {
      PLATINUM_OVERRIDES.clear();
      const tier = normTier(SELECTED_CLIENT?.tier || "standard");
      if (tier !== "platinum") return;

      try {
        const { data, error } = await supabase
          .from("platinum_prices")
          .select("retail_price, wholesale_price, products!inner(public_id)")
          .eq("customer_id", customerId);

        if (error || !Array.isArray(data)) return;

        for (const row of data) {
          const key = row.products?.public_id;
          if (!key) continue;

          const retail = Number(row.retail_price);
          const wholesale = Number(row.wholesale_price);

          PLATINUM_OVERRIDES.set(String(key), {
            price: Number.isFinite(retail) ? retail : null,
            wholesale_price: Number.isFinite(wholesale) ? wholesale : null
          });
        }
      } catch (_) {}
    }

    // ---------------------------
    // Create Customer (Silent)
    // ---------------------------
    function validateNewCustomerForm() {
      const email = ($("newEmail")?.value || "").trim();
      const full_name = ($("newFullName")?.value || "").trim();
      const phone = ($("newPhone")?.value || "").trim();
      const address = ($("newAddress")?.value || "").trim();
      return { ok: !!(email && full_name && phone && address), email, full_name, phone, address };
    }

    async function createCustomerSilent() {
      const v = validateNewCustomerForm();
      if (!v.ok) {
        setStatus(createClientStatus, 'error', 'Email, Full name, Phone, Address are required.');
        return;
      }

      const payload = {
        email: v.email,
        full_name: v.full_name,
        phone: v.phone,
        address: v.address,
        company_name: ($("newCompany")?.value || "").trim() || null,
        city: ($("newCity")?.value || "").trim() || null,
        province: ($("newProvince")?.value || "").trim() || null,
      };

      createClientConfirmBtn.disabled = true;
      setStatus(createClientStatus, 'info', 'Creating customer‚Ä¶');

      const { data, error } = await supabase.functions.invoke("admin-create-customer-silent", { body: payload });

      createClientConfirmBtn.disabled = false;

      if (error || !data?.ok) {
        setStatus(createClientStatus, 'error', (data?.error || error?.message || "Failed"));
        return;
      }

      setStatus(createClientStatus, 'success', 'Customer created! Refreshing list‚Ä¶');
      await loadClients();

      const newId = data.customer_id || data.id;
      if (newId) {
        clientSelect.value = newId;
        onClientChange();
      }

      createClientModal?.hide();
    }

    // ---------------------------
    // Create Invoice (Unpaid)
    // ---------------------------
    async function createInvoiceUnpaid() {
      if (!SELECTED_CLIENT) { setStatus(orderStatus, 'warning', 'Select a customer.'); return; }
      if (!CART.size) { setStatus(orderStatus, 'warning', 'Add items first.'); return; }

      createInvoiceBtn.disabled = true;
      setStatus(orderStatus, 'info', 'Creating invoice‚Ä¶');

      const items = Array.from(CART.values()).map(({ product, qty }) => {
        const unit = priceForQty(product, qty);
        return {
          product_id: product.publicId,
          qty,
          unit_price: unit
        };
      });

      const { sub } = computeTotals();
      const del = calculateDeliveryFee(sub);

      const { data, error } = await supabase.functions.invoke("admin-create-invoice-unpaid", {
        body: {
          customer_id: SELECTED_CLIENT.id,
          delivery_fee: del,
          items
        }
      });

      createInvoiceBtn.disabled = false;

      if (error || !data?.ok) {
        setStatus(orderStatus, 'error', (data?.error || error?.message || "Failed"));
        return;
      }

      CART.clear();
      renderOrder();

      setStatus(orderStatus, 'success', `Invoice created! ${data.invoice_number ? "(" + data.invoice_number + ")" : ""}`);
    }

    // ---------------------------
    // Events
    // ---------------------------
    async function onClientChange() {
      const id = clientSelect.value || "";
      SELECTED_CLIENT = CLIENTS.find(c => c.id === id) || null;

      CART.clear();

      if (!SELECTED_CLIENT) {
        renderClientInfo(null);
        setStatus(orderStatus, 'info', 'Select a customer to begin.');
        createInvoiceBtn.disabled = true;
        renderOrder();
        return;
      }

      setStatus(orderStatus, 'info', 'Loading customer data‚Ä¶');

      // Load customer-specific delivery rule
      await loadCustomerDeliveryRule(SELECTED_CLIENT.id);

      renderClientInfo(SELECTED_CLIENT);

      await loadPlatinumOverrides(SELECTED_CLIENT.id);

      setStatus(orderStatus, 'success', 'Customer selected. Add items.');
      renderOrder();
    }

    refreshClientsBtn?.addEventListener("click", loadClients);
    clientSelect?.addEventListener("change", onClientChange);

    productSearch?.addEventListener("input", renderProductsGrid);
    productCategory?.addEventListener("change", renderProductsGrid);

    openCreateClientBtn?.addEventListener("click", () => {
      setStatus(createClientStatus, 'info', 'Fill required fields then create.');
      createClientModal?.show();
    });

    createClientConfirmBtn?.addEventListener("click", createCustomerSilent);

    createInvoiceBtn?.addEventListener("click", createInvoiceUnpaid);

    // ---------------------------
    // Init
    // ---------------------------
    (async () => {
      // Initialize theme first
      initTheme();

      const ok = await waitForAdminReady();
      if (!ok) return;

      // Load default delivery rule
      await loadDefaultDeliveryRule();

      await loadClients();
      await loadProducts();
      renderOrder();
    })();
  </script>
</body>
</html>
