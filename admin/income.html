<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin – Income</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; margin: 0; }
    .wrap { max-width: 100%; padding: 18px; }
    .status { padding:8px 10px; border:1px solid #ccc; display:inline-block; }
    .controls { display:flex; gap:10px; align-items:end; flex-wrap:wrap; margin-top:10px; }
    label { font-size: 12px; color:#333; display:flex; flex-direction:column; gap:4px; }
    input, select, textarea { padding:6px 8px; border:1px solid #bbb; border-radius:6px; min-width: 170px; }
    textarea { min-width: 260px; }
    button { padding:7px 10px; border:1px solid #888; border-radius:8px; background:#f6f6f6; cursor:pointer; }
    button:hover { background:#efefef; }
    .grid { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:12px; margin-top:14px; }
    .card { border:1px solid #e3e3e3; border-radius:14px; padding:12px; background:#fff; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .k { color:#666; font-size:12px; }
    .v { font-size:22px; font-weight:700; margin-top:6px; }
    .muted { color:#666; font-size:12px; }
    .row { display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; margin-top:12px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 2; }
    .right { text-align:right; white-space:nowrap; }
    header { background:#111; }
    header a { color:#fff; text-decoration:none; opacity:.9; }
    header a:hover { opacity:1; text-decoration:underline; }
    .nav-links { gap:14px; flex-wrap:wrap; }
    .btnrow { display:flex; gap:8px; flex-wrap:wrap; }
    @media (max-width: 1100px) { .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html" style="text-decoration:underline; opacity:1;">Income</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <h2>Income</h2>
  <div class="status" id="status">Loading…</div>

  <div class="controls">
    <label>
      Preset
      <select id="range">
        <option value="month" selected>This month</option>
        <option value="today">Today</option>
        <option value="week">This week</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="year">This year</option>
      </select>
    </label>

    <label>
      Date from
      <input id="from" type="date">
    </label>

    <label>
      Date to
      <input id="to" type="date">
    </label>

    <label>
      Currency
      <select id="currency">
        <option value="">All</option>
        <option value="CAD" selected>CAD</option>
        <option value="USD">USD</option>
      </select>
    </label>

    <div class="btnrow">
      <button id="btnReload" type="button">Reload</button>
      <button id="btnExportExpenses" type="button">Export Expenses CSV</button>
      <button id="btnExportMonthlyWide" type="button">Export Monthly Breakdown CSV</button>
	<button id="btnExportMonthlyByCat" type="button">Export Monthly Expenses by Category CSV</button>
	<button id="btnExportYearlyWide" type="button">Export Yearly Breakdown CSV</button>

    </div>
  </div>

  <div class="grid">
	<div class="card">
  <div class="k">Revenue</div>
  <div class="v" id="kpiRevenue">—</div>
</div>

<div class="card">
  <div class="k">COGS</div>
  <div class="v" id="kpiCOGS">—</div>
</div>
    <div class="card">
      <div class="k">Invoice Profit (range)</div>
      <div class="v" id="kpiInvoiceProfit">—</div>
      <div class="muted" id="kpiCurrency1"></div>
    </div>
    <div class="card">
    <div class="k">Delivery Income</div>
      <div class="v" id="kpiDeliveryIncome">—</div>
    </div>
    <div class="card">
      <div class="k">Total Expenses</div>
      <div class="v" id="kpiExpenses">—</div>
    </div>
    <div class="card">
      <div class="k">Net Profit</div>
      <div class="v" id="kpiNetProfit">—</div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="k">Add / Edit Expense</div>
      <div class="muted">Admin-only</div>

      <div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:10px;">
        <input type="hidden" id="expId">

        <label>
          Date
          <input id="expDate" type="date">
        </label>

        <label>
          Category
         <select id="expCategory"></select>
        </label>

<label>
  New Category
  <input id="newCategoryName" type="text" placeholder="e.g. parking">
</label>

<div style="display:flex; gap:10px; align-items:end;">
  <button id="btnAddCategory" type="button" style="flex:1;">Add Category</button>
  <button id="btnDeleteCategory" type="button" style="flex:1; border-color:#c33;">Delete Category</button>
</div>

        <label>
          Amount
          <input id="expAmount" type="number" step="0.01" min="0" placeholder="0.00">
        </label>

        <label>
          Currency
          <select id="expCurrency">
            <option value="CAD" selected>CAD</option>
            <option value="USD">USD</option>
          </select>
        </label>

        <label>
          Vendor (optional)
          <input id="expVendor" type="text" placeholder="e.g., Shell, Rogers, Landlord">
        </label>

        <label>
          Receipt URL (optional)
          <input id="expReceipt" type="text" placeholder="https://...">
        </label>

        <label style="grid-column: 1 / -1;">
          Notes (optional)
          <textarea id="expNotes" rows="3" placeholder="Short note..."></textarea>
        </label>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button id="btnSaveExpense" type="button">Save</button>
        <button id="btnClearExpense" type="button">Clear</button>
        <button id="btnDeleteExpense" type="button" style="border-color:#c33;">Delete</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Tip: click a row in the expense list to edit it.
      </div>
    </div>

    <div class="card">
      <div class="k">Monthly Summary</div>
      <div class="muted">From v_monthly_financials</div>
      <div style="overflow:auto; max-height: 420px; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Month</th>
             <th class="right">Revenue</th>
<th class="right">COGS</th>
<th class="right">Invoice Profit</th>
<th class="right">Delivery Income</th>
<th class="right">Expenses</th>
<th class="right">Net Profit</th>

            </tr>
          </thead>
          <tbody id="monthlyTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <div class="card">
      <div class="k">Expenses (range)</div>
      <div class="muted">Click row to edit</div>
      <div style="overflow:auto; max-height: 420px; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Vendor</th>
              <th>Notes</th>
              <th class="right">Amount</th>
              <th class="right">Currency</th>
            </tr>
          </thead>
          <tbody id="expensesTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="k">Yearly Summary</div>
      <div class="muted">From v_yearly_financials</div>
      <div style="overflow:auto; max-height: 420px; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Year</th>
           <th class="right">Revenue</th>
<th class="right">COGS</th>
<th class="right">Invoice Profit</th>
<th class="right">Delivery Income</th>
<th class="right">Expenses</th>
<th class="right">Net Profit</th>

            </tr>
          </thead>
          <tbody id="yearlyTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script type="module">
  import { supabase } from "../supabaseClient.js";

  const statusEl = document.getElementById("status");
  const adminEmailEl = document.getElementById("adminEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const rangeEl = document.getElementById("range");
  const fromEl = document.getElementById("from");
  const toEl = document.getElementById("to");
  const currencyEl = document.getElementById("currency");
const deliveryField = "delivery";
  const btnReload = document.getElementById("btnReload");
  const btnExportExpenses = document.getElementById("btnExportExpenses");
const btnExportMonthlyWide = document.getElementById("btnExportMonthlyWide");
const btnExportMonthlyByCat = document.getElementById("btnExportMonthlyByCat");
const btnExportYearlyWide = document.getElementById("btnExportYearlyWide");

 
  const kpiInvoiceProfit = document.getElementById("kpiInvoiceProfit");
  const kpiRevenue = document.getElementById("kpiRevenue");
  const kpiCOGS = document.getElementById("kpiCOGS");
  const kpiDeliveryIncome = document.getElementById("kpiDeliveryIncome");
  const kpiExpenses = document.getElementById("kpiExpenses");
  const kpiNetProfit = document.getElementById("kpiNetProfit");
  const kpiCurrency1 = document.getElementById("kpiCurrency1");

  const monthlyTbody = document.getElementById("monthlyTbody");
  const yearlyTbody = document.getElementById("yearlyTbody");
  const expensesTbody = document.getElementById("expensesTbody");

  const expId = document.getElementById("expId");
  const expDate = document.getElementById("expDate");
  const expCategory = document.getElementById("expCategory");
  const expAmount = document.getElementById("expAmount");
  const expCurrency = document.getElementById("expCurrency");
  const expVendor = document.getElementById("expVendor");
  const expReceipt = document.getElementById("expReceipt");
  const expNotes = document.getElementById("expNotes");

  const btnSaveExpense = document.getElementById("btnSaveExpense");
  const btnClearExpense = document.getElementById("btnClearExpense");
  const btnDeleteExpense = document.getElementById("btnDeleteExpense");

const newCategoryName = document.getElementById("newCategoryName");
const btnAddCategory = document.getElementById("btnAddCategory");
const btnDeleteCategory = document.getElementById("btnDeleteCategory");


btnAddCategory.addEventListener("click", async () => {
  const name = (newCategoryName.value || "").trim();
  if (!name) return;

  try {
    show("Adding category…");

    const { error } = await supabase
      .from("expense_categories")
      .insert({ name });

    if (error) throw error;

    newCategoryName.value = "";
    await loadExpenseCategories();
    show("Category added ✅");
  } catch (e) {
    console.error(e);
    show("ERROR: " + (e?.message || String(e)));
  }
});

btnDeleteCategory.addEventListener("click", async () => {
  const name = (expCategory.value || "").trim();
  if (!name) return;

  try {
    show("Deleting category…");

    const { error } = await supabase
      .from("expense_categories")
      .delete()
      .eq("name", name);

    if (error) throw error;

    await loadExpenseCategories();
    show("Category deleted ✅");
  } catch (e) {
    console.error(e);
    show("ERROR: " + (e?.message || String(e)));
  }
});


  let lastExpenses = [];
  let lastMonthly = [];
let lastMonthlyByCat = [];
let lastYearly = [];



  function show(msg) { statusEl.textContent = msg; }

  function money(v) {
    const n = Number(v);
    if (!Number.isFinite(n)) return "0.00";
    return n.toFixed(2);
  }

  function toISODate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setPreset(preset) {
    const now = new Date();
    const start = new Date(now);
    const end = new Date(now);

    if (preset === "today") {
      // same day
    } else if (preset === "week") {
      const day = now.getDay();
      start.setDate(now.getDate() - day);
    } else if (preset === "month") {
      start.setDate(1);
    } else if (preset === "year") {
      start.setMonth(0, 1);
    } else {
      const days = Number(preset || 30);
      start.setDate(now.getDate() - (days - 1));
    }

    start.setHours(0,0,0,0);
    end.setHours(23,59,59,999);

    fromEl.value = toISODate(start);
    toEl.value = toISODate(end);
  }

  async function requireAdmin() {
    show("Checking login…");
    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr) throw new Error("getUser error: " + userErr.message);
    if (!user) { location.href = "../login.html"; return null; }

    if (adminEmailEl) adminEmailEl.textContent = user.email || "";

    show("Checking admin…");
    const { data: me, error: meErr } = await supabase
      .from("profiles")
      .select("is_admin")
      .eq("id", user.id)
      .single();

    if (meErr) throw new Error("profiles check error: " + meErr.message);
    if (!me?.is_admin) throw new Error("Access denied (not admin)");
    return user;
  }

  logoutBtn?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "../login.html";
  });

  function downloadCsv(filename, rows) {
    const esc = (v) => {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
      return s;
    };
    const csv = rows.map(r => r.map(esc).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearForm() {
    expId.value = "";
    expDate.value = toISODate(new Date());
    expCategory.value = "other";
    expAmount.value = "";
    expCurrency.value = "CAD";
    expVendor.value = "";
    expReceipt.value = "";
    expNotes.value = "";
  }
async function loadExpenseCategories() {
  const sel = document.getElementById("expCategory");
  if (!sel) return;

  const { data, error } = await supabase
    .from("expense_categories")
    .select("name")
    .order("name", { ascending: true });

  if (error) throw error;

  sel.innerHTML = "";
  for (const r of (data || [])) {
    const opt = document.createElement("option");
    opt.value = r.name;
    opt.textContent = r.name;
    sel.appendChild(opt);
  }
}

  async function loadExpensesRange(startDate, endDate, curr) {
    let q = supabase
      .from("expenses")
      .select("id, expense_date, category, amount, currency, vendor, notes, receipt_url, created_at")
      .gte("expense_date", startDate)
      .lte("expense_date", endDate)
      .order("expense_date", { ascending: false })
      .limit(2000);

    if (curr) q = q.eq("currency", curr);

    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  async function loadMonthly(curr) {
    let q = supabase
      .from("v_monthly_financials")
      .select("month_start, currency, invoice_profit, delivery_income, expenses_total, net_profit")
      .order("month_start", { ascending: false })
      .limit(240);

    if (curr) q = q.eq("currency", curr);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }
async function loadMonthlyByCategory(curr) {
  let q = supabase
    .from("v_monthly_expenses_by_category")
    .select("month_start, currency, category, amount")
    .order("month_start", { ascending: false })
    .limit(5000);

  if (curr) q = q.eq("currency", curr);

  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

  async function loadYearly(curr) {
    let q = supabase
      .from("v_yearly_financials")
      .select("year_start, currency, invoice_profit, delivery_income, expenses_total, net_profit")
      .order("year_start", { ascending: false })
      .limit(25);

    if (curr) q = q.eq("currency", curr);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  function inRange(d, from, to) {
    const x = new Date(d + "T00:00:00");
    return x >= from && x <= to;
  }

  function renderExpenses(rows) {
    expensesTbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.dataset.id = r.id;
      tr.innerHTML = `
        <td>${r.expense_date || ""}</td>
        <td>${r.category || ""}</td>
        <td>${r.vendor || ""}</td>
        <td>${r.notes || ""}</td>
        <td class="right">${money(r.amount)}</td>
        <td class="right">${r.currency || ""}</td>
      `;
      expensesTbody.appendChild(tr);
    }
  }

  function renderMonthly(rows, fromDate, toDate) {
    monthlyTbody.innerHTML = "";
    for (const r of rows) {
      // monthly view is month_start; we show all months but highlight those inside chosen range
      const tr = document.createElement("tr");
     tr.innerHTML = `
  <td>${r.month_start}</td>
  <td class="right">${money(r.invoice_profit + r.delivery_income)}</td>
  <td class="right">${money((r.invoice_profit + r.delivery_income) - r.invoice_profit)}</td>
  <td class="right">${money(r.invoice_profit)}</td>
  <td class="right">${money(r.delivery_income)}</td>
  <td class="right">${money(r.expenses_total)}</td>
  <td class="right">${money(r.net_profit)}</td>
`;

      monthlyTbody.appendChild(tr);
    }
  }

  function renderYearly(rows) {
    yearlyTbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
         <td>${r.year_start}</td>
  <td class="right">${money(r.invoice_profit + r.delivery_income)}</td>
  <td class="right">${money((r.invoice_profit + r.delivery_income) - r.invoice_profit)}</td>
  <td class="right">${money(r.invoice_profit)}</td>
  <td class="right">${money(r.delivery_income)}</td>
  <td class="right">${money(r.expenses_total)}</td>
  <td class="right">${money(r.net_profit)}</td>
`;
      yearlyTbody.appendChild(tr);
    }
  }

  function calcRangeKPIs(monthlyRows, expenseRows, from, to) {
    // KPI range computed from raw expenses in date range + invoices from invoices table
    // For profit + delivery, we query invoices directly for exact range.
  }

    async function fetchInvoiceProfitAndDelivery(startISO, endISO, curr) {
    let q = supabase
      .from("invoices")
     .select(`invoice_profit, ${deliveryField}, currency, created_at`)
	      .eq("status", "paid")
      .gte("created_at", startISO)
      .lte("created_at", endISO)
      .limit(5000);


    if (curr) q = q.eq("currency", curr);

    const { data, error } = await q;
    if (error) throw error;

	    let invProfit = 0;
    let deliveryIncome = 0;

    for (const r of (data || [])) {
      invProfit += Number(r.invoice_profit ?? 0);
      deliveryIncome += Number(r[deliveryField] ?? 0);
    }


    return { invProfit, deliveryIncome };
  }

  async function loadAll() {
    show("Loading…");
    const curr = (currencyEl.value || "").trim();

    const from = new Date((fromEl.value || "") + "T00:00:00");
    const to = new Date((toEl.value || "") + "T23:59:59");

    const startISO = from.toISOString();
    const endISO = to.toISOString();

    monthlyTbody.innerHTML = "";
    yearlyTbody.innerHTML = "";
    expensesTbody.innerHTML = "";

    try {
         const [monthly, monthlyByCat, yearly, expenses, invAgg] = await Promise.all([
        loadMonthly(curr),
        loadMonthlyByCategory(curr),
        loadYearly(curr),
        loadExpensesRange(fromEl.value, toEl.value, curr),
        fetchInvoiceProfitAndDelivery(startISO, endISO, curr),
      ]);


      lastMonthly = monthly;
      lastMonthlyByCat = monthlyByCat;
      lastYearly = yearly;
      lastExpenses = expenses;


      renderMonthly(monthly, from, to);
      renderYearly(yearly);
      renderExpenses(expenses);

      const expenseTotal = expenses.reduce((s, r) => s + Number(r.amount ?? 0), 0);

     const revenue = invAgg.invProfit + invAgg.deliveryIncome;
const cogs = revenue - invAgg.invProfit;

kpiRevenue.textContent = money(revenue);
kpiCOGS.textContent = money(cogs);
kpiInvoiceProfit.textContent = money(invAgg.invProfit);
kpiDeliveryIncome.textContent = money(invAgg.deliveryIncome);
kpiExpenses.textContent = money(expenseTotal);
kpiNetProfit.textContent = money(revenue - expenseTotal);
      kpiCurrency1.textContent = curr ? curr : "All currencies";

      show("Done ✅");
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  }

  expensesTbody.addEventListener("click", (e) => {
    const tr = e.target?.closest?.("tr");
    if (!tr) return;
    const id = tr.dataset.id;
    const r = (lastExpenses || []).find(x => x.id === id);
    if (!r) return;

    expId.value = r.id;
    expDate.value = r.expense_date || toISODate(new Date());
    expCategory.value = r.category || "other";
    expAmount.value = Number(r.amount ?? 0);
    expCurrency.value = r.currency || "CAD";
    expVendor.value = r.vendor || "";
    expReceipt.value = r.receipt_url || "";
    expNotes.value = r.notes || "";
  });

  btnClearExpense.addEventListener("click", () => clearForm());

  btnSaveExpense.addEventListener("click", async () => {
    const payload = {
      expense_date: expDate.value || toISODate(new Date()),
      category: expCategory.value,
      amount: Number(expAmount.value || 0),
      currency: expCurrency.value,
      vendor: (expVendor.value || "").trim() || null,
      receipt_url: (expReceipt.value || "").trim() || null,
      notes: (expNotes.value || "").trim() || null,
    };

    try {
      show("Saving…");
      const id = (expId.value || "").trim();

      if (id) {
        const { error } = await supabase.from("expenses").update(payload).eq("id", id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("expenses").insert(payload);
        if (error) throw error;
      }

      clearForm();
      await loadAll();
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  });

  btnDeleteExpense.addEventListener("click", async () => {
    const id = (expId.value || "").trim();
    if (!id) { show("Select an expense row first."); return; }

    try {
      show("Deleting…");
      const { error } = await supabase.from("expenses").delete().eq("id", id);
      if (error) throw error;

      clearForm();
      await loadAll();
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  });

  btnReload.addEventListener("click", loadAll);

  btnExportExpenses.addEventListener("click", () => {
    const rows = [["expense_date","category","vendor","notes","amount","currency","receipt_url"]];
    for (const r of (lastExpenses || [])) {
      rows.push([
        r.expense_date || "",
        r.category || "",
        r.vendor || "",
        r.notes || "",
        money(r.amount),
        r.currency || "",
        r.receipt_url || ""
      ]);
    }
    downloadCsv("expenses.csv", rows);
  });


  rangeEl.addEventListener("change", () => {
    setPreset(rangeEl.value);
    loadAll();
  });

(async () => {
  await requireAdmin();
  setPreset(rangeEl.value);
  clearForm();
  await loadExpenseCategories();
  await loadAll();
})();

/* ===============================
   EXPORT: MONTHLY EXPENSES (BY CATEGORY)
   =============================== */
document.getElementById("btnExportMonthlyByCat").addEventListener("click", () => {
  const rows = [
    ["month_start","currency","category","amount"]
  ];

  (lastMonthlyByCat || []).forEach(r => {
    rows.push([
      r.month_start,
      r.currency,
      r.category,
      Number(r.amount || 0).toFixed(2)
    ]);
  });

  downloadCsv("monthly_expenses_by_category.csv", rows);
});


/* ===============================
   EXPORT: MONTHLY FULL FINANCIALS
   =============================== */

document.getElementById("btnExportMonthlyWide").addEventListener("click", () => {
  const CATS = [
    "rent","gas","utilities","phones","maintenance","media_ads",
    "gifts","commissions","bills","insurance","vehicle_payments","other"
  ];

const header = [
  "month","currency",
  "revenue","cogs",
  "invoice_profit","delivery_income",
  "expenses","net_profit",
  ...CATS
];

  const rows = [header];
  const map = {};

  (lastMonthly || []).forEach(m => {
    const key = m.month_start + m.currency;
    map[key] = {
      month: m.month_start,
      currency: m.currency,
      invoice_profit: Number(m.invoice_profit || 0),
      delivery_income: Number(m.delivery_income || 0),
      expenses: Number(m.expenses_total || 0),
      net_profit: Number(m.net_profit || 0)
    };
    CATS.forEach(c => map[key][c] = 0);
  });

  (lastMonthlyByCat || []).forEach(e => {
    const key = e.month_start + e.currency;
    if (!map[key]) return;
    const cat = CATS.includes(e.category) ? e.category : "other";
    map[key][cat] += Number(e.amount || 0);
  });

Object.values(map).forEach(r => {
  const revenue = r.invoice_profit + r.delivery_income;
  const cogs = revenue - r.invoice_profit;

  rows.push([
    r.month,
    r.currency,
    revenue.toFixed(2),
    cogs.toFixed(2),
    r.invoice_profit.toFixed(2),
    r.delivery_income.toFixed(2),
    r.expenses.toFixed(2),
    r.net_profit.toFixed(2),
    ...CATS.map(c => r[c].toFixed(2))
  ]);
});


  downloadCsv("monthly_financials_full.csv", rows);
});



/* ===============================
   EXPORT: YEARLY FULL FINANCIALS
   =============================== */

document.getElementById("btnExportYearlyWide").addEventListener("click", () => {
  const CATS = [
    "rent","gas","utilities","phones","maintenance","media_ads",
    "gifts","commissions","bills","insurance","vehicle_payments","other"
  ];

  const header = [
  "year","currency",
  "revenue","cogs",
  "invoice_profit","delivery_income",
  "expenses","net_profit",
  ...CATS
];


  const rows = [header];
  const map = {};

  (lastYearly || []).forEach(y => {
    const key = y.year_start + y.currency;
    map[key] = {
      year: y.year_start,
      currency: y.currency,
      invoice_profit: Number(y.invoice_profit || 0),
      delivery_income: Number(y.delivery_income || 0),
      expenses: Number(y.expenses_total || 0),
      net_profit: Number(y.net_profit || 0)
    };
    CATS.forEach(c => map[key][c] = 0);
  });

  (lastMonthlyByCat || []).forEach(m => {
    const year = m.month_start.substring(0,4) + "-01-01";
    const key = year + m.currency;
    if (!map[key]) return;
    const cat = CATS.includes(m.category) ? m.category : "other";
    map[key][cat] += Number(m.amount || 0);
  });

Object.values(map).forEach(r => {
  const revenue = r.invoice_profit + r.delivery_income;
  const cogs = revenue - r.invoice_profit;

  rows.push([
    r.year,
    r.currency,
    revenue.toFixed(2),
    cogs.toFixed(2),
    r.invoice_profit.toFixed(2),
    r.delivery_income.toFixed(2),
    r.expenses.toFixed(2),
    r.net_profit.toFixed(2),
    ...CATS.map(c => r[c].toFixed(2))
  ]);
});


  downloadCsv("yearly_financials_full.csv", rows);
});

</script>
</body>
</html>
