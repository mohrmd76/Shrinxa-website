<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Admin â€“ Income</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); text-decoration:none; }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); text-decoration:none; }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus, textarea:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .wrap{ padding:18px 18px 28px; }

    .k{ color:#475569; font-size:12px; text-transform:uppercase; letter-spacing:.06em; }
    .v{ font-size:24px; font-weight:800; margin-top:6px; }
    .muted{ color:var(--muted); font-size:.875rem; }

    .grid{ display:grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap:12px; margin-top:14px; }
    @media (max-width: 1400px){ .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    @media (max-width: 900px){ .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }

    .controls{
      display:flex;
      gap:10px;
      align-items:end;
      flex-wrap:wrap;
      margin-top:12px;
    }
    label{ font-size:12px; color:#334155; display:flex; flex-direction:column; gap:6px; margin:0; }
    input, select, textarea{ border-radius:12px !important; }
    textarea{ min-width: 260px; }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; }
    button, .btn{ border-radius:12px; }

    .row{ display:grid; grid-template-columns: 1.2fr 1fr; gap:12px; margin-top:12px; }
    @media (max-width: 1100px){ .row{ grid-template-columns: 1fr; } }

    .table-wrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
      max-height: 420px;
    }

    table{ border-collapse:separate !important; border-spacing:0; width:100%; margin:0; }
    th, td{ border-bottom:1px solid rgba(17,24,39,.08); padding:10px 10px; vertical-align:top; }
    th{
      background:#f8fafc !important;
      position:sticky;
      top:0;
      z-index:2;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }
    tr:hover td{ background:#fafafa; }
    .right{ text-align:right; white-space:nowrap; }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      color:#334155;
      font-size:.875rem;
      font-weight:700;
    }

    .panel-title{
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
    }

    .two-btn{
      display:flex;
      gap:10px;
      align-items:end;
      flex-wrap:wrap;
    }
  </style>

</head>
<body>

<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html" class="active">Income</a>
	<a href="./clients.html">Clients</a>

    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-2"><div><div class="page-title h3 m-0">Income</div><div class="muted">Revenue, COGS, profit, delivery income, and expenses.</div></div><div class="d-flex gap-2 align-items-center"><span class="status-pill">Exports: CSV</span></div></div>
  <div class="status-pill" id="status">Loadingâ€¦</div>

  <div class="controls">
    <label>
      Preset
      <select id="range" class="form-select">
        <option value="month" selected>This month</option>
        <option value="today">Today</option>
        <option value="week">This week</option>
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="90">Last 90 days</option>
        <option value="year">This year</option>
      </select>
    </label>

    <label>
      Date from
      <input id="from" type="date" class="form-control">
    </label>

    <label>
      Date to
      <input id="to" type="date" class="form-control">
    </label>

    <label>
      Currency
      <select id="currency" class="form-select">
        <option value="">All</option>
        <option value="CAD" selected>CAD</option>
        <option value="USD">USD</option>
      </select>
    </label>

    <div class="btnrow">
      <button id="btnReload" type="button" class="btn btn-primary">Reload</button>
      <button id="btnExportExpenses" type="button" class="btn btn-outline-secondary">Export Expenses CSV</button>
      <button id="btnExportMonthlyWide" type="button" class="btn btn-outline-secondary">Export Monthly Breakdown CSV</button>
		<button id="btnExportMonthlyByCat" type="button" class="btn btn-outline-secondary">Export Monthly Expenses by Category CSV</button>
		<button id="btnExportYearlyWide" type="button" class="btn btn-outline-secondary">Export Yearly Breakdown CSV</button>

    </div>
  </div>

  <div class="grid">
		<div class="card">
	  <div class="k">Revenue</div>
	  <div class="v" id="kpiRevenue">â€”</div>
	</div>

<div class="card">
  <div class="k">COGS</div>
  <div class="v" id="kpiCOGS">â€”</div>
</div>
    <div class="card">
      <div class="k">Invoice Profit (range)</div>
      <div class="v" id="kpiInvoiceProfit">â€”</div>
      <div class="muted" id="kpiCurrency1"></div>
    </div>
    <div class="card">
    <div class="k">Delivery Income</div>
      <div class="v" id="kpiDeliveryIncome">â€”</div>
    </div>
    <div class="card">
      <div class="k">Total Expenses</div>
      <div class="v" id="kpiExpenses">â€”</div>
    </div>
    <div class="card">
      <div class="k">Net Profit</div>
      <div class="v" id="kpiNetProfit">â€”</div>
    </div>
    <!-- Analytics / Charts CTA -->
    <div class="card" style="text-align:center; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <div class="k">Analytics & Insights</div>
      <a href="./income-analytics.html" target="_blank" style="margin-top: 8px;">
        <button type="button" class="btn btn-outline-primary">
          ðŸ“Š Open Analytics
        </button>
      </a>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <div class="k">Add / Edit Expense</div>
      <div class="muted">Admin-only</div>

      <div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:10px; margin-top:10px;">
        <input type="hidden" id="expId">

        <label>
          Date
          <input id="expDate" type="date" class="form-control">
        </label>

        <label>
          Category
         <select id="expCategory" class="form-select"></select>
        </label>

<label>
  New Category
  <input id="newCategoryName" type="text" placeholder="e.g. parking" class="form-control">
</label>

<div style="display:flex; gap:10px; align-items:end;">
  <button id="btnAddCategory" type="button" class="btn btn-outline-secondary" style="flex:1;">Add Category</button>
  <button id="btnDeleteCategory" type="button" class="btn btn-outline-danger" style="flex:1;">Delete Category</button>
</div>

        <label>
          Amount
          <input id="expAmount" type="number" step="0.01" min="0" placeholder="0.00" class="form-control">
        </label>

        <label>
          Currency
          <select id="expCurrency" class="form-select">
            <option value="CAD" selected>CAD</option>
            <option value="USD">USD</option>
          </select>
        </label>

        <label>
          Vendor (optional)
          <input id="expVendor" type="text" placeholder="e.g., Shell, Rogers, Landlord" class="form-control">
        </label>

        <label>
          Receipt URL (optional)
          <input id="expReceipt" type="text" placeholder="https://..." class="form-control">
        </label>

        <label style="grid-column: 1 / -1;">
          Notes (optional)
          <textarea id="expNotes" rows="3" placeholder="Short note..." class="form-control"></textarea>
        </label>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button id="btnSaveExpense" type="button" class="btn btn-primary">Save</button>
        <button id="btnClearExpense" type="button" class="btn btn-outline-secondary">Clear</button>
        <button id="btnDeleteExpense" type="button" class="btn btn-outline-danger">Delete</button>
      </div>

      <div class="muted" style="margin-top:8px;">
        Tip: click a row in the expense list to edit it.
      </div>
    </div>

    <div class="d-flex flex-column gap-3">
      <div class="card">
        <div class="k">Monthly Summary</div>
        <div class="muted">From v_monthly_financials</div>
        <div class="table-wrap" style="margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Month</th>
               <th class="right">Revenue</th>
  <th class="right">COGS</th>
  <th class="right">Invoice Profit</th>
  <th class="right">Delivery Income</th>
  <th class="right">Expenses</th>
  <th class="right">Net Profit</th>

              </tr>
            </thead>
            <tbody id="monthlyTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Row: Expenses + Yearly Summary -->
  <div class="row" style="margin-top:12px;">
    <div class="card">
      <div class="k">Expenses (range)</div>
      <div class="muted">Click row to edit</div>
      <div class="table-wrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Vendor</th>
              <th>Notes</th>
              <th class="right">Amount</th>
              <th class="right">Currency</th>
            </tr>
          </thead>
          <tbody id="expensesTbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="k">Yearly Summary</div>
      <div class="muted">From v_yearly_financials</div>
      <div class="table-wrap" style="margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th class="right">Revenue</th>
              <th class="right">COGS</th>
              <th class="right">Invoice Profit</th>
              <th class="right">Delivery Income</th>
              <th class="right">Expenses</th>
              <th class="right">Net Profit</th>
            </tr>
          </thead>
          <tbody id="yearlyTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
  import { supabase } from "../supabaseClient.js";

  const statusEl = document.getElementById("status");
  const adminEmailEl = document.getElementById("adminEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const rangeEl = document.getElementById("range");
  const fromEl = document.getElementById("from");
  const toEl = document.getElementById("to");
  const currencyEl = document.getElementById("currency");
const deliveryField = "delivery";
  const btnReload = document.getElementById("btnReload");
  const btnExportExpenses = document.getElementById("btnExportExpenses");
const btnExportMonthlyWide = document.getElementById("btnExportMonthlyWide");
const btnExportMonthlyByCat = document.getElementById("btnExportMonthlyByCat");
const btnExportYearlyWide = document.getElementById("btnExportYearlyWide");

 
  const kpiInvoiceProfit = document.getElementById("kpiInvoiceProfit");
  const kpiRevenue = document.getElementById("kpiRevenue");
  const kpiCOGS = document.getElementById("kpiCOGS");
  const kpiDeliveryIncome = document.getElementById("kpiDeliveryIncome");
  const kpiExpenses = document.getElementById("kpiExpenses");
  const kpiNetProfit = document.getElementById("kpiNetProfit");
  const kpiCurrency1 = document.getElementById("kpiCurrency1");

  const monthlyTbody = document.getElementById("monthlyTbody");
  const yearlyTbody = document.getElementById("yearlyTbody");
  const expensesTbody = document.getElementById("expensesTbody");

  const expId = document.getElementById("expId");
  const expDate = document.getElementById("expDate");
  const expCategory = document.getElementById("expCategory");
  const expAmount = document.getElementById("expAmount");
  const expCurrency = document.getElementById("expCurrency");
  const expVendor = document.getElementById("expVendor");
  const expReceipt = document.getElementById("expReceipt");
  const expNotes = document.getElementById("expNotes");

  const btnSaveExpense = document.getElementById("btnSaveExpense");
  const btnClearExpense = document.getElementById("btnClearExpense");
  const btnDeleteExpense = document.getElementById("btnDeleteExpense");

const newCategoryName = document.getElementById("newCategoryName");
const btnAddCategory = document.getElementById("btnAddCategory");
const btnDeleteCategory = document.getElementById("btnDeleteCategory");


btnAddCategory.addEventListener("click", async () => {
  const name = (newCategoryName.value || "").trim();
  if (!name) return;

  try {
    show("Adding categoryâ€¦");

    const { error } = await supabase
      .from("expense_categories")
      .insert({ name });

    if (error) throw error;

    newCategoryName.value = "";
    await loadExpenseCategories();
    show("Category added âœ…");
  } catch (e) {
    console.error(e);
    show("ERROR: " + (e?.message || String(e)));
  }
});

btnDeleteCategory.addEventListener("click", async () => {
  const name = (expCategory.value || "").trim();
  if (!name) return;

  try {
    show("Deleting categoryâ€¦");

    const { error } = await supabase
      .from("expense_categories")
      .delete()
      .eq("name", name);

    if (error) throw error;

    await loadExpenseCategories();
    show("Category deleted âœ…");
  } catch (e) {
    console.error(e);
    show("ERROR: " + (e?.message || String(e)));
  }
});


  let lastExpenses = [];
  let lastMonthly = [];
let lastMonthlyByCat = [];
let lastYearly = [];



  function show(msg) { statusEl.textContent = msg; }

  function money(v) {
    const n = Number(v);
    if (!Number.isFinite(n)) return "0.00";
    return n.toFixed(2);
  }

  function toISODate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function setPreset(preset) {
    const now = new Date();
    const start = new Date(now);
    const end = new Date(now);

    if (preset === "today") {
      // same day
    } else if (preset === "week") {
      const day = now.getDay();
      start.setDate(now.getDate() - day);
    } else if (preset === "month") {
      start.setDate(1);
    } else if (preset === "year") {
      start.setMonth(0, 1);
    } else {
      const days = Number(preset || 30);
      start.setDate(now.getDate() - (days - 1));
    }

    start.setHours(0,0,0,0);
    end.setHours(23,59,59,999);

    fromEl.value = toISODate(start);
    toEl.value = toISODate(end);
  }

  async function requireAdmin() {
    show("Checking loginâ€¦");
    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr) throw new Error("getUser error: " + userErr.message);
    if (!user) { location.href = "../login.html"; return null; }

    if (adminEmailEl) adminEmailEl.textContent = user.email || "";

    show("Checking adminâ€¦");
    const { data: me, error: meErr } = await supabase
      .from("profiles")
      .select("is_admin")
      .eq("id", user.id)
      .single();

    if (meErr) throw new Error("profiles check error: " + meErr.message);
    if (!me?.is_admin) throw new Error("Access denied (not admin)");
    return user;
  }

  logoutBtn?.addEventListener("click", async () => {
    await supabase.auth.signOut();
    window.location.href = "../login.html";
  });

  function downloadCsv(filename, rows) {
    const esc = (v) => {
      const s = String(v ?? "");
      if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
      return s;
    };
    const csv = rows.map(r => r.map(esc).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function clearForm() {
    expId.value = "";
    expDate.value = toISODate(new Date());
    expCategory.value = "other";
    expAmount.value = "";
    expCurrency.value = "CAD";
    expVendor.value = "";
    expReceipt.value = "";
    expNotes.value = "";
  }
async function loadExpenseCategories() {
  const sel = document.getElementById("expCategory");
  if (!sel) return;

  const { data, error } = await supabase
    .from("expense_categories")
    .select("name")
    .order("name", { ascending: true });

  if (error) throw error;

  sel.innerHTML = "";
  for (const r of (data || [])) {
    const opt = document.createElement("option");
    opt.value = r.name;
    opt.textContent = r.name;
    sel.appendChild(opt);
  }
}

  async function loadExpensesRange(startDate, endDate, curr) {
    let q = supabase
      .from("expenses")
      .select("id, expense_date, category, amount, currency, vendor, notes, receipt_url, created_at")
      .gte("expense_date", startDate)
      .lte("expense_date", endDate)
      .order("expense_date", { ascending: false })
      .limit(2000);

    if (curr) q = q.eq("currency", curr);

    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  async function loadMonthly(curr) {
    let q = supabase
      .from("v_monthly_financials")
      
.select("month_start, currency, invoice_profit, delivery_income, expenses_total, net_profit, revenue_total, subtotal_total")

      .order("month_start", { ascending: false })
      .limit(240);

    if (curr) q = q.eq("currency", curr);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }
async function loadMonthlyByCategory(curr) {
  let q = supabase
    .from("v_monthly_expenses_by_category")
    .select("month_start, currency, category, amount")
    .order("month_start", { ascending: false })
    .limit(5000);

  if (curr) q = q.eq("currency", curr);

  const { data, error } = await q;
  if (error) throw error;
  return data || [];
}

  async function loadYearly(curr) {
    let q = supabase
      .from("v_yearly_financials")

.select("year_start, currency, invoice_profit, delivery_income, expenses_total, net_profit, revenue_total, subtotal_total")

      .order("year_start", { ascending: false })
      .limit(25);

    if (curr) q = q.eq("currency", curr);
    const { data, error } = await q;
    if (error) throw error;
    return data || [];
  }

  function inRange(d, from, to) {
    const x = new Date(d + "T00:00:00");
    return x >= from && x <= to;
  }

  function renderExpenses(rows) {
    expensesTbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");
      tr.dataset.id = r.id;
      tr.innerHTML = `
        <td>${r.expense_date || ""}</td>
        <td>${r.category || ""}</td>
        <td>${r.vendor || ""}</td>
        <td>${r.notes || ""}</td>
        <td class="right">${money(r.amount)}</td>
        <td class="right">${r.currency || ""}</td>
      `;
      expensesTbody.appendChild(tr);
    }
  }

  function renderMonthly(rows, fromDate, toDate) {
    monthlyTbody.innerHTML = "";
    for (const r of rows) {
      // monthly view is month_start; we show all months but highlight those inside chosen range
      const tr = document.createElement("tr");
     tr.innerHTML = `
  <td>${r.month_start}</td>
  <td class="right">${money(r.revenue_total)}</td>
  <td class="right">${money(r.subtotal_total - r.invoice_profit)}</td>
  <td class="right">${money(r.invoice_profit)}</td>
  <td class="right">${money(r.delivery_income)}</td>
  <td class="right">${money(r.expenses_total)}</td>
  <td class="right">${money(r.net_profit)}</td>
`;


      monthlyTbody.appendChild(tr);
    }
  }

  function renderYearly(rows) {
    yearlyTbody.innerHTML = "";
    for (const r of rows) {
      const tr = document.createElement("tr");

      tr.innerHTML = `
         <td>${r.year_start}</td>
  <td class="right">${money(r.revenue_total)}</td>
  <td class="right">${money(r.subtotal_total - r.invoice_profit)}</td>
  <td class="right">${money(r.invoice_profit)}</td>
  <td class="right">${money(r.delivery_income)}</td>
  <td class="right">${money(r.expenses_total)}</td>
  <td class="right">${money(r.net_profit)}</td>
`;

      yearlyTbody.appendChild(tr);
    }
  }

  function calcRangeKPIs(monthlyRows, expenseRows, from, to) {
    // KPI range computed from raw expenses in date range + invoices from invoices table
    // For profit + delivery, we query invoices directly for exact range.
  }

    async function fetchInvoiceProfitAndDelivery(startISO, endISO, curr) {
    let q = supabase
      .from("invoices")
     .select(`invoice_profit, ${deliveryField}, subtotal, total, currency, created_at`)
		      .eq("status", "paid")
      .gte("created_at", startISO)
      .lte("created_at", endISO)
      .limit(5000);

    if (curr) q = q.eq("currency", curr);

    const { data, error } = await q;
    if (error) throw error;

    let invProfit = 0;
    let deliveryIncome = 0;
    let subtotalSum = 0;
    let totalSum = 0;

    for (const r of (data || [])) {
      invProfit += Number(r.invoice_profit ?? 0);
      deliveryIncome += Number(r[deliveryField] ?? 0);
      subtotalSum += Number(r.subtotal ?? 0);
      totalSum += Number(r.total ?? 0);
    }

    return { invProfit, deliveryIncome, subtotalSum, totalSum };
  }


  async function loadAll() {
    show("Loadingâ€¦");
    const curr = (currencyEl.value || "").trim();

    const from = new Date((fromEl.value || "") + "T00:00:00");
    const to = new Date((toEl.value || "") + "T23:59:59");

    const startISO = from.toISOString();
    const endISO = to.toISOString();

    monthlyTbody.innerHTML = "";
    yearlyTbody.innerHTML = "";
    expensesTbody.innerHTML = "";

    try {
         const [monthly, monthlyByCat, yearly, expenses, invAgg] = await Promise.all([
        loadMonthly(curr),
        loadMonthlyByCategory(curr),
        loadYearly(curr),
        loadExpensesRange(fromEl.value, toEl.value, curr),
        fetchInvoiceProfitAndDelivery(startISO, endISO, curr),
      ]);


      lastMonthly = monthly;
      lastMonthlyByCat = monthlyByCat;
      lastYearly = yearly;
      lastExpenses = expenses;


      renderMonthly(monthly, from, to);
      renderYearly(yearly);
      renderExpenses(expenses);

      const expenseTotal = expenses.reduce((s, r) => s + Number(r.amount ?? 0), 0);


const revenue = Number(invAgg.totalSum || 0);
const cogs = Number(invAgg.subtotalSum || 0) - Number(invAgg.invProfit || 0);

kpiRevenue.textContent = money(revenue);
kpiCOGS.textContent = money(cogs);
kpiInvoiceProfit.textContent = money(invAgg.invProfit);
kpiDeliveryIncome.textContent = money(invAgg.deliveryIncome);
kpiExpenses.textContent = money(expenseTotal);
kpiNetProfit.textContent = money(invAgg.invProfit + invAgg.deliveryIncome - expenseTotal);




     
      kpiCurrency1.textContent = curr ? curr : "All currencies";

      show("Done âœ…");
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  }

  expensesTbody.addEventListener("click", (e) => {
    const tr = e.target?.closest?.("tr");
    if (!tr) return;
    const id = tr.dataset.id;
    const r = (lastExpenses || []).find(x => x.id === id);
    if (!r) return;

    expId.value = r.id;
    expDate.value = r.expense_date || toISODate(new Date());
    expCategory.value = r.category || "other";
    expAmount.value = Number(r.amount ?? 0);
    expCurrency.value = r.currency || "CAD";
    expVendor.value = r.vendor || "";
    expReceipt.value = r.receipt_url || "";
    expNotes.value = r.notes || "";
  });

  btnClearExpense.addEventListener("click", () => clearForm());

  btnSaveExpense.addEventListener("click", async () => {
    const payload = {
      expense_date: expDate.value || toISODate(new Date()),
      category: expCategory.value,
      amount: Number(expAmount.value || 0),
      currency: expCurrency.value,
      vendor: (expVendor.value || "").trim() || null,
      receipt_url: (expReceipt.value || "").trim() || null,
      notes: (expNotes.value || "").trim() || null,
    };

    try {
      show("Savingâ€¦");
      const id = (expId.value || "").trim();

      if (id) {
        const { error } = await supabase.from("expenses").update(payload).eq("id", id);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("expenses").insert(payload);
        if (error) throw error;
      }

      clearForm();
      await loadAll();
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  });

  btnDeleteExpense.addEventListener("click", async () => {
    const id = (expId.value || "").trim();
    if (!id) { show("Select an expense row first."); return; }

    try {
      show("Deletingâ€¦");
      const { error } = await supabase.from("expenses").delete().eq("id", id);
      if (error) throw error;

      clearForm();
      await loadAll();
    } catch (e) {
      console.error(e);
      show("ERROR: " + (e?.message || String(e)));
    }
  });

  btnReload.addEventListener("click", loadAll);

  btnExportExpenses.addEventListener("click", () => {
    const rows = [["expense_date","category","vendor","notes","amount","currency","receipt_url"]];
    for (const r of (lastExpenses || [])) {
      rows.push([
        r.expense_date || "",
        r.category || "",
        r.vendor || "",
        r.notes || "",
        money(r.amount),
        r.currency || "",
        r.receipt_url || ""
      ]);
    }
    downloadCsv("expenses.csv", rows);
  });


  rangeEl.addEventListener("change", () => {
    setPreset(rangeEl.value);
    loadAll();
  });

(async () => {
  await requireAdmin();
  setPreset(rangeEl.value);
  clearForm();
  await loadExpenseCategories();
  await loadAll();
})();

/* ===============================
   EXPORT: MONTHLY EXPENSES (BY CATEGORY)
   =============================== */
document.getElementById("btnExportMonthlyByCat").addEventListener("click", () => {
  const rows = [
    ["month_start","currency","category","amount"]
  ];

  (lastMonthlyByCat || []).forEach(r => {
    rows.push([
      r.month_start,
      r.currency,
      r.category,
      Number(r.amount || 0).toFixed(2)
    ]);
  });

  downloadCsv("monthly_expenses_by_category.csv", rows);
});


/* ===============================
   EXPORT: MONTHLY FULL FINANCIALS
   =============================== */

document.getElementById("btnExportMonthlyWide").addEventListener("click", () => {
  const CATS = [
    "rent","gas","utilities","phones","maintenance","media_ads",
    "gifts","commissions","bills","insurance","vehicle_payments","other"
  ];

const header = [
  "month","currency",
  "revenue","cogs",
  "invoice_profit","delivery_income",
  "expenses","net_profit",
  ...CATS
];

  const rows = [header];
  const map = {};

  (lastMonthly || []).forEach(m => {
    const key = m.month_start + m.currency;
map[key] = {
  month: m.month_start,
  currency: m.currency,
  invoice_profit: Number(m.invoice_profit || 0),
  delivery_income: Number(m.delivery_income || 0),
  expenses: Number(m.expenses_total || 0),
  net_profit: Number(m.net_profit || 0),
  revenue_total: Number(m.revenue_total || 0),
  subtotal_total: Number(m.subtotal_total || 0)
};
    

    CATS.forEach(c => map[key][c] = 0);
  });

  (lastMonthlyByCat || []).forEach(e => {
    const key = e.month_start + e.currency;
    if (!map[key]) return;
    const cat = CATS.includes(e.category) ? e.category : "other";
    map[key][cat] += Number(e.amount || 0);
  });

Object.values(map).forEach(r => {
  const revenue = Number(r.revenue_total || 0);
  const cogs = Number(r.subtotal_total || 0) - Number(r.invoice_profit || 0);

  rows.push([
    r.month,
    r.currency,
    revenue.toFixed(2),
    cogs.toFixed(2),
    Number(r.invoice_profit || 0).toFixed(2),
    Number(r.delivery_income || 0).toFixed(2),
    Number(r.expenses || 0).toFixed(2),
    Number(r.net_profit || 0).toFixed(2),
    ...CATS.map(c => Number(r[c] || 0).toFixed(2))
  ]);
});


  downloadCsv("monthly_financials_full.csv", rows);
});



/* ===============================
   EXPORT: YEARLY FULL FINANCIALS
   =============================== */

document.getElementById("btnExportYearlyWide").addEventListener("click", () => {
  const CATS = [
    "rent","gas","utilities","phones","maintenance","media_ads",
    "gifts","commissions","bills","insurance","vehicle_payments","other"
  ];

  const header = [
  "year","currency",
  "revenue","cogs",
  "invoice_profit","delivery_income",
  "expenses","net_profit",
  ...CATS
];


  const rows = [header];
  const map = {};

  (lastYearly || []).forEach(y => {
    const key = y.year_start + y.currency;
map[key] = {
  year: y.year_start,
  currency: y.currency,
  invoice_profit: Number(y.invoice_profit || 0),
  delivery_income: Number(y.delivery_income || 0),
  expenses: Number(y.expenses_total || 0),
  net_profit: Number(y.net_profit || 0),
  revenue_total: Number(y.revenue_total || 0),
  subtotal_total: Number(y.subtotal_total || 0)
};
   

    CATS.forEach(c => map[key][c] = 0);
  });

  (lastMonthlyByCat || []).forEach(m => {
    const year = m.month_start.substring(0,4) + "-01-01";
    const key = year + m.currency;
    if (!map[key]) return;
    const cat = CATS.includes(m.category) ? m.category : "other";
    map[key][cat] += Number(m.amount || 0);
  });

Object.values(map).forEach(r => {
  const revenue = Number(r.revenue_total || 0);
  const cogs = Number(r.subtotal_total || 0) - Number(r.invoice_profit || 0);

  rows.push([
    r.year,
    r.currency,
    revenue.toFixed(2),
    cogs.toFixed(2),
    Number(r.invoice_profit || 0).toFixed(2),
    Number(r.delivery_income || 0).toFixed(2),
    Number(r.expenses || 0).toFixed(2),
    Number(r.net_profit || 0).toFixed(2),
    ...CATS.map(c => Number(r[c] || 0).toFixed(2))
  ]);
});


  downloadCsv("yearly_financials_full.csv", rows);
});

</script>
</body>
</html>
