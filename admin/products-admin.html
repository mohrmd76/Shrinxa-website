<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shrinxa Admin â€“ Products</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus, textarea:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .table-wrap{
      max-height: calc(100vh - 270px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
    }

    table{
      border-collapse:separate !important;
      border-spacing:0;
      width:100%;
      min-width: 1600px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc !important;
      border-bottom:1px solid rgba(17,24,39,.08) !important;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }

    th, td{ padding:10px 10px; vertical-align:top; font-size:13px; }
    tbody tr:hover{ background:#fafafa; }

    /* Sticky first column (Product) */
    th.sticky-col, td.sticky-col {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 6;
      box-shadow: 2px 0 0 rgba(0,0,0,0.06);
    }
    thead th.sticky-col{ z-index: 8; background:#f8fafc !important; }

    .right{ text-align:right; white-space:nowrap; }
    .nowrap{ white-space:nowrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
    .muted{ color:var(--muted); font-size:12px; }

    .row-actions{ display:flex; gap:8px; flex-wrap:nowrap; white-space:nowrap; }

    dialog{ border:1px solid rgba(17,24,39,.18); border-radius:18px; padding:0; width: min(980px, 96vw); }
    .dlgHead{ padding:14px 14px 10px; border-bottom:1px solid rgba(17,24,39,.10); display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .dlgBody{ padding:14px; }
    .dlgFoot{ padding:12px 14px; border-top:1px solid rgba(17,24,39,.10); display:flex; justify-content:flex-end; gap:10px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .w100{ min-width: 0; width: 100%; }
    .small{ font-size: 12px; }
    @media (max-width: 900px){ .grid, .grid3{ grid-template-columns: 1fr; } table{ min-width: 1100px; } }

    .btn{ border-radius:12px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      font-size:.78rem;
      background:#fff;
      color:#334155;
    }
  </style>
</head>
<body>
<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html" class="active">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html">Income</a>
      <a href="./clients.html">Clients</a>
      <a href="./cash.html">Cash</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small opacity-75"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<main class="container-fluid px-4 py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <div class="page-title h3 m-0">Products</div>
      <div class="text-muted" style="font-size:.95rem;">Manage catalog, pricing tiers, content, images, and activation.</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="pill"><span class="mono">public.products</span></span>
      <span class="pill">Max: 2000 rows</span>
    </div>
  </div>

  <div class="card p-3">
    <div class="statusbar mb-3">
      <div class="d-flex gap-3 align-items-center flex-wrap">
        <div class="input-group" style="max-width: 620px;">
          <span class="input-group-text">ðŸ”Ž</span>
          <select id="scope" class="form-select" style="max-width: 200px;">
            <option value="all" selected>All fields</option>
            <option value="name">Name</option>
            <option value="description">Description</option>
            <option value="spec">Specification</option>
            <option value="features">Features</option>
            <option value="category">Category</option>
          </select>
          <input id="q" type="text" class="form-control" placeholder="Type to searchâ€¦ (debounced)">
          <button id="btnLoad" type="button" class="btn btn-primary">Load</button>
        </div>

        <div class="d-flex gap-2 align-items-center flex-wrap">
          <label class="m-0" style="font-size:.8rem; color:#334155;">
            Active
            <select id="activeFilter" class="form-select form-select-sm" style="min-width: 150px;">
              <option value="">All</option>
              <option value="true" selected>Active</option>
              <option value="false">Inactive</option>
            </select>
          </label>

          <button id="btnNew" type="button" class="btn btn-outline-secondary">New Product</button>
          <button id="btnExport" type="button" class="btn btn-outline-secondary">Export CSV</button>
        </div>

        <div class="hint">Live search: type to filter. Enter = load now, Esc = clear.</div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <div class="text-nowrap fw-semibold text-muted" id="status">Loadingâ€¦</div>
      </div>
    </div>

    <div class="text-muted small mb-2">
      Platinum prices are managed in <b>Platinum</b> page (no Platinum column here).
    </div>

    <div class="table-wrap">
      <!-- Table markup kept identical to your original columns -->
      <table class="table table-sm table-hover align-middle m-0">
        <thead>
          <tr>
            <th style="width:135px;" class="sticky-col">Product</th>
            <th style="width:70px;">Category</th>
            <th style="width:60px;">Active</th>
            <th style="width:45px;">Sort</th>

            <th style="width:85px;" class="right">Std Retail</th>
            <th style="width:110px;" class="right">Std Wholesale</th>

            <th style="width:90px;" class="right">Gold Retail</th>
            <th style="width:115px;" class="right">Gold Wholesale</th>

            <th style="width:225px;">Description</th>
            <th style="width:160px;">Specification</th>
            <th style="min-width:260px;">Features</th>
            <th style="width:75px;" class="nowrap">Rolls/Box</th>

            <th style="width:155px;">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <!-- Dialog kept (IDs unchanged) -->
    <dialog id="dlg">
      <div class="dlgHead">
        <div>
          <div class="mono" id="dlgId"></div>
          <div style="font-weight:800;" id="dlgTitle">Product</div>
          <div class="text-muted small">Table: <span class="mono">public.products</span></div>
        </div>
        <button id="btnClose" type="button" class="btn btn-sm btn-outline-secondary">Close</button>
      </div>

      <div class="dlgBody">
        <div class="grid">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Name
            <input id="f_name" class="form-control w100" type="text" placeholder="Product name">
          </label>

          <label class="w100" style="font-size:.8rem; color:#334155;">
            Product image (upload)
            <input id="f_image_file" class="form-control w100" type="file" accept="image/*">
          </label>

          <div class="w100" style="display:flex; flex-direction:column; gap:6px;">
            <label class="w100" style="min-width:0; font-size:.8rem; color:#334155;">
              Image URL (auto)
              <input id="f_image" class="form-control w100" type="text" placeholder="Upload an image to auto-fill" readonly>
            </label>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <button id="btnUploadImg" type="button" class="btn btn-outline-secondary">Upload</button>
              <span class="text-muted small" id="imgUploadStatus"></span>
            </div>
          </div>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Active
            <select id="f_active" class="form-select w100">
              <option value="true" selected>true</option>
              <option value="false">false</option>
            </select>
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Sort order
            <input id="f_sort" class="form-control w100" type="number" step="1" placeholder="0">
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Rolls / Box
            <input id="f_rolls" class="form-control w100" type="number" step="1" placeholder="0">
          </label>
        </div>

        <div class="grid3" style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Currency
            <input id="f_currency" class="form-control w100" type="text" placeholder="CAD" value="CAD">
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Category
            <select id="f_category" class="form-select w100">
              <option value="">-- select --</option>
              <option value="Stretch Wrap">Stretch Wrap</option>
              <option value="Pre-Stretch Wrap">Pre-Stretch Wrap</option>
              <option value="Tape Rolls">Tape Rolls</option>
            </select>
          </label>
          <div></div>
        </div>

        <div class="grid" style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Std Retail price
            <input id="f_std_retail" class="form-control w100" type="number" step="0.01" placeholder="0.00">
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Std Wholesale price
            <input id="f_std_wholesale" class="form-control w100" type="number" step="0.01" placeholder="0.00">
          </label>
        </div>

        <div class="grid" style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Gold Retail price
            <input id="f_gold_retail" class="form-control w100" type="number" step="0.01" placeholder="0.00">
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Gold Wholesale price
            <input id="f_gold_wholesale" class="form-control w100" type="number" step="0.01" placeholder="0.00">
          </label>
        </div>

        <div class="grid" style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Description
            <textarea id="f_desc" class="form-control w100" placeholder="Description..."></textarea>
          </label>
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Specification
            <textarea id="f_spec" class="form-control w100" placeholder="Specification..."></textarea>
          </label>
        </div>

        <div style="margin-top:12px;">
          <label class="w100" style="font-size:.8rem; color:#334155;">
            Features
            <textarea id="f_features" class="form-control w100" placeholder="Features..."></textarea>
          </label>
        </div>

        <div class="text-muted small" style="margin-top:10px;">
          Platinum custom prices are per-customer in <b>Platinum</b> page.
        </div>
      </div>

      <div class="dlgFoot">
        <button id="btnDelete" type="button" class="btn btn-outline-danger">Delete</button>
        <button id="btnSave" type="button" class="btn btn-primary">Save</button>
      </div>
    </dialog>
  </div>
</main>

<script type="module">
import { supabase } from "../supabaseClient.js";
window.supabaseClient = supabase;

const adminEmailEl = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "../login.html";
});


    const statusEl = document.getElementById("status");
    const tbody = document.getElementById("rows");

    const qEl = document.getElementById("q");
    const scopeEl = document.getElementById("scope");
    const activeFilterEl = document.getElementById("activeFilter");
    const btnLoad = document.getElementById("btnLoad");
    const btnNew = document.getElementById("btnNew");
    const btnExport = document.getElementById("btnExport");

    const dlg = document.getElementById("dlg");
    const dlgIdEl = document.getElementById("dlgId");
    const dlgTitleEl = document.getElementById("dlgTitle");
    const btnClose = document.getElementById("btnClose");
    const btnSave = document.getElementById("btnSave");
    const btnDelete = document.getElementById("btnDelete");

    const f_name = document.getElementById("f_name");
    const f_image = document.getElementById("f_image");
    const f_image_file = document.getElementById("f_image_file");
    const btnUploadImg = document.getElementById("btnUploadImg");
    const imgUploadStatus = document.getElementById("imgUploadStatus");
    const f_active = document.getElementById("f_active");
    const f_sort = document.getElementById("f_sort");
    const f_rolls = document.getElementById("f_rolls");
    const f_currency = document.getElementById("f_currency");
    const f_category = document.getElementById("f_category");

    const f_std_retail = document.getElementById("f_std_retail");
    const f_std_wholesale = document.getElementById("f_std_wholesale");
    const f_gold_retail = document.getElementById("f_gold_retail");
    const f_gold_wholesale = document.getElementById("f_gold_wholesale");

    const f_desc = document.getElementById("f_desc");
    const f_spec = document.getElementById("f_spec");
    const f_features = document.getElementById("f_features");

    let editing = null;

    
    // --- Import defaults from public products.html (catalog) ---
    // We use this to auto-fill Std prices, Description, Specification, Features, and Rolls/Box
    // when they are missing in the database.
    let __CATALOG_CACHE = null;

    function normName(s) {
      return String(s || "").toLowerCase().replace(/\s+/g, " ").trim();
    }

    function parseRollsPerBox(specText, metaText) {
      const txt = `${specText || ""} ${metaText || ""}`;
      const m = txt.match(/(\d+)\s*rolls?\s*\/\s*box/i) || txt.match(/(\d+)\s*rolls?\s*per\s*box/i);
      if (m) return Number(m[1]) || null;
      return null;
    }

    async function loadCatalogFromProductsHtml() {
      if (__CATALOG_CACHE) return __CATALOG_CACHE;

      const tryUrls = ["../products.html", "products.html"];
      let html = null;

      for (const url of tryUrls) {
        try {
          const r = await fetch(url, { cache: "no-cache" });
          if (r.ok) { html = await r.text(); break; }
        } catch (_) {}
      }

      if (!html) {
        __CATALOG_CACHE = { byName: new Map(), byId: new Map() };
        return __CATALOG_CACHE;
      }

      const doc = new DOMParser().parseFromString(html, "text/html");
      const cards = Array.from(doc.querySelectorAll("article.product-card, .product-card, [data-name], [data-id]"))
        .filter(el => (el.querySelector && el.querySelector(".prod-desc, .prod-spec, .prod-features, .features, .spec, .desc")) || (el.hasAttribute && (el.hasAttribute("data-retail") || el.hasAttribute("data-wholesale"))));

      const byName = new Map();
      const byId = new Map();

      const pickText = (el, sels) => {
        for (const s of sels) {
          const n = el.querySelector(s);
          if (n && (n.textContent || "").trim()) return (n.textContent || "").trim();
        }
        return "";
      };
      const pickAttr = (el, attrs) => {
        for (const a of attrs) {
          const v = el.getAttribute(a);
          if (v !== null && v !== undefined && String(v).trim() !== "") return String(v).trim();
        }
        return "";
      };
      const pickNumAttr = (el, attrs) => {
        const v = pickAttr(el, attrs);
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
      };

      for (const card of cards) {
        const pid = pickAttr(card, ["data-id","data-product-id","data-sku","data-pid"]) || "";
        const name = pickAttr(card, ["data-name","data-title","data-product","data-product-name"]) || pickText(card, [".prod-name","h3","h2",".title",".product-title"]);
        const spec = pickText(card, [".prod-spec",".spec",".product-spec",".product-specification","[data-field=\"prod-spec\"]"]);
        const desc = pickText(card, [".prod-desc",".desc",".product-desc",".product-description","[data-field=\"prod-desc\"]"]);
        let featuresArr = Array.from(card.querySelectorAll(".prod-features li, .features li, .product-features li")).map(li => (li.textContent || "").trim()).filter(Boolean);
        if (!featuresArr.length) {
          const ft = pickText(card, [".prod-features",".features",".product-features","[data-field=\"prod-features\"]"]);
          if (ft) {
            featuresArr = ft.split(/\r?\n|â€¢|\u2022|\-|\*/).map(s => s.trim()).filter(Boolean);
          }
        }
        const features = featuresArr.join("\n");

        const stdRetail = pickNumAttr(card, ["data-retail","data-std-retail","data-retail-price","data-price-retail","data-standard-retail"]);
        const stdWholesale = pickNumAttr(card, ["data-wholesale","data-std-wholesale","data-wholesale-price","data-price-wholesale","data-standard-wholesale"]);

        const goldRetail = pickNumAttr(card, ["data-retail-gold","data-gold-retail","data-price-retail-gold","data-gold-retail-price"]);
        const goldWholesale = pickNumAttr(card, ["data-wholesale-gold","data-gold-wholesale","data-price-wholesale-gold","data-gold-wholesale-price"]);

        const meta1 = pickText(card, [".prod-meta span",".meta span",".prod-meta",".meta",".product-meta","[data-field=\"prod-meta\"]"]);
        let rolls = parseRollsPerBox(spec, meta1);
        if (!rolls) {
          const rAttr = pickAttr(card, ["data-rolls","data-rolls-per-box","data-rolls-box","data-rolls_per_box"]); 
          const rn = Number(rAttr);
          if (Number.isFinite(rn) && rn > 0) rolls = rn;
        }
        if (!rolls) {
          const rTxt = pickText(card, [".prod-rolls",".rolls",".rolls-per-box",".product-rolls"]);
          const rn2 = parseRollsPerBox(rTxt, "");
          if (rn2) rolls = rn2;
        }

        const payload = {
          public_id: pid || null,
          name,
          spec,
          desc,
          features,
          rolls_per_box: rolls,
          std_retail: stdRetail,
          std_wholesale: stdWholesale,
          gold_retail: goldRetail,
          gold_wholesale: goldWholesale,
        };

        if (pid) byId.set(String(pid), payload);
        if (name) byName.set(normName(name), payload);
      }

      __CATALOG_CACHE = { byName, byId };
      return __CATALOG_CACHE;
    }

    async function applyCatalogDefaultsAndPersist(rows) {
      const catalog = await loadCatalogFromProductsHtml();
      if (!catalog?.byName) return rows;

      let updatedCount = 0;

      for (const r of rows) {
        const key = normName(r.name);
        const cat = catalog.byName.get(key);
        if (!cat) continue;

        const patch = {};

        // Standard prices
        if ((Number(r.std_retail) || 0) === 0 && cat.std_retail) patch.retail_price = cat.std_retail;
        if ((Number(r.std_wholesale) || 0) === 0 && cat.std_wholesale) patch.wholesale_price = cat.std_wholesale;

        // Content fields
        if (!String(r.description || "").trim() && cat.desc) patch.description = cat.desc;
        if (!String(r.specification || "").trim() && cat.spec) patch.specification = cat.spec;
        if (!String(r.features || "").trim() && cat.features) patch.features = cat.features;

        // Rolls/box
        if ((r.rolls_per_box === null || r.rolls_per_box === undefined || Number(r.rolls_per_box) === 0) && cat.rolls_per_box) {
          patch.rolls_per_box = cat.rolls_per_box;
        }

        if (Object.keys(patch).length === 0) continue;

        try {
          // Persist into DB so admin page shows values next time too
          const { error } = await supabase.from("products").update(patch).eq("id", r.id);
          if (!error) {
            updatedCount++;
            // Update local row object so UI shows immediately
            if (patch.retail_price !== undefined) r.std_retail = patch.retail_price;
            if (patch.wholesale_price !== undefined) r.std_wholesale = patch.wholesale_price;
            if (patch.description !== undefined) r.description = patch.description;
            if (patch.specification !== undefined) r.specification = patch.specification;
            if (patch.features !== undefined) r.features = patch.features;
            if (patch.rolls_per_box !== undefined) r.rolls_per_box = patch.rolls_per_box;
          }
        } catch (_) {}
      }

      if (updatedCount) {
        show(`Imported ${updatedCount} product(s) from products.html`);
      }

      return rows;
    }

function show(msg) { statusEl.textContent = msg; }

    // Live (debounced) search
    let _loadTimer = null;
    function scheduleLoad(delayMs = 500){
      if (_loadTimer) clearTimeout(_loadTimer);
      _loadTimer = setTimeout(() => loadProducts(), delayMs);
    }

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : null;
    }

    function money(v) {
      const x = Number(v);
      if (!Number.isFinite(x)) return "";
      return x.toFixed(2);
    }

// --- Image upload (Supabase Storage: product-images) ---
const IMAGE_BUCKET = "product-images";

function safeSlug(s) {
  return String(s || "product")
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "") || "product";
}

async function uploadSelectedImage() {
  const file = f_image_file?.files?.[0];
  if (!file) throw new Error("Choose an image first.");

  // Must be authenticated for storage insert policy
  const { data: sess } = await supabase.auth.getSession();
  if (!sess?.session?.user) throw new Error("Please sign in again, then upload.");

  const name = (f_name.value || "").trim();
  const ext = (file.name.split(".").pop() || "png").toLowerCase();
  const path = `products/${safeSlug(name)}-${Date.now()}.${ext}`;

  imgUploadStatus.textContent = "Uploadingâ€¦";
  const { error: upErr } = await supabase.storage
    .from(IMAGE_BUCKET)
    .upload(path, file, { upsert: true, contentType: file.type });

  if (upErr) throw upErr;

  const { data: pub } = supabase.storage.from(IMAGE_BUCKET).getPublicUrl(path);
  const url = pub?.publicUrl;
  if (!url) throw new Error("Could not generate public URL.");

  // Auto-fill image_url field
  f_image.value = url;
  imgUploadStatus.textContent = "Uploaded âœ…";
  return url;
}

btnUploadImg?.addEventListener("click", async () => {
  try {
    btnUploadImg.disabled = true;
    await uploadSelectedImage();
  } catch (e) {
    imgUploadStatus.textContent = "";
    alert(e?.message || String(e));
  } finally {
    btnUploadImg.disabled = false;
  }
});


    async function requireAdmin() {
      show("Checking loginâ€¦");
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr) throw new Error("getUser error: " + userErr.message);
      if (!user) { location.href = "../login.html"; return null; }
	if (adminEmailEl) adminEmailEl.textContent = user.email || "";


      show("Checking adminâ€¦");
      const { data: me, error: meErr } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();
      if (meErr) throw new Error("profiles check error: " + meErr.message);
      if (!me?.is_admin) throw new Error("Access denied (not admin)");
      return user;
    }

    function rowField(r, names, fallback = null) {
      for (const k of names) if (r && r[k] !== undefined && r[k] !== null) return r[k];
      return fallback;
    }

    function normalizeRow(r) {
      return {
        id: r.id,
        name: rowField(r, ["name","product_name","title"], ""),
        is_active: rowField(r, ["is_active","active","enabled"], true),
        sort_order: rowField(r, ["sort_order","sort","display_order"], 0),
        currency: rowField(r, ["currency"], "CAD"),

        

        category: rowField(r, ["category","product_category","cat"], ""),std_retail: rowField(r, ["retail_price","price_retail","retail","standard_retail_price","std_retail_price","std_retail","std_retail_amount"], 0),
        std_wholesale: rowField(r, ["wholesale_price","price_wholesale","wholesale","standard_wholesale_price","std_wholesale_price","std_wholesale","std_wholesale_amount"], 0),

        gold_retail: rowField(r, ["gold_retail_price","gold_retail","price_gold_retail","gold_price_retail","gold_price"], null),
        gold_wholesale: rowField(r, ["gold_wholesale_price","gold_wholesale","price_gold_wholesale","gold_price_wholesale","gold_wholesale"], null),

        description: rowField(r, ["prod_desc","description","desc","product_description"], ""),
        specification: rowField(r, ["prod_spec","specification","specs","product_specification"], ""),
        features: rowField(r, ["prod_features","features","feature","product_features"], ""),
        rolls_per_box: rowField(r, ["rolls_per_box","rolls_box","rolls_per_case","rolls_case"], null),
        image_url: rowField(r, ["image_url","image","photo_url","img_url"], ""),

        _raw: r
      };
    }

    function buildSearchOr(query) {
      const pat = `%${query}%`;
      const scope = (scopeEl?.value || "all").trim();
      if (scope === "name") return `name.ilike.${pat}`;
      if (scope === "description") return `description.ilike.${pat}`;
      if (scope === "spec") return `specification.ilike.${pat}`;
      if (scope === "features") return `features.ilike.${pat}`;
      if (scope === "category") return `category.ilike.${pat}`;
      return `name.ilike.${pat},description.ilike.${pat},specification.ilike.${pat},features.ilike.${pat},category.ilike.${pat}`;
    }
    async function loadProducts() {
      tbody.innerHTML = "";
      show("Loading productsâ€¦");

      let q = supabase
        .from("products")
        .select("*")
        .order("sort_order", { ascending: true, nullsFirst: true })
        .order("name", { ascending: true })
        .limit(2000);

      const activeFilter = (activeFilterEl.value || "").trim();
      if (activeFilter === "true") q = q.eq("is_active", true);
      if (activeFilter === "false") q = q.eq("is_active", false);

      const search = (qEl.value || "").trim();
      if (search) q = q.or(buildSearchOr(search));

      const { data, error } = await q;
      if (error) { show("ERROR: " + error.message); return; }

      let rows = (data || []).map(normalizeRow);
      rows = await applyCatalogDefaultsAndPersist(rows);

      for (const r of rows) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="sticky-col">
            <div style="font-weight:700;">${r.name || ""}</div>
            <div class="muted mono">${r.id || ""}</div>
          </td>
          <td>${r.category || ""}</td>
          <td>${r.is_active ? `<span class="pill">active</span>` : `<span class="pill">inactive</span>`}</td>
          <td class="right">${r.sort_order ?? ""}</td>

          <td class="right">${money(r.std_retail)} ${r.currency || ""}</td>
          <td class="right">${money(r.std_wholesale)} ${r.currency || ""}</td>

          <td class="right">${r.gold_retail === null ? "" : money(r.gold_retail) + " " + (r.currency||"")}</td>
          <td class="right">${r.gold_wholesale === null ? "" : money(r.gold_wholesale) + " " + (r.currency||"")}</td>

          <td>${(r.description || "").replaceAll("\n","<br/>")}</td>
          <td>${(r.specification || "").replaceAll("\n","<br/>")}</td>
          <td>${(r.features || "").replaceAll("\n","<br/>")}</td>
          <td class="right nowrap">${r.rolls_per_box ?? ""}</td>

          <td>
            <div class="row-actions">
              <button type="button" class="btnEdit" data-id="${r.id}">Edit</button>
              <button type="button" class="btnToggle" data-id="${r.id}" data-active="${r.is_active ? "true" : "false"}">${r.is_active ? "Deactivate" : "Activate"}</button>
            </div>
          </td>
        `;
        tr.dataset.raw = JSON.stringify(r._raw);
        tbody.appendChild(tr);
      }

      show(`Done âœ… Products: ${rows.length}`);
    }

    function openDialog(row) {
      editing = row;
      const r = row ? normalizeRow(row) : {
        id: "",
        name: "",
        is_active: true,
        sort_order: 0,
        rolls_per_box: null,
        currency: "CAD",
        category: "",
        std_retail: 0,
        std_wholesale: 0,
        gold_retail: null,
        gold_wholesale: null,
        description: "",
        specification: "",
        features: "",
        image_url: ""
      };

      dlgIdEl.textContent = r.id ? ("ID: " + r.id) : "New product";
      dlgTitleEl.textContent = r.name || "Product";

      f_name.value = r.name || "";
      f_image.value = r.image_url || "";
      if (f_image_file) f_image_file.value = "";
      if (imgUploadStatus) imgUploadStatus.textContent = "";
      f_active.value = String(!!r.is_active);
      f_sort.value = r.sort_order ?? 0;
      f_rolls.value = r.rolls_per_box ?? "";
      f_currency.value = r.currency || "CAD";
      f_category.value = r.category || "";

      f_std_retail.value = r.std_retail ?? 0;
      f_std_wholesale.value = r.std_wholesale ?? 0;
      f_gold_retail.value = r.gold_retail ?? "";
      f_gold_wholesale.value = r.gold_wholesale ?? "";

      f_desc.value = r.description || "";
      f_spec.value = r.specification || "";
      f_features.value = r.features || "";

      btnDelete.style.display = r.id ? "inline-block" : "none";
      dlg.showModal();
    }

    function closeDialog() {
      dlg.close();
      editing = null;
    }

    async function saveDialog() {
      show("Savingâ€¦");

      const payload = {
        name: String(f_name.value || "").trim(),
        is_active: String(f_active.value) === "true",
        sort_order: Number(f_sort.value || 0),
        currency: String(f_currency.value || "CAD").trim() || "CAD",

        category: f_category.value || null,

        retail_price: n(f_std_retail.value) ?? 0,
        wholesale_price: n(f_std_wholesale.value) ?? 0,

        gold_retail_price: f_gold_retail.value === "" ? null : n(f_gold_retail.value),
        gold_wholesale_price: f_gold_wholesale.value === "" ? null : n(f_gold_wholesale.value),

        description: String(f_desc.value || ""),
        specification: String(f_spec.value || ""),
        features: String(f_features.value || ""),
        rolls_per_box: f_rolls.value === "" ? null : Number(f_rolls.value),
        image_url: String(f_image.value || "").trim() || null,
      };

      if (!payload.name) { show("ERROR: Name required"); return; }

      if (editing?.id) {
        const { error } = await supabase
          .from("products")
          .update(payload)
          .eq("id", editing.id);
        if (error) { show("ERROR: " + error.message); return; }
      } else {
        const { error } = await supabase
          .from("products")
          .insert(payload);
        if (error) { show("ERROR: " + error.message); return; }
      }

      closeDialog();
      await loadProducts();
      show("Saved âœ…");
    }

async function deleteDialog() {
  if (!editing?.id) return;

  const name = String(f_name.value || "").trim().toLowerCase();

 // Safety: only allow hard delete if product is inactive
if (String(f_active.value) === "true") {
  alert("Disable the product first (set Active = false), then delete.");
  return;
}

  show("Deleting permanentlyâ€¦");

  const { error } = await supabase
    .from("products")
    .delete()
    .eq("id", editing.id);

  if (error) { show("ERROR: " + error.message); return; }

  closeDialog();
  await loadProducts();
  show("Deleted permanently âœ…");
}


    async function toggleActive(id, currentActive) {
      show("Savingâ€¦");
      const { error } = await supabase
        .from("products")
        .update({ is_active: !currentActive })
        .eq("id", id);
      if (error) { show("ERROR: " + error.message); return; }
      await loadProducts();
      show("Saved âœ…");
    }

    function downloadCsv(filename, rows) {
      const esc = (v) => {
        const s = String(v ?? "");
        if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
        return s;
      };
      const csv = rows.map(r => r.map(esc).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportCsvFromTable() {
      const rows = [
        ["id","name","category","is_active","sort_order","currency","retail_price","wholesale_price","gold_retail_price","gold_wholesale_price","description","specification","features","rolls_per_box","image_url"]
      ];
      const trs = Array.from(tbody.querySelectorAll("tr"));
      for (const tr of trs) {
        const raw = JSON.parse(tr.dataset.raw || "{}");
        const r = normalizeRow(raw);
        rows.push([
          r.id,
          r.name,
          r.category || "",
          r.is_active ? "true" : "false",
          r.sort_order ?? "",
          r.currency || "",
          r.std_retail ?? "",
          r.std_wholesale ?? "",
          r.gold_retail ?? "",
          r.gold_wholesale ?? "",
          r.description ?? "",
          r.specification ?? "",
          r.features ?? "",
          r.rolls_per_box ?? "",
          r.image_url ?? ""
        ]);
      }
      downloadCsv("products_admin_export.csv", rows);
    }

    tbody.addEventListener("click", async (e) => {
      const editBtn = e.target?.closest?.(".btnEdit");
      if (editBtn) {
        const tr = editBtn.closest("tr");
        const raw = JSON.parse(tr.dataset.raw || "{}");
        openDialog(raw);
        return;
      }

      const toggleBtn = e.target?.closest?.(".btnToggle");
      if (toggleBtn) {
        const id = toggleBtn.getAttribute("data-id");
        const currentActive = toggleBtn.getAttribute("data-active") === "true";
        await toggleActive(id, currentActive);
        return;
      }
    });

    // Live search (debounced)
    qEl.addEventListener("input", () => {
      const v = (qEl.value || "").trim();
      scheduleLoad(v ? 550 : 150);
    });

    qEl.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        if (_loadTimer) clearTimeout(_loadTimer);
        loadProducts();
      }
      if (ev.key === "Escape") {
        qEl.value = "";
        scheduleLoad(120);
      }
    });

    scopeEl?.addEventListener("change", () => {
      scheduleLoad(200);
    });

btnLoad.addEventListener("click", loadProducts);
    btnNew.addEventListener("click", () => openDialog(null));
    btnExport.addEventListener("click", exportCsvFromTable);

    btnClose.addEventListener("click", closeDialog);
    btnSave.addEventListener("click", saveDialog);
    btnDelete.addEventListener("click", deleteDialog);

    (async () => {
      await requireAdmin();
      await loadProducts();
    })();
</script>
<script src="/assets/admin-analytics.js" defer></script>

</body>
</html>
