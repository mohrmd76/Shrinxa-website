<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shrinxa Admin – Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); text-decoration:none; }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); text-decoration:none; }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
      background: var(--card);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      color:#334155;
      font-size:.875rem;
      font-weight:700;
      white-space:nowrap;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 1400px){ .kpi-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (max-width: 800px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .kpi-card{
      text-align:center;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      padding:14px 12px;
      min-height: 86px;
    }
    .k{ color:#475569; font-size:.8rem; text-transform:uppercase; letter-spacing:.06em; width:100%; }
    .v{ font-size:22px; font-weight:800; margin-top:6px; width:100%; }
    .muted{ color:var(--muted); font-size:.875rem; }

    .grid-2{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .grid-2{ grid-template-columns: 1fr; } }

    .grid-3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 1100px){ .grid-3{ grid-template-columns: 1fr; } }

    .table-wrap{
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
      max-height: 360px;
      margin-top:10px;
    }

    table{ border-collapse:separate !important; border-spacing:0; width:100%; margin:0; }
    th, td{ border-bottom:1px solid rgba(17,24,39,.08); padding:10px 10px; vertical-align:top; }
    th{
      background:#f8fafc !important;
      position:sticky;
      top:0;
      z-index:2;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }
    tr:hover td{ background:#fafafa; }
    .clickrow tbody tr{ cursor:pointer; }
    .right{ text-align:right; white-space:nowrap; }

    canvas{ width: 100% !important; height: 320px !important; }

    .wrap{ padding:18px 18px 28px; }
  </style>
</head>

<body>
<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html" class="active">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html">Platinum</a>
      <a href="./delivery-admin.html">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html">Income</a>
      <a href="./clients.html">Clients</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small opacity-75"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<main class="container-fluid px-4 py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <div class="page-title h3 m-0">Dashboard</div>
      <div class="muted">Revenue, status breakdown, customers, products, and recent orders.</div>
    </div>
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <span id="status" class="pill">Loading…</span>
    </div>
  </div>

  <div class="card p-3 mb-3">
    <div class="statusbar">
      <div class="d-flex gap-3 align-items-end flex-wrap">
        <label class="m-0" style="font-size:.8rem; color:#334155;">
          Preset
          <select id="range" class="form-select">
            <option value="today">Today</option>
            <option value="week">This week</option>
            <option value="month">This month</option>
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </label>

        <label class="m-0" style="font-size:.8rem; color:#334155;">
          Date from
          <input id="from" type="date" class="form-control">
        </label>

        <label class="m-0" style="font-size:.8rem; color:#334155;">
          Date to
          <input id="to" type="date" class="form-control">
        </label>

        <label class="m-0" style="font-size:.8rem; color:#334155;">
          Currency
          <select id="currency" class="form-select">
            <option value="">All</option>
            <option value="CAD" selected>CAD</option>
            <option value="USD">USD</option>
          </select>
        </label>

        <div class="d-flex gap-2 flex-wrap align-items-end">
          <button id="btnReload" type="button" class="btn btn-primary">Reload</button>
          <button id="btnExportInvoices" type="button" class="btn btn-outline-secondary">Export Invoices CSV</button>
          <button id="btnExportTopProducts" type="button" class="btn btn-outline-secondary">Export Top Products CSV</button>
        </div>
      </div>

      <div class="hint">Tip: click rows in tables to jump to Orders / Invoice.</div>
    </div>
  </div>

  <div class="kpi-grid">
    <div class="card kpi-card">
      <div class="k">Orders (range)</div>
      <div class="v" id="kpiOrders">—</div>
    </div>
    <div class="card kpi-card">
      <div class="k">Revenue (range)</div>
      <div class="v" id="kpiRevenue">—</div>
      <div class="muted" id="kpiRevenue2"></div>
    </div>
    <div class="card kpi-card">
      <div class="k">Paid revenue</div>
      <div class="v" id="kpiPaidRev">—</div>
    </div>
    <div class="card kpi-card">
      <div class="k">Unpaid/Pending revenue</div>
      <div class="v" id="kpiUnpaidRev">—</div>
    </div>
    <div class="card kpi-card">
      <div class="k">Paid orders</div>
      <div class="v" id="kpiPaid">—</div>
    </div>
    <div class="card kpi-card">
      <div class="k">Avg order value</div>
      <div class="v" id="kpiAov">—</div>
    </div>
  </div>

  <div class="grid-2">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
        <div>
          <div class="k">Revenue by day</div>
          <div class="muted">Sum of invoice totals</div>
        </div>
      </div>
      <canvas id="chartDaily"></canvas>
    </div>

    <div class="card p-3">
      <div class="k">Status breakdown</div>
      <div class="muted">Count of invoices</div>
      <canvas id="chartStatus"></canvas>
    </div>
  </div>

  <div class="grid-3">
    <div class="card p-3 clickrow">
      <div class="k">Top customers (by revenue)</div>
      <div class="muted">Tap a row to open Orders filtered</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Customer</th>
              <th class="right">Orders</th>
              <th class="right">Revenue</th>
            </tr>
          </thead>
          <tbody id="topCustomers"></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3 clickrow">
      <div class="k">All Products (by revenue)</div>
      <div class="muted">From invoice_items</div>

      <div style="height:260px; margin-top:6px;">
        <canvas id="chartProducts"></canvas>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th class="right">Qty</th>
              <th class="right">Revenue</th>
              <th class="right">Total Cost</th>
              <th class="right">Total Profit</th>
              <th class="right">Profit %</th>
            </tr>
          </thead>
          <tbody id="topProducts"></tbody>
        </table>
      </div>
    </div>

    <div class="card p-3 clickrow">
      <div class="k">Recent orders</div>
      <div class="muted">Tap a row to open invoice</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Invoice</th>
              <th>Customer</th>
              <th>Status</th>
              <th class="right">Total</th>
            </tr>
          </thead>
          <tbody id="recentOrders"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script type="module">
import { supabase } from "../supabaseClient.js";
const adminEmailEl = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "../login.html";
});


    const statusEl = document.getElementById("status");
    const rangeEl = document.getElementById("range");
    const fromEl = document.getElementById("from");
    const toEl = document.getElementById("to");
    const currencyEl = document.getElementById("currency");

    const btnReload = document.getElementById("btnReload");
    const btnExportInvoices = document.getElementById("btnExportInvoices");
    const btnExportTopProducts = document.getElementById("btnExportTopProducts");

    const kpiOrders = document.getElementById("kpiOrders");
    const kpiRevenue = document.getElementById("kpiRevenue");
    const kpiRevenue2 = document.getElementById("kpiRevenue2");
    const kpiPaid = document.getElementById("kpiPaid");
    const kpiAov = document.getElementById("kpiAov");
    const kpiPaidRev = document.getElementById("kpiPaidRev");
    const kpiUnpaidRev = document.getElementById("kpiUnpaidRev");

    const topCustomersTbody = document.getElementById("topCustomers");
    const topProductsTbody = document.getElementById("topProducts");
    const recentOrdersTbody = document.getElementById("recentOrders");

    let dailyChart = null;
    let statusChart = null;
	let productsChart = null;

    let lastInvoices = [];
    let lastTopProducts = [];

    function show(msg) { statusEl.textContent = msg; }

    function toISODate(d) {
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function money(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return "0.00";
      return n.toFixed(2);
    }

    function normStatus(s) {
      const v = String(s || "").trim().toLowerCase();
      if (v === "paid") return "paid";
      if (v === "cancelled" || v === "canceled") return "cancelled";
      if (v === "pending") return "pending";
      if (v === "unpaid") return "unpaid";
      if (!v) return "(blank)";
      return v;
    }

    async function requireAdmin() {
      show("Checking login…");
      const { data: { user }, error: userErr } = await supabase.auth.getUser();
      if (userErr) throw new Error("getUser error: " + userErr.message);
      if (!user) { location.href = "../login.html"; return null; }

	if (adminEmailEl) adminEmailEl.textContent = user.email || "";

      show("Checking admin…");
      const { data: me, error: meErr } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();
      if (meErr) throw new Error("profiles check error: " + meErr.message);
      if (!me?.is_admin) throw new Error("Access denied (not admin)");
      return user;
    }

    function setPreset(preset) {
      const now = new Date();
      const start = new Date(now);
      const end = new Date(now);

      if (preset === "today") {
        // start/end today
      } else if (preset === "week") {
        // Sunday=0 ... Saturday=6
        const day = now.getDay();
        start.setDate(now.getDate() - day);
      } else if (preset === "month") {
        start.setDate(1);
      } else {
        const days = Number(preset || 30);
        start.setDate(now.getDate() - (days - 1));
      }

      start.setHours(0,0,0,0);
      end.setHours(23,59,59,999);

      fromEl.value = toISODate(start);
      toEl.value = toISODate(end);
    }

    function buildDailyChart(labels, values) {
      const ctx = document.getElementById("chartDaily");
      if (dailyChart) dailyChart.destroy();
      dailyChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: "Revenue", data: values }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

function buildStatusChart(labels, values) {
  const ctx = document.getElementById("chartStatus");
  if (!ctx) return;

  if (statusChart) statusChart.destroy();
  statusChart = new Chart(ctx, {
    type: "doughnut",
    data: { labels, datasets: [{ data: values }] },
    options: {
      responsive: true,
      plugins: { legend: { position: "bottom" } }
    }
  });
}

  function buildProductsChart(rows) {
  const ctx = document.getElementById("chartProducts");
  if (!ctx) return;

  // Keep chart readable: top 12 by revenue
  const top = (rows || []).slice().sort((a,b) => (b.revenue||0) - (a.revenue||0)).slice(0, 12);

  const labels = top.map(r => r.product);
  const values = top.map(r => Number(r.revenue || 0));

  if (productsChart) productsChart.destroy();
  productsChart = new Chart(ctx, {
    type: "bar",
    data: { labels, datasets: [{ label: "Revenue", data: values }] },
    options: {
      responsive: true,
      indexAxis: "y",
      scales: { x: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
}


    function downloadCsv(filename, rows) {
      const esc = (v) => {
        const s = String(v ?? "");
        if (/[",\n]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
        return s;
      };
      const csv = rows.map(r => r.map(esc).join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
	async function fetchActiveProducts() {
  const { data, error } = await supabase
    .from("products")
    .select("name")
    .eq("is_active", true)
    .is("deleted_at", null)
    .order("name", { ascending: true });

  if (error) throw error;
  return (data || []).map(r => String(r.name || "").trim()).filter(Boolean);
}

    async function fetchInvoiceItemsAggregates(invoiceIds) {
      // chunk because PostgREST in() has URL length limits
      const chunkSize = 200;
      const agg = new Map(); // item_name -> {qty, revenue, cost}

      for (let i = 0; i < invoiceIds.length; i += chunkSize) {
        const chunk = invoiceIds.slice(i, i + chunkSize);
        const { data, error } = await supabase
          .from("invoice_items")
	.select("item_name, qty, line_total, line_profit, invoice_id")
          .in("invoice_id", chunk);

        if (error) throw error;

        for (const r of (data || [])) {
          const name = String(r.item_name || "Item").trim();
        const obj = agg.get(name) || { qty: 0, revenue: 0, cost: 0 };
	const q = Number(r.qty ?? 0);
	obj.qty += q;
	obj.revenue += Number(r.line_total ?? 0);
	obj.cost += Number(r.line_total ?? 0) - Number(r.line_profit ?? 0);
          agg.set(name, obj);
        }
      }

      return Array.from(agg.entries())
        .map(([product, v]) => ({
  product,
  qty: v.qty,
  revenue: v.revenue,
  cost: v.cost,
  profit: v.revenue - v.cost
}))

        .sort((a,b) => b.revenue - a.revenue)
        .slice(0, 25);
    }

    async function loadDashboard() {
      topCustomersTbody.innerHTML = "";
      topProductsTbody.innerHTML = "";
      recentOrdersTbody.innerHTML = "";
      show("Loading invoices…");

      const curr = (currencyEl.value || "").trim();

      const start = new Date((fromEl.value || "") + "T00:00:00");
      const end = new Date((toEl.value || "") + "T23:59:59");

      let q = supabase
        .from("invoices")
        .select("id, invoice_number, created_at, currency, total, status, bill_to_email, bill_to_name, bill_to_company")
        .gte("created_at", start.toISOString())
        .lte("created_at", end.toISOString())
        .order("created_at", { ascending: false })
        .limit(2000);

      if (curr) q = q.eq("currency", curr);

      const { data: invs, error } = await q;
      if (error) { show("ERROR: " + error.message); return; }

      const invoices = invs || [];
      lastInvoices = invoices;

      // KPIs
      const revenue = invoices.reduce((s, r) => s + Number(r.total ?? 0), 0);

      const paidInvoices = invoices.filter(r => normStatus(r.status) === "paid");
      const paidRev = paidInvoices.reduce((s, r) => s + Number(r.total ?? 0), 0);
      const unpaidRev = revenue - paidRev;

      const paidCount = paidInvoices.length;
      const aov = invoices.length ? (revenue / invoices.length) : 0;

      kpiOrders.textContent = String(invoices.length);
      kpiRevenue.textContent = money(revenue);
      kpiRevenue2.textContent = curr ? curr : (invoices[0]?.currency || "CAD");
      kpiPaid.textContent = String(paidCount);
      kpiAov.textContent = money(aov);
      kpiPaidRev.textContent = money(paidRev);
      kpiUnpaidRev.textContent = money(unpaidRev);

      // Daily revenue
      const dayMap = new Map(); // YYYY-MM-DD -> revenue
      const cursor = new Date(start);
      cursor.setHours(0,0,0,0);
      const endDay = new Date(end);
      endDay.setHours(0,0,0,0);

      while (cursor <= endDay) {
        dayMap.set(toISODate(cursor), 0);
        cursor.setDate(cursor.getDate() + 1);
      }

      for (const r of invoices) {
        const k = toISODate(new Date(r.created_at));
        if (dayMap.has(k)) dayMap.set(k, dayMap.get(k) + Number(r.total ?? 0));
      }

      const dayLabels = Array.from(dayMap.keys());
      const dayValues = dayLabels.map(k => Number(dayMap.get(k) || 0));
      buildDailyChart(dayLabels, dayValues);

      // Status breakdown (fixed buckets)
      const buckets = ["paid","unpaid","pending","cancelled","(blank)"];
      const statusMap = new Map(buckets.map(b => [b, 0]));
      for (const r of invoices) {
        const s = normStatus(r.status);
        statusMap.set(s, (statusMap.get(s) || 0) + 1);
      }
      const stLabels = buckets;
      const stValues = stLabels.map(k => statusMap.get(k) || 0);
      buildStatusChart(stLabels, stValues);

      // Top customers
      const custMap = new Map();
      for (const r of invoices) {
        const who = (r.bill_to_company || r.bill_to_email || r.bill_to_name || "Unknown").trim();
        const obj = custMap.get(who) || { orders: 0, revenue: 0 };
        obj.orders += 1;
        obj.revenue += Number(r.total ?? 0);
        custMap.set(who, obj);
      }
      const topCustomers = Array.from(custMap.entries())
        .map(([customer,v]) => ({ customer, orders: v.orders, revenue: v.revenue }))
        .sort((a,b) => b.revenue - a.revenue)
        .slice(0, 25);

      for (const r of topCustomers) {
        const tr = document.createElement("tr");
        tr.dataset.customer = r.customer;
        tr.innerHTML = `
          <td>${r.customer}</td>
          <td class="right">${r.orders}</td>
          <td class="right">${money(r.revenue)}</td>
        `;
        topCustomersTbody.appendChild(tr);
      }

      // Recent orders (15)
      const recent = invoices.slice(0, 15);
      for (const r of recent) {
        const cust = (r.bill_to_company || r.bill_to_email || r.bill_to_name || "").trim();
        const tr = document.createElement("tr");
        tr.dataset.invoiceId = r.id;
        tr.innerHTML = `
          <td>${r.invoice_number || r.id}</td>
          <td>${cust}</td>
          <td>${normStatus(r.status)}</td>
          <td class="right">${money(r.total)}</td>
        `;
        recentOrdersTbody.appendChild(tr);
      }

      // All products (active) + sales
show("Loading product performance…");
try {
  const invoiceIds = invoices.map(r => r.id);

  const [activeNames, soldAgg] = await Promise.all([
    fetchActiveProducts(),
    invoiceIds.length ? fetchInvoiceItemsAggregates(invoiceIds) : Promise.resolve([])
  ]);

  const soldMap = new Map(soldAgg.map(p => [p.product, p]));

  const allRows = activeNames.map(name => {
    const s = soldMap.get(name);
    return s || { product: name, qty: 0, revenue: 0, cost: 0, profit: 0 };
  });

  // sort by revenue desc (so sold items appear on top)
  allRows.sort((a,b) => b.revenue - a.revenue);

  lastTopProducts = allRows;
buildProductsChart(lastTopProducts);

  for (const p of allRows) {
    const tr = document.createElement("tr");
	const profitPct = p.revenue > 0 ? ((p.profit / p.revenue) * 100).toFixed(1) + "%" : "0.0%";
    tr.innerHTML = `
      <td>${p.product}</td>
      <td class="right">${p.qty}</td>
      <td class="right">${money(p.revenue)}</td>
      <td class="right">${money(p.cost)}</td>
      <td class="right">${money(p.profit)}</td>
	<td class="right">${profitPct}</td>
    `;
    topProductsTbody.appendChild(tr);
  }
} catch (e) {
  console.error(e);
}


      show("Done ✅");
    }

    // Click: open orders filtered by customer
    topCustomersTbody.addEventListener("click", (e) => {
      const tr = e.target?.closest?.("tr");
      if (!tr) return;
      const customer = tr.dataset.customer || "";
      const from = fromEl.value || "";
      const to = toEl.value || "";
      const url = `/admin/orders.html?q=${encodeURIComponent(customer)}&from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
      window.location.href = url;
    });

    // Click: open invoice
    recentOrdersTbody.addEventListener("click", (e) => {
      const tr = e.target?.closest?.("tr");
      if (!tr) return;
      const id = tr.dataset.invoiceId || "";
      if (!id) return;
      window.open(`/invoice.html?id=${encodeURIComponent(id)}`, "_blank");
    });

    btnReload.addEventListener("click", loadDashboard);

    btnExportInvoices.addEventListener("click", () => {
      const rows = [
        ["invoice_id","invoice_number","created_at","status","currency","total","bill_to_company","bill_to_name","bill_to_email"]
      ];
      for (const r of (lastInvoices || [])) {
        rows.push([
          r.id,
          r.invoice_number || "",
          r.created_at || "",
          normStatus(r.status),
          r.currency || "",
          r.total ?? "",
          r.bill_to_company || "",
          r.bill_to_name || "",
          r.bill_to_email || ""
        ]);
      }
      downloadCsv("invoices.csv", rows);
    });

    btnExportTopProducts.addEventListener("click", () => {
  const rows = [["product","qty","revenue","total_cost","total_profit","profit_pct"]];
  for (const p of (lastTopProducts || [])) {
    rows.push([
      p.product,
      p.qty,
      money(p.revenue),
      money(p.cost),
      money(p.profit),
	p.revenue > 0 ? ((p.profit / p.revenue) * 100).toFixed(1) : "0.0"
    ]);
  }
  downloadCsv("all_products.csv", rows);
});


    // Preset change fills date inputs
    rangeEl.addEventListener("change", () => {
      setPreset(rangeEl.value);
      loadDashboard();
    });

    // Initialize dates on load
    (async () => {
      await requireAdmin();
      setPreset(rangeEl.value);
      await loadDashboard();
    })();
</script>
</body>
</html>
