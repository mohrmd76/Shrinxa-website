<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin – Customers</title>
</head>
<body>
  <h2>Customers</h2>

  <div id="status" style="padding:8px;border:1px solid #ccc;display:inline-block;margin-bottom:10px;">
    Loading…
  </div>

  <table border="1" cellpadding="6">
    <thead>
      <tr>
        <th>ID</th>
        <th>Email</th>
        <th>Full Name</th>
        <th>Company</th>
        <th>Phone</th>
        <th>Admin</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <script type="module">
    import { supabase } from "../supabaseClient.js";

    const status = document.getElementById("status");
    const tbody = document.getElementById("rows");

    function show(msg) { status.textContent = msg; }

    try {
      show("Checking login…");
      const { data: { user }, error: userErr } = await supabase.auth.getUser();

      if (userErr) throw new Error("getUser error: " + userErr.message);
      if (!user) {
        show("Not logged in → redirecting to login.html");
        location.href = "../login.html";
        throw new Error("Not logged in");
      }

      show("Checking admin…");
      const { data: me, error: meErr } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();

      if (meErr) throw new Error("profiles check error: " + meErr.message);
      if (!me?.is_admin) throw new Error("Access denied (not admin)");

      show("Loading customers…");
      const { data: customers, error: custErr } = await supabase
        .from("profiles")
        .select("id, email, full_name, company_name, phone, is_admin")
        .order("created_at", { ascending: false });

      if (custErr) throw new Error("customers query error: " + custErr.message);

      tbody.innerHTML = "";
      for (const c of (customers || [])) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.id}</td>
          <td>${c.email ?? ""}</td>
          <td>${c.full_name ?? ""}</td>
          <td>${c.company_name ?? ""}</td>
          <td>${c.phone ?? ""}</td>
          <td>${c.is_admin ? "YES" : "NO"}</td>
        `;
        tbody.appendChild(tr);
      }

      show(`Done. Rows: ${(customers || []).length}`);
    } catch (e) {
      show("ERROR: " + (e?.message || String(e)));
    }
  </script>
</body>
</html>
