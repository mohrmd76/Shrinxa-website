<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Income Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg0:#0b1220;
      --bg1:#0f1b33;
      --card: rgba(255,255,255,.90);
      --card2: rgba(255,255,255,.80);
      --stroke: rgba(255,255,255,.14);
      --text:#0b0f19;
      --muted:#5a6374;
      --brand:#2b6cff;
      --brand2:#7c3aed;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --shadow: 0 14px 40px rgba(0,0,0,.18);
      --shadow2: 0 10px 26px rgba(0,0,0,.14);
      --radius: 18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(43,108,255,.35), transparent 55%),
        radial-gradient(1000px 520px at 90% 20%, rgba(124,58,237,.28), transparent 55%),
        radial-gradient(900px 520px at 60% 95%, rgba(16,185,129,.18), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{max-width:1280px;margin:22px auto;padding:0 16px 28px;}
    .topbar{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:14px 16px;border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .title h1{margin:0;font-size:20px;font-weight:800;color:#fff;letter-spacing:.2px;}
    .title .sub{margin-top:4px;font-size:12px;color:rgba(255,255,255,.75);}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;font-size:12px;font-weight:700;
    }
    .pill .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.7)}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .link{
      text-decoration:none;
      color:#fff;
      font-weight:800;
      font-size:13px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
    }
    .link:hover{background:rgba(255,255,255,.12)}
    .status{
      margin-top:14px;
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
      font-size:13px;color:#222;font-weight:700;
    }
    .status small{font-weight:700;color:#555}

    .card{
      margin-top:14px;
      background: var(--card);
      border:1px solid rgba(0,0,0,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      border-bottom:1px solid rgba(0,0,0,.06);
      background: linear-gradient(180deg, rgba(43,108,255,.10), rgba(255,255,255,0));
    }
    .hd h3{margin:0;font-size:14px;font-weight:900}
    .hd .muted{font-size:12px;color:#5b6578;font-weight:700}
    .body{padding:14px 16px;}

    .controls{
      display:grid;
      grid-template-columns: repeat(14, minmax(0,1fr));
      gap:10px;
      align-items:end;
    }
    .controls .col3{grid-column: span 3;}
    .controls .col2{grid-column: span 2;}
    .controls .col4{grid-column: span 4;}
    .controls .col12{grid-column: span 12;}
    label{display:block;font-size:12px;font-weight:900;color:#2a3140;margin-bottom:6px;}
    input,select,button{
      width:100%;
      padding:10px 12px;
      font-size:14px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.14);
      background:#fff;
      outline:none;
    }
    input:focus,select:focus{border-color: rgba(43,108,255,.65); box-shadow: 0 0 0 4px rgba(43,108,255,.15);}
    button.primary{
      border:none; cursor:pointer;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff; font-weight:900;
      box-shadow: 0 10px 18px rgba(43,108,255,.22);
    }
    button.primary:hover{transform: translateY(-1px);}
    button.ghost{
      cursor:pointer;font-weight:900;
      background: rgba(0,0,0,.03);
    }

    .kpis{
      display:grid;
      grid-template-columns: repeat(12, minmax(0,1fr));
      gap:12px;
      padding:14px 16px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.95));
      border-bottom:1px solid rgba(0,0,0,.06);
    }
    .kpi{
      grid-column: span 2;
      padding:12px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 16px rgba(0,0,0,.08);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute;inset:-40px -40px auto auto;
      width:120px;height:120px;border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(43,108,255,.25), transparent 60%);
      transform: rotate(15deg);
    }
    .kpi .k{font-size:11px;color:#566074;font-weight:900;letter-spacing:.2px;}
    .kpi .v{margin-top:6px;font-size:18px;font-weight:1000;color:#0b0f19;}
    .kpi .s{margin-top:6px;font-size:11px;color:#667085;font-weight:800;}
    .kpi.good:before{background: radial-gradient(circle at 30% 30%, rgba(16,185,129,.25), transparent 60%);}
    .kpi.warn:before{background: radial-gradient(circle at 30% 30%, rgba(245,158,11,.25), transparent 60%);}
    .kpi.bad:before{background: radial-gradient(circle at 30% 30%, rgba(239,68,68,.23), transparent 60%);}

    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
    .chart-box{height:340px;}
    canvas{width:100%!important;height:100%!important;}
    .tablewrap{overflow:auto;border-top:1px solid rgba(0,0,0,.06)}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(0,0,0,.06);font-size:13px;}
    th{position:sticky;top:0;background:#fff;z-index:1;text-align:left;color:#111;font-weight:1000;}
    td.right, th.right{text-align:right;white-space:nowrap;}
    .rowhint{display:flex;gap:10px;flex-wrap:wrap;align-items:center;color:#6a7283;font-weight:800;font-size:12px;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background: rgba(43,108,255,.10);
      border:1px solid rgba(43,108,255,.18);
      color:#1f4ed8;font-weight:1000;font-size:12px;
    }

    @media (max-width: 1100px){
      .grid2{grid-template-columns:1fr;}
      .kpi{grid-column: span 4;}
      .controls .col3{grid-column: span 6;}
      .controls .col2{grid-column: span 6;}
      .controls .col4{grid-column: span 12;}
    }
    @media (max-width: 700px){
      .kpi{grid-column: span 6;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>Income Analytics</h1>
        <div class="sub">Advanced financial insights · paid invoices only</div>
      </div>

      <div class="actions">
        <span class="pill" id="whoami"><span class="dot"></span> checking…</span>
        <a class="link" href="./income.html">← Back to Income</a>
      </div>
    </div>

    <div class="status" id="status">Loading… <small id="statusSub"></small></div>

    <!-- Controls -->
    <div class="card">
      <div class="hd">
        <div>
          <h3>Filters</h3>
          <div class="muted">Choose a date range and currency, then reload.</div>
        </div>
        <div class="rowhint">
          <span class="badge">Tip: use 6–12 months for clean trends</span>
        </div>
      </div>

      <div class="body">
        <div class="controls">
          <div class="col3">
            <label>Date from</label>
            <input type="date" id="fromDate">
          </div>
          <div class="col3">
            <label>Date to</label>
            <input type="date" id="toDate">
          </div>
          <div class="col2">
            <label>Currency</label>
            <select id="currency">
              <option value="CAD" selected>CAD</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <div class="col2">
            <label>Preset</label>
            <select id="preset">
              <option value="6m" selected>Last 6 months</option>
              <option value="3m">Last 3 months</option>
              <option value="12m">Last 12 months</option>
              <option value="ytd">This year</option>
            </select>
          </div>
          <div class="col2">
            <label>&nbsp;</label>
            <button id="reload" class="primary">Reload Analytics</button>
          </div>
        </div>
      </div>
    </div>

    <!-- KPI strip -->
    <div class="card">
      <div class="kpis">
        <div class="kpi" id="kpiRevenueCard">
          <div class="k">Revenue</div>
          <div class="v" id="kpiRevenue">—</div>
          <div class="s">Subtotal (paid)</div>
        </div>
        <div class="kpi" id="kpiCOGSCard">
          <div class="k">COGS</div>
          <div class="v" id="kpiCOGS">—</div>
          <div class="s">Cost of goods</div>
        </div>
        <div class="kpi good" id="kpiProfitCard">
          <div class="k">Invoice Profit</div>
          <div class="v" id="kpiInvProfit">—</div>
          <div class="s">Revenue − COGS</div>
        </div>
        <div class="kpi" id="kpiExpensesCard">
          <div class="k">Expenses</div>
          <div class="v" id="kpiExpenses">—</div>
          <div class="s">Selected range</div>
        </div>
        <div class="kpi" id="kpiDeliveryCard">
          <div class="k">Delivery</div>
          <div class="v" id="kpiDelivery">—</div>
          <div class="s">Delivery income</div>
        </div>
        <div class="kpi" id="kpiNetCard">
          <div class="k">Net Profit</div>
          <div class="v" id="kpiNet">—</div>
          <div class="s">Profit − Expenses</div>
        </div>
        <div class="kpi" id="kpiMarginCard">
          <div class="k">Margin</div>
          <div class="v" id="kpiMargin">—</div>
          <div class="s">Invoice margin %</div>
        </div>
      </div>

      <div class="body">
        <div class="grid2">
          <div>
            <div class="hd" style="border:none;background:none;padding:0 0 10px 0;">
              <div>
                <h3>Revenue · COGS · Net Profit</h3>
                <div class="muted">Monthly trend. Refunds are optionally deducted if statuses exist.</div>
              </div>
            </div>
            <div class="chart-box"><canvas id="chartTrend"></canvas></div>
          </div>

          <div>
            <div class="hd" style="border:none;background:none;padding:0 0 10px 0;">
              <div>
                <h3>Net Profit Waterfall</h3>
                <div class="muted">Revenue → COGS → Profit → Expenses → Net</div>
              </div>
            </div>
            <div class="chart-box"><canvas id="chartWaterfall"></canvas></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Expenses + category -->
    <div class="grid3">
      <div class="card">
        <div class="hd">
          <div>
            <h3>Expenses by Category</h3>
            <div class="muted">Top categories in selected range</div>
          </div>
        </div>
        <div class="body">
          <div class="chart-box" style="height:320px"><canvas id="chartExpBar"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Expense Distribution</h3>
            <div class="muted">Share by category</div>
          </div>
        </div>
        <div class="body">
          <div class="chart-box" style="height:320px"><canvas id="chartExpPie"></canvas></div>
        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <h3>Monthly Expenses</h3>
            <div class="muted">Trend within selected months</div>
          </div>
        </div>
        <div class="body">
          <div class="chart-box" style="height:320px"><canvas id="chartExpTrend"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Products -->
    <div class="card">
      <div class="hd">
        <div>
          <h3>Product Profit & Margins</h3>
          <div class="muted">Top products by profit + full table</div>
        </div>
      </div>

      <div class="body">
        <div class="grid2">
          <div>
            <div class="chart-box" style="height:380px"><canvas id="chartProductsProfit"></canvas></div>
          </div>
          <div>
            <div class="chart-box" style="height:380px"><canvas id="chartProductsMargin"></canvas></div>
          </div>
        </div>
      </div>

      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th class="right">Revenue</th>
              <th class="right">COGS</th>
              <th class="right">Profit</th>
              <th class="right">Margin %</th>
            </tr>
          </thead>
          <tbody id="productProfitTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
import { supabase } from "../supabaseClient.js";

/* =============================
   UI helpers
   ============================= */
const statusEl = document.getElementById("status");
const statusSubEl = document.getElementById("statusSub");
const whoEl = document.getElementById("whoami");

function show(msg, sub=""){
  statusEl.firstChild.textContent = msg + " ";
  statusSubEl.textContent = sub || "";
}
function money(n){
  const x = Number(n || 0);
  if (!Number.isFinite(x)) return "0.00";
  return x.toFixed(2);
}
function pct(n){
  const x = Number(n || 0);
  if (!Number.isFinite(x)) return "0.0";
  return x.toFixed(1);
}
function destroy(c){ try{ if(c) c.destroy(); }catch{} return null; }

function setKpi(el, val){ el.textContent = val; }

/* =============================
   Elements
   ============================= */
const fromEl = document.getElementById("fromDate");
const toEl = document.getElementById("toDate");
const currEl = document.getElementById("currency");
const presetEl = document.getElementById("preset");
const reloadBtn = document.getElementById("reload");

const kpiRevenue = document.getElementById("kpiRevenue");
const kpiCOGS = document.getElementById("kpiCOGS");
const kpiInvProfit = document.getElementById("kpiInvProfit");
const kpiExpenses = document.getElementById("kpiExpenses");
const kpiDelivery = document.getElementById("kpiDelivery");
const kpiNet = document.getElementById("kpiNet");
const kpiMargin = document.getElementById("kpiMargin");

const kpiDeliveryCard = document.getElementById("kpiDeliveryCard");
const kpiNetCard = document.getElementById("kpiNetCard");
const kpiMarginCard = document.getElementById("kpiMarginCard");

const chartTrendEl = document.getElementById("chartTrend");
const chartWaterfallEl = document.getElementById("chartWaterfall");
const chartExpPieEl = document.getElementById("chartExpPie");
const chartExpBarEl = document.getElementById("chartExpBar");
const chartExpTrendEl = document.getElementById("chartExpTrend");
const chartProductsProfitEl = document.getElementById("chartProductsProfit");
const chartProductsMarginEl = document.getElementById("chartProductsMargin");
const productProfitTbody = document.getElementById("productProfitTbody");

let chartTrend=null, chartWaterfall=null, chartExpPie=null, chartExpBar=null, chartExpTrend=null, chartProductsProfit=null, chartProductsMargin=null;

/* =============================
   Chart defaults (nice look)
   ============================= */
Chart.defaults.font.family = "Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif";
Chart.defaults.color = "#2a3140";
Chart.defaults.plugins.tooltip.backgroundColor = "rgba(15, 23, 42, .92)";
Chart.defaults.plugins.tooltip.titleColor = "#fff";
Chart.defaults.plugins.tooltip.bodyColor = "#fff";
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 12;
Chart.defaults.plugins.legend.labels.boxWidth = 10;
Chart.defaults.plugins.legend.labels.boxHeight = 10;

/* =============================
   Color helpers
   ============================= */
const PALETTE = [
  "#2563eb","#16a34a","#dc2626","#7c3aed","#ea580c",
  "#0891b2","#9333ea","#65a30d","#f59e0b","#0d9488",
  "#be123c","#1d4ed8","#15803d","#b45309","#6d28d9"
];
function pickColors(n){
  const out=[];
  for(let i=0;i<n;i++){ out.push(PALETTE[i % PALETTE.length]); }
  return out;
}

/* =============================
   Auth (ADMIN)
   ============================= */
async function requireAdmin(){
  show("Checking login…");
  const { data: { user }, error: uErr } = await supabase.auth.getUser();
  if (uErr) throw uErr;
  if (!user){ location.href = "../login.html"; return null; }

  whoEl.innerHTML = `<span class="dot"></span> ${user.email || "admin"}`;

  show("Checking admin…");
  const { data: me, error: pErr } = await supabase
    .from("profiles")
    .select("is_admin")
    .eq("id", user.id)
    .single();

  if (pErr) throw pErr;
  if (!me?.is_admin) throw new Error("Access denied (not admin)");

  whoEl.innerHTML = `<span class="dot" style="background:rgba(16,185,129,.9)"></span> ${(user.email || "admin")} (admin)`;
  return user;
}

/* =============================
   Date presets
   ============================= */
function iso(d){ return d.toISOString().slice(0,10); }
function applyPreset(){
  const today = new Date();
  let from = new Date(today);
  const p = presetEl.value;

  if (p === "3m") from.setMonth(from.getMonth()-3);
  else if (p === "6m") from.setMonth(from.getMonth()-6);
  else if (p === "12m") from.setMonth(from.getMonth()-12);
  else if (p === "ytd"){ from = new Date(today.getFullYear(), 0, 1); }

  fromEl.value = iso(from);
  toEl.value = iso(today);
}
applyPreset();

/* =============================
   Data loaders
   ============================= */
async function loadMonthlyFinancials(from, to, curr){
  const { data, error } = await supabase
    .from("v_monthly_financials")
    .select("month_start, currency, revenue_total, subtotal_total, invoice_profit, delivery_income, expenses_total, net_profit")
    .eq("currency", curr)
    .gte("month_start", from)
    .lte("month_start", to)
    .order("month_start", { ascending: true });

  if (error) throw error;
  return data || [];
}

async function loadRefundMonthly(from, to, curr){
  const { data, error } = await supabase
    .from("invoices")
    .select("invoice_date, total, currency, status")
    .eq("currency", curr)
    .in("status", ["refunded", "refund", "returned"])
    .gte("invoice_date", from)
    .lte("invoice_date", to)
    .limit(5000);

  // if refunds flow not present, ignore
  if (error) return [];
  return data || [];
}

async function loadExpensesRaw(from, to, curr){
  const { data, error } = await supabase
    .from("expenses")
    .select("expense_date, category, amount, currency")
    .eq("currency", curr)
    .gte("expense_date", from)
    .lte("expense_date", to)
    .limit(20000);

  if (error) throw error;
  return data || [];
}

async function loadProductItems(from, to, curr){
  const { data, error } = await supabase
    .from("invoice_items")
    .select(`
      qty,
      unit_price,
      unit_cost,
      product:products(name),
      invoice:invoices!inner(status, currency, invoice_date)
    `)
    .eq("invoice.status", "paid")
    .eq("invoice.currency", curr)
    .gte("invoice.invoice_date", from)
    .lte("invoice.invoice_date", to)
    .limit(100000);

  if (error) throw error;
  return data || [];
}

/* =============================
   Render helpers
   ============================= */
function renderProductTable(rows){
  productProfitTbody.innerHTML = "";
  for (const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.name}</td>
      <td class="right">${money(r.revenue)}</td>
      <td class="right">${money(r.cogs)}</td>
      <td class="right">${money(r.profit)}</td>
      <td class="right">${pct(r.margin)}%</td>
    `;
    productProfitTbody.appendChild(tr);
  }
}

function toMonthBucket(isoDate){
  const d = String(isoDate || "").slice(0,10);
  if (!d) return null;
  return d.slice(0,7) + "-01";
}

/* =============================
   Charts
   ============================= */
function renderTrendChart(labels, revenueNet, cogs, net, refunds){
  chartTrend = destroy(chartTrend);
  chartTrend = new Chart(chartTrendEl, {
    type: "line",
    data: {
      labels,
      datasets: [
        { label: "Revenue (Net)", data: revenueNet, borderWidth: 3, tension: 0.28, pointRadius: 2 },
        { label: "COGS", data: cogs, borderWidth: 3, tension: 0.28, pointRadius: 2 },
        { label: "Net Profit", data: net, borderWidth: 3, tension: 0.28, pointRadius: 2 },
        { label: "Refunds", data: refunds, borderWidth: 2, borderDash: [6,6], tension: 0.28, pointRadius: 0 }
      ]
    },
    options: {
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:"index", intersect:false },
      plugins:{ legend:{ display:true } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ grid:{ display:false } }
      }
    }
  });
}

function renderWaterfall(revenue, cogs, profit, expenses, net){
  // simple waterfall using stacked bars (positive + negative)
  const labels = ["Revenue","COGS","Profit","Expenses","Net"];
  const base = [0, revenue, revenue - cogs, revenue - cogs, revenue - cogs - expenses];
  const step = [revenue, -cogs, profit, -expenses, net];

  chartWaterfall = destroy(chartWaterfall);
  chartWaterfall = new Chart(chartWaterfallEl, {
    type:"bar",
    data:{
      labels,
      datasets:[
        { label:"Base", data: base, stack:"s", borderWidth:0 },
        { label:"Step", data: step, stack:"s", borderWidth:0 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{
        label: (ctx) => {
          const v = Number(ctx.raw||0);
          if (ctx.dataset.label === "Base") return null;
          return ` ${v>=0?"+":""}${money(v)}`;
        }
      }}},
      scales:{
        y:{ beginAtZero:true, stacked:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ stacked:true, grid:{ display:false } }
      }
    }
  });
}

function renderExpensesPie(labels, values){
  chartExpPie = destroy(chartExpPie);
  chartExpPie = new Chart(chartExpPieEl, {
    type:"doughnut",
    data:{ labels, datasets:[{ data: values, backgroundColor: pickColors(values.length), borderWidth:0 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      cutout:"62%",
      plugins:{ legend:{ position:"bottom" } }
    }
  });
}

function renderExpensesBar(labels, values){
  chartExpBar = destroy(chartExpBar);
  chartExpBar = new Chart(chartExpBarEl, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Expenses", data: values, backgroundColor: pickColors(values.length), borderWidth:0 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ grid:{ display:false } }
      }
    }
  });
}

function renderExpensesTrend(labels, values){
  chartExpTrend = destroy(chartExpTrend);
  chartExpTrend = new Chart(chartExpTrendEl, {
    type:"line",
    data:{ labels, datasets:[{ label:"Expenses", data: values, borderWidth:3, tension:.28, pointRadius:2 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ grid:{ display:false } }
      }
    }
  });
}

function renderProductsProfit(labels, profits){
  chartProductsProfit = destroy(chartProductsProfit);
  chartProductsProfit = new Chart(chartProductsProfitEl, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Profit", data: profits, backgroundColor: pickColors(profits.length), borderWidth:0 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ grid:{ display:false } }
      }
    }
  });
}

function renderProductsMargin(labels, margins){
  chartProductsMargin = destroy(chartProductsMargin);
  chartProductsMargin = new Chart(chartProductsMarginEl, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Margin %", data: margins, backgroundColor: pickColors(margins.length), borderWidth:0 }] },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(ctx)=>` ${pct(ctx.raw)}%` } } },
      scales:{
        y:{ beginAtZero:true, grid:{ color:"rgba(0,0,0,.06)" } },
        x:{ grid:{ display:false } }
      }
    }
  });
}

/* =============================
   Main load
   ============================= */
async function loadAll(){
  const from = fromEl.value;
  const to = toEl.value;
  const curr = currEl.value;

  show("Loading analytics…", `${from} → ${to} · ${curr}`);

  const [monthly, refunds, expenses, items] = await Promise.all([
    loadMonthlyFinancials(from, to, curr),
    loadRefundMonthly(from, to, curr),
    loadExpensesRaw(from, to, curr),
    loadProductItems(from, to, curr),
  ]);

  // Trend values
  const labels = monthly.map(r => String(r.month_start));
  const revenuePaid = monthly.map(r => Number(r.revenue_total || 0));
  const cogs = monthly.map(r => Number(r.subtotal_total || 0) - Number(r.invoice_profit || 0));
  const net = monthly.map(r => Number(r.net_profit || 0));

  // Refunds month bucket
  const refundMap = new Map();
  for (const r of (refunds || [])){
    const m = toMonthBucket(r.invoice_date);
    if (!m) continue;
    refundMap.set(m, (refundMap.get(m) || 0) + Number(r.total || 0));
  }
  const refundsByMonth = labels.map(m => Number(refundMap.get(m) || 0));
  const revenueNet = revenuePaid.map((v,i)=> v - refundsByMonth[i]);

  renderTrendChart(labels, revenueNet, cogs, net, refundsByMonth);

  // KPI totals
  const sum = (arr)=> arr.reduce((s,v)=> s + Number(v||0), 0);
  // KPI totals
  // IMPORTANT: Use the system's stored invoice_profit values (from v_monthly_financials),
  // not a derived Revenue-COGS calculation. This keeps KPIs consistent with your invoices.
  const revenueTotal = sum(revenueNet);
  const cogsTotal = sum(cogs);

  const invProfitSeries = monthly.map(r => Number(r.invoice_profit || 0));
  const invProfitTotal = sum(invProfitSeries);

  const deliverySeries = monthly.map(r => Number(r.delivery_income || 0));
  const deliveryTotal = sum(deliverySeries);

  const expenseTotal = expenses.reduce((s,r)=> s + Number(r.amount||0), 0);
  const netTotal = invProfitTotal + deliveryTotal - expenseTotal;

  const margin = revenueTotal > 0 ? (invProfitTotal / revenueTotal) * 100 : 0;

  setKpi(kpiRevenue, money(revenueTotal));
  setKpi(kpiCOGS, money(cogsTotal));
  setKpi(kpiInvProfit, money(invProfitTotal));
  setKpi(kpiExpenses, money(expenseTotal));
  setKpi(kpiDelivery, money(deliveryTotal));
  setKpi(kpiNet, money(netTotal));
  setKpi(kpiMargin, `${pct(margin)}%`);

  // Net card coloring
  kpiNetCard.classList.remove("good","warn","bad");
  if (netTotal >= 0) kpiNetCard.classList.add("good");
  else kpiNetCard.classList.add("bad");

  kpiMarginCard.classList.remove("good","warn","bad");
  if (margin >= 35) kpiMarginCard.classList.add("good");
  else if (margin >= 20) kpiMarginCard.classList.add("warn");
  else kpiMarginCard.classList.add("bad");

  renderWaterfall(revenueTotal, cogsTotal, invProfitTotal + deliveryTotal, expenseTotal, netTotal);

  // Expenses by category
  const catMap = new Map();
  const monthExpMap = new Map();
  for (const r of (expenses || [])){
    const cat = r.category || "other";
    catMap.set(cat, (catMap.get(cat) || 0) + Number(r.amount || 0));

    const m = toMonthBucket(r.expense_date);
    if (m) monthExpMap.set(m, (monthExpMap.get(m) || 0) + Number(r.amount || 0));
  }

  const catSorted = Array.from(catMap.entries()).sort((a,b)=> b[1]-a[1]);
  const topCats = catSorted.slice(0,10);
  const pieLabels = topCats.map(([k])=>k);
  const pieValues = topCats.map(([,v])=>Number(v||0));
  renderExpensesPie(pieLabels, pieValues);
  renderExpensesBar(pieLabels, pieValues);

  // Monthly expense trend aligned to trend labels (month_start)
  const expTrend = labels.map(m => Number(monthExpMap.get(m) || 0));
  renderExpensesTrend(labels, expTrend);

  // Products aggregation
  const prodMap = new Map();
  for (const r of (items || [])){
    const name = r.product?.name || "Unknown";
    if (!prodMap.has(name)) prodMap.set(name, { revenue:0, cogs:0 });

    const qty = Number(r.qty || 0);
    const price = Number(r.unit_price || 0);
    const cost = Number(r.unit_cost || 0);

    const row = prodMap.get(name);
    row.revenue += qty * price;
    row.cogs += qty * cost;
  }

  const rows = Array.from(prodMap.entries()).map(([name, v]) => {
    const profit = v.revenue - v.cogs;
    const margin = v.revenue > 0 ? (profit / v.revenue) * 100 : 0;
    return { name, revenue: v.revenue, cogs: v.cogs, profit, margin };
  }).sort((a,b)=> b.profit - a.profit);

  renderProductTable(rows);

  const top = rows.slice(0,12);
  renderProductsProfit(top.map(r=>r.name), top.map(r=>r.profit));
  renderProductsMargin(top.map(r=>r.name), top.map(r=>r.margin));

  show("Done ✅", `${from} → ${to} · ${curr} · ${labels.length} months · ${rows.length} products`);
}

/* =============================
   Events + boot
   ============================= */
presetEl.addEventListener("change", () => {
  applyPreset();
});

reloadBtn.addEventListener("click", async () => {
  try { await loadAll(); }
  catch (e){
    console.error(e);
    show("ERROR: " + (e?.message || String(e)));
  }
});

try{
  await requireAdmin();
  await loadAll();
}catch(e){
  console.error(e);
  show("ERROR: " + (e?.message || String(e)));
}
</script>
</body>
</html>
