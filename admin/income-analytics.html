<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Executive Financial Intelligence | Pro Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Premium Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Chart.js & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --brand: #6366f1;
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --bg: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --radius-lg: 24px;
      --radius-md: 16px;
    }

    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.15) 0px, transparent 50%);
      color: var(--text-main);
      min-height: 100vh;
      padding-bottom: 60px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    /* Header Section */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .brand-title h1 {
      font-size: 32px;
      font-weight: 800;
      margin: 0;
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.03em;
    }

    .brand-title p {
      color: var(--text-muted);
      margin: 4px 0 0;
      font-size: 16px;
    }

    .nav-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-glass {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      backdrop-filter: blur(10px);
    }

    .btn-glass:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .btn-primary {
      background: var(--brand-gradient);
      border: none;
      color: white;
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .kpi-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      padding: 28px;
      border-radius: var(--radius-lg);
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; width: 100%; height: 4px;
      background: var(--brand-gradient);
      opacity: 0.5;
    }

    .kpi-label {
      color: var(--text-muted);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .kpi-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 36px;
      font-weight: 700;
      margin: 12px 0;
      display: block;
    }

    .kpi-trend {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }

    /* Main Dashboard Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      padding: 32px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .chart-wrap {
      height: 400px;
      width: 100%;
      position: relative;
    }

    /* Controls Bar */
    .controls-bar {
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid var(--glass-border);
      padding: 16px 24px;
      border-radius: 20px;
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 40px;
      backdrop-filter: blur(10px);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .control-group label {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .controls-bar input, .controls-bar select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
    }

    /* Table Styling */
    .table-container {
      margin-top: 24px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      border-bottom: 1px solid var(--glass-border);
    }

    td {
      padding: 16px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header class="header">
      <div class="brand-title">
        <h1>Financial Intelligence Pro</h1>
        <p>Executive Oversight & Profitability Analytics</p>
      </div>
      <div class="nav-actions">
        <span id="statusIndicator" class="badge badge-success" style="margin-right: 10px;">System Live</span>
        <a href="./income.html" class="btn btn-glass">Back to Ledger</a>
      </div>
    </header>

    <!-- Controls -->
    <div class="controls-bar">
      <div class="control-group">
        <label>Start Date</label>
        <input type="date" id="fromDate">
      </div>
      <div class="control-group">
        <label>End Date</label>
        <input type="date" id="toDate">
      </div>
      <div class="control-group">
        <label>Currency</label>
        <select id="currency">
          <option value="CAD">CAD - Canadian Dollar</option>
          <option value="USD">USD - US Dollar</option>
        </select>
      </div>
      <div style="flex-grow: 1;"></div>
      <button id="reload" class="btn btn-primary">Sync Real-time Data</button>
    </div>

    <!-- KPI Section -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Gross Revenue</div>
        <span class="kpi-value" id="kpiRevenue">$0.00</span>
        <div class="kpi-trend trend-up">â†‘ 12.4% vs prev. period</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">COGS & Direct Costs</div>
        <span class="kpi-value" id="kpiCOGS" style="color: var(--warning);">$0.00</span>
        <div class="kpi-trend">Efficiency: <span id="cogsRatio" style="margin-left:5px;">0%</span></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Net Operating Profit</div>
        <span class="kpi-value" id="kpiNetProfit" style="color: var(--success);">$0.00</span>
        <div class="kpi-trend trend-up">Margin: <span id="netMargin" style="margin-left:5px;">0%</span></div>
      </div>
    </div>

    <!-- Primary Analytics -->
    <div class="dashboard-grid">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Revenue vs. COGS vs. Net Profit</h3>
          <div class="badge badge-success">Monthly Aggregation</div>
        </div>
        <div class="chart-wrap">
          <canvas id="mainChart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Expense Distribution</h3>
        </div>
        <div class="chart-wrap">
          <canvas id="expenseChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Secondary Analytics -->
    <div class="dashboard-grid" style="grid-template-columns: 1fr 1fr;">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Profitability by Product Category</h3>
        </div>
        <div class="chart-wrap" style="height: 300px;">
          <canvas id="productChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Top Performing Assets</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Asset Name</th>
                <th>Revenue</th>
                <th>Profit</th>
                <th>Margin</th>
              </tr>
            </thead>
            <tbody id="productTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script type="module">
import { supabase } from "../supabaseClient.js";

/* =============================
   Advanced Chart Config
   ============================= */
const THEME = {
  revenue: {
    border: '#6366f1',
    bg: 'rgba(99, 102, 241, 0.2)',
    gradient: (ctx) => {
      const g = ctx.createLinearGradient(0, 0, 0, 400);
      g.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
      g.addColorStop(1, 'rgba(99, 102, 241, 0)');
      return g;
    }
  },
  cogs: {
    border: '#f59e0b',
    bg: 'rgba(245, 158, 11, 0.2)',
  },
  profit: {
    border: '#10b981',
    bg: 'rgba(16, 185, 129, 0.2)',
    gradient: (ctx) => {
      const g = ctx.createLinearGradient(0, 0, 0, 400);
      g.addColorStop(0, 'rgba(16, 185, 129, 0.4)');
      g.addColorStop(1, 'rgba(16, 185, 129, 0)');
      return g;
    }
  }
};

let charts = {};

function formatCurrency(val) {
  return new Intl.NumberFormat('en-CA', {
    style: 'currency',
    currency: document.getElementById('currency').value,
    maximumFractionDigits: 0
  }).format(val);
}

/* =============================
   Data Engine
   ============================= */
async function loadDashboard() {
  const from = document.getElementById('fromDate').value;
  const to = document.getElementById('toDate').value;
  const curr = document.getElementById('currency').value;

  // 1. Monthly Financials (Revenue, COGS, Net)
  const { data: monthly } = await supabase
    .from("v_monthly_financials")
    .select("*")
    .eq("currency", curr)
    .gte("month_start", from)
    .lte("month_start", to)
    .order("month_start", { ascending: true });

  // 2. Expenses
  const { data: expenses } = await supabase
    .from("expenses")
    .select("*")
    .eq("currency", curr)
    .gte("expense_date", from)
    .lte("expense_date", to);

  // 3. Product Details (for COGS & Margins)
  const { data: items } = await supabase
    .from("invoice_items")
    .select("qty, unit_price, unit_cost, product:products(name), invoice:invoices!inner(status, currency, invoice_date)")
    .eq("invoice.status", "paid")
    .eq("invoice.currency", curr)
    .gte("invoice.invoice_date", from)
    .lte("invoice.invoice_date", to);

  renderMainChart(monthly);
  renderExpenseChart(expenses);
  processProductData(items);
}

function renderMainChart(data) {
  const ctx = document.getElementById('mainChart').getContext('2d');
  if (charts.main) charts.main.destroy();

  charts.main = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.map(d => new Date(d.month_start).toLocaleDateString('en-US', { month: 'short', year: '2-digit' })),
      datasets: [
        {
          label: 'Gross Revenue',
          data: data.map(d => d.revenue_total),
          borderColor: THEME.revenue.border,
          backgroundColor: THEME.revenue.gradient(ctx),
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0,
          pointHoverRadius: 6
        },
        {
          label: 'COGS',
          data: data.map(d => Number(d.subtotal_total || 0) - Number(d.invoice_profit || 0)),
          borderColor: THEME.cogs.border,
          borderDash: [5, 5],
          borderWidth: 2,
          pointRadius: 0,
          fill: false
        },
        {
          label: 'Net Profit',
          data: data.map(d => d.net_profit),
          borderColor: THEME.profit.border,
          backgroundColor: THEME.profit.gradient(ctx),
          fill: true,
          tension: 0.4,
          borderWidth: 3,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, labels: { color: '#94a3b8', font: { family: 'Plus Jakarta Sans', weight: '600' } } },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 },
          padding: 15,
          borderColor: 'rgba(255,255,255,0.1)',
          borderWidth: 1,
          callbacks: { label: (c) => ` ${c.dataset.label}: ${formatCurrency(c.raw)}` }
        }
      },
      scales: {
        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', callback: (v) => formatCurrency(v) } },
        x: { grid: { display: false }, ticks: { color: '#64748b' } }
      }
    }
  });
}

function renderExpenseChart(data) {
  const ctx = document.getElementById('expenseChart').getContext('2d');
  if (charts.expense) charts.expense.destroy();

  const cats = {};
  data.forEach(e => cats[e.category] = (cats[e.category] || 0) + Number(e.amount));
  const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);

  charts.expense = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: sorted.map(s => s[0]),
      datasets: [{
        data: sorted.map(s => s[1]),
        backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'],
        borderWidth: 0,
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      cutout: '75%',
      plugins: {
        legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20, usePointStyle: true } }
      }
    }
  });
}

function processProductData(items) {
  const products = {};
  let totalRev = 0, totalCogs = 0, totalProfit = 0;

  items.forEach(i => {
    const name = i.product?.name || "Unknown";
    if (!products[name]) products[name] = { rev: 0, cogs: 0, profit: 0 };
    
    const rev = Number(i.qty) * Number(i.unit_price);
    const cogs = Number(i.qty) * Number(i.unit_cost);
    
    products[name].rev += rev;
    products[name].cogs += cogs;
    products[name].profit += (rev - cogs);
    
    totalRev += rev;
    totalCogs += cogs;
    totalProfit += (rev - cogs);
  });

  // Update KPIs
  document.getElementById('kpiRevenue').textContent = formatCurrency(totalRev);
  document.getElementById('kpiCOGS').textContent = formatCurrency(totalCogs);
  document.getElementById('kpiNetProfit').textContent = formatCurrency(totalProfit);
  document.getElementById('cogsRatio').textContent = totalRev > 0 ? ((totalCogs / totalRev) * 100).toFixed(1) + '%' : '0%';
  document.getElementById('netMargin').textContent = totalRev > 0 ? ((totalProfit / totalRev) * 100).toFixed(1) + '%' : '0%';

  const sorted = Object.entries(products).map(([name, v]) => ({ name, ...v })).sort((a,b) => b.profit - a.profit);
  
  // Table
  const tbody = document.getElementById('productTable');
  tbody.innerHTML = sorted.slice(0, 5).map(p => `
    <tr>
      <td style="font-weight:600;">${p.name}</td>
      <td class="font-mono">${formatCurrency(p.rev)}</td>
      <td class="font-mono" style="color:var(--success);">${formatCurrency(p.profit)}</td>
      <td><span class="badge badge-success">${((p.profit/p.rev)*100).toFixed(0)}%</span></td>
    </tr>
  `).join('');

  // Product Chart
  const ctx = document.getElementById('productChart').getContext('2d');
  if (charts.product) charts.product.destroy();
  charts.product = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sorted.slice(0, 6).map(p => p.name),
      datasets: [{
        label: 'Profit Contribution',
        data: sorted.slice(0, 6).map(p => p.profit),
        backgroundColor: 'rgba(99, 102, 241, 0.8)',
        borderRadius: 10
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false }, ticks: { color: '#64748b' } },
        y: { grid: { display: false }, ticks: { color: '#f8fafc' } }
      }
    }
  });
}

/* =============================
   Init
   ============================= */
(async () => {
  // Set default dates (last 6 months)
  const to = new Date();
  const from = new Date();
  from.setMonth(from.getMonth() - 6);
  document.getElementById('toDate').value = to.toISOString().slice(0,10);
  document.getElementById('fromDate').value = from.toISOString().slice(0,10);

  await loadDashboard();
})();

document.getElementById('reload').addEventListener('click', loadDashboard);
</script>
</body>
</html>
