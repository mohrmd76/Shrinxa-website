<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Shrinxa Admin – Platinum Prices</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --brand:#111;
      --ring: rgba(99,102,241,.25);
    }

    body{ background:var(--bg); color:var(--ink); margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif; }

    header{
      background:var(--brand);
      position:sticky;
      top:0;
      z-index:60;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }
    header a{
      color:#fff;
      text-decoration:none;
      opacity:.85;
      padding:6px 8px;
      border-radius:10px;
      white-space:nowrap;
    }
    header a:hover{ opacity:1; background:rgba(255,255,255,.08); }
    header a.active{ opacity:1; background:rgba(255,255,255,.14); }
    .nav-links{ gap:6px; flex-wrap:wrap; }

    .page-title{ font-weight:800; letter-spacing:.2px; }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 10px 30px rgba(17,24,39,.08);
    }

    .statusbar{
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      padding:10px 12px;
      background:#fff;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusbar .hint{ color:var(--muted); font-size:.875rem; }

    .form-control:focus, .form-select:focus{
      box-shadow:0 0 0 .25rem var(--ring);
      border-color:rgba(99,102,241,.5);
    }

    .table-wrap{
      max-height: calc(100vh - 270px);
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.08);
      background:#fff;
    }

    table{
      border-collapse:separate !important;
      border-spacing:0;
      width:100%;
      min-width: 720px;
    }

    thead th{
      position:sticky;
      top:0;
      z-index:5;
      background:#f8fafc !important;
      border-bottom:1px solid rgba(17,24,39,.08) !important;
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#475569;
      white-space:nowrap;
    }

    tbody tr:hover{ background:#fafafa; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: .82rem; }
    .muted{ color:var(--muted); font-size:.875rem; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 10px;
      border:1px solid rgba(17,24,39,.12);
      border-radius:999px;
      font-size:.78rem;
      background:#fff;
      color:#334155;
    }

    .btn{ border-radius:12px; }
  </style>
</head>

<body>
<header class="py-3">
  <div class="container-fluid px-4 d-flex align-items-center gap-3">
    <div class="text-white fw-bold">Shrinxa Admin</div>

    <div class="d-flex nav-links">
      <a href="./dashboard.html">Dashboard</a>
      <a href="./orders.html">Orders</a>
      <a href="./customers.html">Customers</a>
      <a href="./products-admin.html">Products</a>
      <a href="./platinum.html" class="active">Platinum</a>
      <a href="./delivery-admin.html">Delivery Rules</a>
      <a href="./inventory.html">Inventory</a>
      <a href="./income.html">Income</a>
      <a href="./clients.html">Clients</a>
      <a href="./cash.html">Cash</a>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="adminEmail" class="text-white small opacity-75"></span>
      <button id="logoutBtn" class="btn btn-sm btn-outline-light">Logout</button>
    </div>
  </div>
</header>

<main class="container-fluid px-4 py-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <div class="page-title h3 m-0">Platinum Prices</div>
      <div class="muted">Per-customer overrides (Retail + Wholesale). Leave blank to use normal tier pricing.</div>
    </div>
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <span class="pill"><span class="mono">public.platinum_prices</span></span>
      <span class="pill"><span class="mono">public.products</span></span>
    </div>
  </div>

  <div class="card p-3">
    <div class="statusbar mb-3">
      <div class="d-flex gap-3 align-items-center flex-wrap">
        <div class="input-group" style="max-width: 680px;">
          <span class="input-group-text">Customer</span>
          <select id="customerSelect" class="form-select"></select>
          <button id="loadBtn" class="btn btn-primary" type="button">Load</button>
        </div>

        <div class="hint">Choose a Platinum customer → Load → Save overrides per product.</div>
      </div>
      <div id="status" class="text-nowrap fw-semibold text-muted">Loading…</div>
    </div>

    <div class="table-wrap">
      <table class="table table-sm table-hover align-middle m-0">
        <thead>
          <tr>
            <th style="min-width:280px;">Product</th>
            <th style="min-width:140px;">Retail</th>
            <th style="min-width:140px;">Wholesale</th>
            <th style="min-width:120px;">Save</th>
            <th style="min-width:120px;">Clear</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>
</main>

<script src="/assets/admin-analytics.js" defer></script>
<script type="module">
import { supabase } from "../supabaseClient.js";
const adminEmailEl = document.getElementById("adminEmail");
const logoutBtn = document.getElementById("logoutBtn");

logoutBtn?.addEventListener("click", async () => {
  await supabase.auth.signOut();
  window.location.href = "../login.html";
});

    const status = document.getElementById("status");
    const customerSelect = document.getElementById("customerSelect");
    const loadBtn = document.getElementById("loadBtn");
    const rows = document.getElementById("rows");

    const show = (m) => status.textContent = m;
    let currentUser = null;

            // Audit log writer (DEBUG - shows exact insert failure)
    async function writeAuditLog(action, data) {
      const row = {
        action: action,
        entity: "platinum_prices",
        entity_id: data.product_id || null,
        customer_id: data.customer_id || null,
        admin_id: currentUser?.id || null,
        admin_email: currentUser?.email || null,
        before_data: data.before || null,
        after_data: data.after || null,
        created_at: new Date().toISOString(),
      };

      // Do NOT block the UI action, but show the real error if it fails
      const { error } = await supabase.from("audit_logs").insert(row);

      if (error) {
        try { console.error("[AUDIT INSERT FAILED]", error); } catch (_) {}
        try { show("AUDIT ERROR: " + error.message); } catch (_) {}
        return;
      }

      try { console.log("[AUDIT INSERT OK]", row); } catch (_) {}
      try { show("Saved ✅ (audit ok)"); } catch (_) {}
    }






    async function mustBeAdmin() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href = "../login.html"; throw ""; }
      currentUser = user;

if (adminEmailEl) adminEmailEl.textContent = user.email || "";


      const { data: me, error } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("id", user.id)
        .single();

      if (error || !me?.is_admin) { document.body.innerHTML = "Access denied"; throw ""; }
      return user;
    }

    async function loadPlatinumCustomers() {
      show("Loading platinum customers…");
      const { data, error } = await supabase
        .from("profiles")
        .select("id, email, full_name")
        .eq("tier", "platinum")
        .order("created_at", { ascending: false });

      if (error) throw new Error(error.message);

      customerSelect.innerHTML = `<option value="">-- select --</option>`;
      for (const c of (data || [])) {
        const name = String(c.full_name || "").trim();
        const email = String(c.email || "").trim();
        const label = (name && email) ? `${name} — ${email}` : (name || email || c.id);
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = label;
        customerSelect.appendChild(opt);
      }
    }

    async function loadProductsAndPrices(customerId) {
      if (!customerId) { show("Select a customer"); return; }

      show("Loading products…");
  const { data: products, error: pErr } = await supabase
  .from("products")
  .select("id, name")
  .eq("is_active", true)
  .is("deleted_at", null)
  .order("name");

      if (pErr) throw new Error(pErr.message);

      show("Loading customer platinum prices…");
      const { data: prices, error: prErr } = await supabase
        .from("platinum_prices")
        .select("product_id, retail_price, wholesale_price")
        .eq("customer_id", customerId);

      if (prErr) throw new Error(prErr.message);

      const map = new Map((prices || []).map(x => [x.product_id, x]));

      rows.innerHTML = "";
      for (const prod of (products || [])) {
        const existing = map.get(prod.id);
        const retail = existing?.retail_price ?? "";
        const wholesale = existing?.wholesale_price ?? "";

            const tr = document.createElement("tr");
        tr.dataset.pid = prod.id;

        // store "before" values for audit logs
        tr.dataset.beforeRetail = (retail === "" || retail === null || retail === undefined) ? "" : String(retail);
        tr.dataset.beforeWholesale = (wholesale === "" || wholesale === null || wholesale === undefined) ? "" : String(wholesale);
        tr.dataset.productName = String(prod.name || "");

        tr.innerHTML = `
          <td>${prod.name}</td>
          <td><input class="ret form-control form-control-sm" type="number" step="0.01" min="0" value="${retail}" style="width:120px"></td>
          <td><input class="wh form-control form-control-sm" type="number" step="0.01" min="0" value="${wholesale}" style="width:120px"></td>
          <td><button class="saveBtn btn btn-sm btn-primary">Save</button></td>
          <td><button class="clearBtn btn btn-sm btn-outline-secondary">Clear</button></td>
        `;
        rows.appendChild(tr);
      }

      show("Ready ✅");
    }

    rows.addEventListener("click", async (e) => {
      const saveBtn = e.target.closest(".saveBtn");
      const clearBtn = e.target.closest(".clearBtn");
      if (!saveBtn && !clearBtn) return;

      const customerId = customerSelect.value;
      const tr = e.target.closest("tr");
      const productId = tr.dataset.pid;

        if (clearBtn) {
        const before = {
          retail_price: tr.dataset.beforeRetail ?? "",
          wholesale_price: tr.dataset.beforeWholesale ?? "",
        };

        show("Clearing…");
        const { error } = await supabase
          .from("platinum_prices")
          .delete()
          .eq("customer_id", customerId)
          .eq("product_id", productId);

        if (error) { show("ERROR: " + error.message); return; }

        tr.querySelector(".ret").value = "";
        tr.querySelector(".wh").value = "";

        // update stored "before" to reflect new state
        tr.dataset.beforeRetail = "";
        tr.dataset.beforeWholesale = "";

         await writeAuditLog("platinum_price_override_cleared", {
          customer_id: customerId,
          product_id: productId,
          product_name: tr.dataset.productName || null,
          before,
          after: { retail_price: "", wholesale_price: "" },
        });


        show("Cleared ✅");
        return;
      }


           const retailRaw = tr.querySelector(".ret").value;
      const wholesaleRaw = tr.querySelector(".wh").value;

      const retail = (retailRaw === "" ? null : Number(retailRaw));
      const wholesale = (wholesaleRaw === "" ? null : Number(wholesaleRaw));


            // If both fields are blank, treat Save as Clear (delete override)
      if (retail === null && wholesale === null) {
        const before = {
          retail_price: tr.dataset.beforeRetail ?? "",
          wholesale_price: tr.dataset.beforeWholesale ?? "",
        };

        show("Clearing…");
        const { error } = await supabase
          .from("platinum_prices")
          .delete()
          .eq("customer_id", customerId)
          .eq("product_id", productId);

        if (error) { show("ERROR: " + error.message); return; }

        tr.querySelector(".ret").value = "";
        tr.querySelector(".wh").value = "";

        tr.dataset.beforeRetail = "";
        tr.dataset.beforeWholesale = "";

        await writeAuditLog("platinum_price_override_cleared", {
          customer_id: customerId,
          product_id: productId,
          product_name: tr.dataset.productName || null,
          before,
          after: { retail_price: "", wholesale_price: "" },
        });

        show("Cleared ✅");
        return;
      }

      show("Saving…");
      const { error } = await supabase
        .from("platinum_prices")
        .upsert(
          {
            customer_id: customerId,
            product_id: productId,
            retail_price: retail,
            wholesale_price: wholesale,
          },
          { onConflict: "customer_id,product_id" }
        );

      if (error) { show("ERROR: " + error.message); return; }


      const before = {
        retail_price: tr.dataset.beforeRetail ?? "",
        wholesale_price: tr.dataset.beforeWholesale ?? "",
      };

            const after = {
        retail_price: (retail === null ? "" : String(retail)),
        wholesale_price: (wholesale === null ? "" : String(wholesale)),
      };


      // update stored "before" to reflect new saved state
         tr.dataset.beforeRetail = after.retail_price;
      tr.dataset.beforeWholesale = after.wholesale_price;


        await writeAuditLog("platinum_price_override_saved", {
        customer_id: customerId,
        product_id: productId,
        product_name: tr.dataset.productName || null,
        before,
        after,
      });


      show("Saved ✅");
        });

    loadBtn.addEventListener("click", async () => {
      await loadProductsAndPrices(customerSelect.value);
    });

    (async () => {
      await mustBeAdmin();
      await loadPlatinumCustomers();
      show("Select a platinum customer");
    })().catch(err => show("ERROR: " + (err?.message || err)));

</script>
</body>
</html>
